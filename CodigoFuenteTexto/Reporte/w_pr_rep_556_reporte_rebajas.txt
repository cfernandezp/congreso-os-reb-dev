forward
global type w_pr_rep_556_reporte_rebajas from w_windowbase
end type
type uo_filtro1 from uo_filtro within w_pr_rep_556_reporte_rebajas
end type
type pb_empleado from u_pb within w_pr_rep_556_reporte_rebajas
end type
type uo_toolbar from uo_toolbar_reporte within w_pr_rep_556_reporte_rebajas
end type
type cb_buscar from u_cb within w_pr_rep_556_reporte_rebajas
end type
type cbx_cesado from checkbox within w_pr_rep_556_reporte_rebajas
end type
type uo_filtro1_2 from uo_filtro_empleado_ccosto within w_pr_rep_556_reporte_rebajas
end type
type cb_empleado from u_cb within w_pr_rep_556_reporte_rebajas
end type
type dw_position from datawindow within w_pr_rep_556_reporte_rebajas
end type
type dw_reporte from u_dw within w_pr_rep_556_reporte_rebajas
end type
end forward

global type w_pr_rep_556_reporte_rebajas from w_windowbase
integer x = 9
integer y = 388
integer width = 3168
integer height = 1716
string title = "556 - Reporte de Rebajas"
boolean controlmenu = true
boolean minbox = true
boolean maxbox = true
boolean resizable = true
windowtype windowtype = child!
uo_filtro1 uo_filtro1
pb_empleado pb_empleado
uo_toolbar uo_toolbar
cb_buscar cb_buscar
cbx_cesado cbx_cesado
uo_filtro1_2 uo_filtro1_2
cb_empleado cb_empleado
dw_position dw_position
dw_reporte dw_reporte
end type
global w_pr_rep_556_reporte_rebajas w_pr_rep_556_reporte_rebajas

type variables
String iv_sql_original, is$_selectcostcenter

Datawindowchild dwc_acta



end variables

forward prototypes
public subroutine wf_iniciar ()
public subroutine wf_prepare_sql ()
end prototypes

public subroutine wf_iniciar ();dw_reporte.settransobject(sqlca)
//dw_position.settransobject(sqlca)

//dw_position.getchild( 'acta', dwc_acta)
//dwc_acta.settransobject(sqlca)

//dw_position.insertrow(0)

iv_sql_original = dw_reporte.describe('datawindow.table.select')

dw_print = dw_reporte

uo_toolbar.uf_config(This)
uo_toolbar.uf_setdw( dw_reporte)

io_resize.uf_register(uo_toolbar, 5)
io_resize.uf_register(dw_position, 5)
io_resize.uf_register(dw_reporte, 7)


dw_reporte.object.datawindow.print.preview=True


// 
uo_filtro1.uf_Visible ( "AllAFE", FALSE )
uo_filtro1.uf_Visible ( "AFE", FALSE )
uo_filtro1.uf_Visible ( "AllCentroCosto", FALSE )
uo_filtro1.uf_Visible ( "CentroCosto", FALSE )
uo_filtro1.uf_Visible ( "CentroCosto", FALSE )
uo_filtro1.uf_Protect ( "AllPeriodo", FALSE )


uo_filtro1.uf_Visible ( "AllTipoProceso", FALSE )
uo_filtro1.uf_Visible ( "tipoproceso", FALSE )


//uo_filtro1.dw_filtro.SetItem ( 1, "Compania", str_global.gv_companyowner )
uo_filtro1.dw_filtro.SetItem ( 1, "AllCompania", "N" )

//uo_filtro1.cb_filtrar.Y = 90


uo_filtro1.uf_Protect ("AllTipoProceso", TRUE)
uo_filtro1.uf_Protect ("AllCompania", TRUE)
uo_filtro1.uf_Protect ("AllTipoPlanilla", TRUE)
uo_filtro1.uf_Protect ("AllPeriodo", TRUE)

end subroutine

public subroutine wf_prepare_sql ();String ls_periodo
String ls_tipoplanillas,ls_tipoplanilla
String ls_planillas_array[]
Long ll_count, ll_i, ll_pos
String ls_item
String ls_temp
DataWindowChild ldwc_detalle, ldwc_resumen

// Configurar modo de preview
dw_reporte.modify('datawindow.print.preview = yes')

// Aceptar cambios del filtro
uo_filtro1.dw_filtro.AcceptText()

// Obtener el periodo
ls_periodo = uo_filtro1.uf_Get_Periodo()

// Obtener las planillas seleccionadas (formato: 'A','B','C')
ls_tipoplanilla= uo_filtro1.dw_filtro. getitemstring(1, 'tipoplanilla')
//ls_tipoplanillas = uo_filtro1.uf_get_tipoplanillas()

// Convertir el string de planillas a array
If Len(Trim(ls_tipoplanilla)) > 0 Then
	ls_planillas_array[1] = ls_tipoplanilla

	// Obtener los DataWindows hijos del composite
	dw_reporte.GetChild("dw_detalle", ldwc_detalle)
	dw_reporte.GetChild("dw_resumen", ldwc_resumen)

	// Configurar la transacción para ambos hijos
	ldwc_detalle.SetTransObject(SQLCA)
	ldwc_resumen.SetTransObject(SQLCA)

	// Hacer el retrieve de ambos DataWindows con los parámetros
	ldwc_detalle.Retrieve(ls_planillas_array, ls_periodo)
	ldwc_resumen.Retrieve(ls_planillas_array, ls_periodo)
Else
	MessageBox("Advertencia", "Debe seleccionar al menos una planilla")
End If
end subroutine

on w_pr_rep_556_reporte_rebajas.create
int iCurrent
call super::create
this.uo_filtro1=create uo_filtro1
this.pb_empleado=create pb_empleado
this.uo_toolbar=create uo_toolbar
this.cb_buscar=create cb_buscar
this.cbx_cesado=create cbx_cesado
this.uo_filtro1_2=create uo_filtro1_2
this.cb_empleado=create cb_empleado
this.dw_position=create dw_position
this.dw_reporte=create dw_reporte
iCurrent=UpperBound(this.Control)
this.Control[iCurrent+1]=this.uo_filtro1
this.Control[iCurrent+2]=this.pb_empleado
this.Control[iCurrent+3]=this.uo_toolbar
this.Control[iCurrent+4]=this.cb_buscar
this.Control[iCurrent+5]=this.cbx_cesado
this.Control[iCurrent+6]=this.uo_filtro1_2
this.Control[iCurrent+7]=this.cb_empleado
this.Control[iCurrent+8]=this.dw_position
this.Control[iCurrent+9]=this.dw_reporte
end on

on w_pr_rep_556_reporte_rebajas.destroy
call super::destroy
destroy(this.uo_filtro1)
destroy(this.pb_empleado)
destroy(this.uo_toolbar)
destroy(this.cb_buscar)
destroy(this.cbx_cesado)
destroy(this.uo_filtro1_2)
destroy(this.cb_empleado)
destroy(this.dw_position)
destroy(this.dw_reporte)
end on

event objectstartevent;call super::objectstartevent;
CHOOSE CASE eventname
	CASE "opened"
		wf_iniciar()
	
	CASE 'cb_filtrar_clicked'
		wf_prepare_sql()	
	
	CASE "cb_buscar_clicked"
		wf_prepare_sql()
	
	CASE "cb_empleado_clicked","pb_empleado_clicked"
		str_pass str_parm
	
		str_parm.po[1] = this
		str_parm.s[1] = 'E'
		
		if not isvalid(w_ma_persona_select) then
			openwithparm(w_ma_persona_select, str_parm)
		else
			w_ma_persona_select.show()
		end if
	
	CASE "persona_selected"
	
		dw_position.setitem(1,"empleado",str_global.gv_number_selected)
		
		if isvalid(w_ma_persona_select) then 
			w_ma_persona_select.hide()
		end if
		
	CASE "closed"
		
		if isvalid(w_ma_persona_select) then 
			close(w_ma_persona_select )
		end if
	
END CHOOSE
end event

type uo_filtro1 from uo_filtro within w_pr_rep_556_reporte_rebajas
integer y = 136
integer height = 176
integer taborder = 20
boolean border = false
end type

on uo_filtro1.destroy
call uo_filtro::destroy
end on

type pb_empleado from u_pb within w_pr_rep_556_reporte_rebajas
boolean visible = false
integer x = 1449
integer y = 348
integer width = 91
integer height = 72
integer taborder = 50
boolean enabled = false
string text = ""
string picturename = "Buscar.png"
string disabledname = "Buscar_disabled.png"
string powertiptext = "Seleccionar Empleado"
end type

type uo_toolbar from uo_toolbar_reporte within w_pr_rep_556_reporte_rebajas
integer x = 18
integer y = 20
integer width = 3072
integer taborder = 40
boolean border = false
end type

on uo_toolbar.destroy
call uo_toolbar_reporte::destroy
end on

type cb_buscar from u_cb within w_pr_rep_556_reporte_rebajas
boolean visible = false
integer x = 1545
integer y = 344
integer width = 320
integer height = 92
boolean bringtotop = true
integer weight = 400
string facename = "Arial"
string text = "Consultar"
end type

type cbx_cesado from checkbox within w_pr_rep_556_reporte_rebajas
boolean visible = false
integer x = 1376
integer y = 112
integer width = 434
integer height = 84
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 12632256
string text = "Incluir Cesados"
end type

type uo_filtro1_2 from uo_filtro_empleado_ccosto within w_pr_rep_556_reporte_rebajas
boolean visible = false
integer x = 9
integer y = 268
integer width = 1289
integer height = 128
integer taborder = 40
boolean border = false
end type

on uo_filtro1_2.destroy
call uo_filtro_empleado_ccosto::destroy
end on

type cb_empleado from u_cb within w_pr_rep_556_reporte_rebajas
boolean visible = false
integer x = 1586
integer y = 352
integer width = 82
integer height = 68
integer taborder = 40
boolean bringtotop = true
integer weight = 400
fontcharset fontcharset = ansi!
boolean enabled = false
string text = "..."
end type

type dw_position from datawindow within w_pr_rep_556_reporte_rebajas
boolean visible = false
integer x = 18
integer y = 340
integer width = 3072
integer height = 112
integer taborder = 40
string dataobject = "dw_pr_rep_311_acta_cta_cts_position"
boolean livescroll = true
borderstyle borderstyle = styleraised!
end type

event itemchanged;long ll_null

setnull(ll_null)

Choose Case dwo.name
	Case "allempleado"
		if data = "S" then
			SetItem (1, "empleado", ll_null)
			cb_empleado.enabled = False
			pb_empleado.enabled = False
		else
			cb_empleado.enabled = True
			pb_empleado.enabled = True
			pb_empleado.event clicked( )
		end if
	
	Case "allmemo"
		if data = "S" then
			SetItem (1, "memo", ll_null)
			SetItem (1, "allacta", 'S')
			SetItem (1, "acta", ll_null)
		end if

	Case "allacta"
		if data = "S" then
			SetItem (1, "acta", ll_null)
			dwc_acta.reset()
		end if
		
	Case "memo"
		SetItem (1, "acta", ll_null)
		if not isnull(data) then dwc_acta.retrieve(long(data))

End Choose
end event

type dw_reporte from u_dw within w_pr_rep_556_reporte_rebajas
integer x = 18
integer y = 340
integer width = 3072
integer height = 1224
integer taborder = 30
string dataobject = "dw_pr_rep_556_rebaja_devolucion_composit"
boolean hscrollbar = true
boolean vscrollbar = true
borderstyle borderstyle = stylelowered!
end type

