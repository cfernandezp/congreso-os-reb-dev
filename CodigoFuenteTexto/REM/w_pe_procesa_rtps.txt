forward
global type w_pe_procesa_rtps from w_windowbase
end type
type dw_source_30 from datawindow within w_pe_procesa_rtps
end type
type dw_source_27 from datawindow within w_pe_procesa_rtps
end type
type dw_source_26 from datawindow within w_pe_procesa_rtps
end type
type cb_idesunat from commandbutton within w_pe_procesa_rtps
end type
type dw_source_17_02 from datawindow within w_pe_procesa_rtps
end type
type dw_rtps_uap from datawindow within w_pe_procesa_rtps
end type
type dw_source_20 from datawindow within w_pe_procesa_rtps
end type
type dw_source_19 from datawindow within w_pe_procesa_rtps
end type
type dw_source_02_sdd from datawindow within w_pe_procesa_rtps
end type
type dw_source_02_edd from datawindow within w_pe_procesa_rtps
end type
type dw_source_13 from datawindow within w_pe_procesa_rtps
end type
type dw_source_15 from datawindow within w_pe_procesa_rtps
end type
type dw_source_16 from datawindow within w_pe_procesa_rtps
end type
type dw_source_17 from datawindow within w_pe_procesa_rtps
end type
type dw_source_21 from datawindow within w_pe_procesa_rtps
end type
type dw_source_14 from datawindow within w_pe_procesa_rtps
end type
type dw_source_18 from datawindow within w_pe_procesa_rtps
end type
type dw_diskette from u_dw within w_pe_procesa_rtps
end type
type dw_reporte from u_dw within w_pe_procesa_rtps
end type
type cb_cerrar from u_cb within w_pe_procesa_rtps
end type
type dw_source_04 from datawindow within w_pe_procesa_rtps
end type
type dw_source_ddhh from datawindow within w_pe_procesa_rtps
end type
type cb_procesar from u_cb within w_pe_procesa_rtps
end type
type sle_tcambiopago from singlelineedit within w_pe_procesa_rtps
end type
type sle_tcambioant from singlelineedit within w_pe_procesa_rtps
end type
type st_tcambioant from statictext within w_pe_procesa_rtps
end type
type st_tcambiopago from statictext within w_pe_procesa_rtps
end type
type cb_tcambio from u_cb within w_pe_procesa_rtps
end type
type dw_tipoproceso from datawindow within w_pe_procesa_rtps
end type
type cbx_patronales from checkbox within w_pe_procesa_rtps
end type
type cbx_deducciones from checkbox within w_pe_procesa_rtps
end type
type st_1 from statictext within w_pe_procesa_rtps
end type
type uo_progress from u_progress_bar within w_pe_procesa_rtps
end type
type gb_2 from groupbox within w_pe_procesa_rtps
end type
type rb_soles from radiobutton within w_pe_procesa_rtps
end type
type rb_dolares from radiobutton within w_pe_procesa_rtps
end type
type cbx_afectoaies from checkbox within w_pe_procesa_rtps
end type
type dw_source_01 from datawindow within w_pe_procesa_rtps
end type
type dw_source_02 from datawindow within w_pe_procesa_rtps
end type
type dw_source_05 from datawindow within w_pe_procesa_rtps
end type
type dw_source_06 from datawindow within w_pe_procesa_rtps
end type
type dw_source_07 from datawindow within w_pe_procesa_rtps
end type
type dw_source_08 from datawindow within w_pe_procesa_rtps
end type
type dw_source_09 from datawindow within w_pe_procesa_rtps
end type
type dw_source_10 from datawindow within w_pe_procesa_rtps
end type
type dw_source_11 from datawindow within w_pe_procesa_rtps
end type
type dw_source_12 from datawindow within w_pe_procesa_rtps
end type
type dw_source from datawindow within w_pe_procesa_rtps
end type
type dw_source04_dir from datawindow within w_pe_procesa_rtps
end type
type cbx_todos from checkbox within w_pe_procesa_rtps
end type
type dw_planproc_p from u_dw within w_pe_procesa_rtps
end type
type dw_planproc_t from u_dw within w_pe_procesa_rtps
end type
type tab_1 from tab within w_pe_procesa_rtps
end type
type tabpage_1 from userobject within tab_1
end type
type dw_ft from datawindow within tabpage_1
end type
type tabpage_1 from userobject within tab_1
dw_ft dw_ft
end type
type tabpage_2 from userobject within tab_1
end type
type dw_fp from datawindow within tabpage_2
end type
type tabpage_2 from userobject within tab_1
dw_fp dw_fp
end type
type tabpage_3 from userobject within tab_1
end type
type dw_f4t from datawindow within tabpage_3
end type
type tabpage_3 from userobject within tab_1
dw_f4t dw_f4t
end type
type tab_1 from tab within w_pe_procesa_rtps
tabpage_1 tabpage_1
tabpage_2 tabpage_2
tabpage_3 tabpage_3
end type
type dw_filtro from u_dw within w_pe_procesa_rtps
end type
type dw_planproc_p_ap from u_dw within w_pe_procesa_rtps
end type
type dw_planproc_4ta_ap from u_dw within w_pe_procesa_rtps
end type
type dw_planproc_4t from u_dw within w_pe_procesa_rtps
end type
type dw_planproc_t_ap from u_dw within w_pe_procesa_rtps
end type
type dw_idesunat from datawindow within w_pe_procesa_rtps
end type
type st_2 from statictext within w_pe_procesa_rtps
end type
type dw_source_29 from datawindow within w_pe_procesa_rtps
end type
end forward

global type w_pe_procesa_rtps from w_windowbase
integer x = 160
integer y = 172
integer width = 4288
integer height = 2688
string title = "Procesa Archivos de Planilla Electrónica"
boolean controlmenu = true
windowtype windowtype = response!
dw_source_30 dw_source_30
dw_source_27 dw_source_27
dw_source_26 dw_source_26
cb_idesunat cb_idesunat
dw_source_17_02 dw_source_17_02
dw_rtps_uap dw_rtps_uap
dw_source_20 dw_source_20
dw_source_19 dw_source_19
dw_source_02_sdd dw_source_02_sdd
dw_source_02_edd dw_source_02_edd
dw_source_13 dw_source_13
dw_source_15 dw_source_15
dw_source_16 dw_source_16
dw_source_17 dw_source_17
dw_source_21 dw_source_21
dw_source_14 dw_source_14
dw_source_18 dw_source_18
dw_diskette dw_diskette
dw_reporte dw_reporte
cb_cerrar cb_cerrar
dw_source_04 dw_source_04
dw_source_ddhh dw_source_ddhh
cb_procesar cb_procesar
sle_tcambiopago sle_tcambiopago
sle_tcambioant sle_tcambioant
st_tcambioant st_tcambioant
st_tcambiopago st_tcambiopago
cb_tcambio cb_tcambio
dw_tipoproceso dw_tipoproceso
cbx_patronales cbx_patronales
cbx_deducciones cbx_deducciones
st_1 st_1
uo_progress uo_progress
gb_2 gb_2
rb_soles rb_soles
rb_dolares rb_dolares
cbx_afectoaies cbx_afectoaies
dw_source_01 dw_source_01
dw_source_02 dw_source_02
dw_source_05 dw_source_05
dw_source_06 dw_source_06
dw_source_07 dw_source_07
dw_source_08 dw_source_08
dw_source_09 dw_source_09
dw_source_10 dw_source_10
dw_source_11 dw_source_11
dw_source_12 dw_source_12
dw_source dw_source
dw_source04_dir dw_source04_dir
cbx_todos cbx_todos
dw_planproc_p dw_planproc_p
dw_planproc_t dw_planproc_t
tab_1 tab_1
dw_filtro dw_filtro
dw_planproc_p_ap dw_planproc_p_ap
dw_planproc_4ta_ap dw_planproc_4ta_ap
dw_planproc_4t dw_planproc_4t
dw_planproc_t_ap dw_planproc_t_ap
dw_idesunat dw_idesunat
st_2 st_2
dw_source_29 dw_source_29
end type
global w_pe_procesa_rtps w_pe_procesa_rtps

type variables
string iv$_CompaniaSocio, iv$_Periodo, &
	iv$_TipoPlanilla[], iv$_TipoProceso[], &
	iv$_allCompaniaSocio , iv$_allTipoPlanilla , &
	iv$_allTipoProceso

string iv$_linea
string iv$_sql
string iv$_documentofiscal

int iv%_pidioarchivo

//Variables tmp

String		is_PeriCont, is_PerConAnt, is_TipoEmpleado//, is_flagincluir
String 	is_TipoPlanilla, is_TipoProceso

String		is_PeriAntePost, is_IndiPeriodo
String		is_ft_PlaniProc, is_ft_PlaniProcAP, is_fp_PlaniProc, is_fp_PlaniProcAP,is_f4t_PlaniProc, is_f4t_PlaniProcAP
String		is_ft_FlagIncluir,is_fp_FlagIncluir, is_f4t_FlagIncluir
DataWindow isdw_ft, isdw_fp, isdw_f4t


end variables

forward prototypes
public function string wf_limpiar (string par_cadena)
public function string wf_tipodocumento (string par_tipodocumento)
public subroutine wf_generaciondependientes ()
public function string wf_tipodependiente (string par_tipodependiente)
public function string wf_tipodocatencionmedica (string par_tipodocumento)
public function string wf_motivobajadepe (string par_motivobaja)
public subroutine wf_generaciondjt ()
public function string wf_sinpunto (double par_numero)
public function string wf_tipovia (string par_tipovia)
public function string wf_tipozona (string par_tipozona)
public subroutine wf_generacionsctr ()
public function integer wf_generacion_file (string par_tipo, string par_descripcion, string par_nombrefile)
public function integer wf_procesa_file (string par_tipo, string par_descripcion, string par_nombrefile)
public function integer wf_procesa_ar1 ()
public function integer wf_procesa_ar2 ()
public function integer wf_procesa_ar10 ()
public function integer wf_procesa_ar9 ()
public function integer wf_procesa_ar3 ()
public function integer wf_procesa_ar4 ()
public function integer wf_procesa_ar5 ()
public function integer wf_procesa_ar6 ()
public function integer wf_procesa_ar7 ()
public function integer wf_procesa_ar8 ()
public function integer wf_procesa_ar11 ()
public function integer wf_procesa_ar12 ()
public function string wf_categoriatrabajador (string par_tipotrabajador)
public function string wf_tipotrabajador (string par_tipotrabajador)
public function string wf_regimenlaboral (string par_empresa)
public function string wf_periodicidad (string par_planilla)
public function string wf_tipocontrato (string par_contrato)
public function string wf_estadocivil (string par_estado)
public function string wf_eps (string par_eps)
public function string wf_banco (string par_banco)
public function string wf_regimenpensionario (string par_pension, string par_afp)
public function string wf_nacionalidad (string par_pais)
public function string wf_tipopago (string par_tipo)
public function string wf_situacioneps (string par_asistencia, string par_estado)
public function integer wf_procesa_a14 ()
public function integer wf_procesa_ar14 ()
public function string wf_motivocese (integer par_motivo)
public function string wf_ocupacion (integer par_cargo)
public subroutine wf_proceso_ar21 ()
public function integer wf_procesa_ar21 ()
public function integer wf_procesa_ar17 ()
public function integer wf_procesa_ar16 ()
public function integer wf_procesa_ar15 ()
public function integer wf_procesa_ar2_edd ()
public function integer wf_procesa_ar2_sdd ()
public function integer wf_procesa_ar19 ()
public function string wf_essaludperiodo (long ai_empleado, string as_periodo)
public function integer wf_procesa_ar20 ()
public function datetime wf_fechaliquidacion (integer ai_empleado)
public function datetime wf_fechaingresoperiodo (long ai_empleado, string as_periodo, datetime as_fechacese, string as_estado)
public function integer wf_procesa_ar18 ()
public function boolean wf_indiultimomov (string ags_periodo, long agl_codiempleado, date agd_fecingreso)
public function double wf_verificaaniosesvida (long agl_empleado, string ags_empleado, datetime agdt_fechanacimiento, datetime agdt_fechafinperiodo)
public function string wf_regimen_pensionario (string ags_codipension, string ags_codiafp, datetime agdt_feciniregpens, long agl_empleado, string ags_periodo)
public subroutine wf_depurapensionista (string ags_periodo, string ags_dato)
public function string wf_estadoempleado (long agl_empleado, string ags_estadoempleado, string ags_periodo, datetime agdt_fechacese, datetime agdt_fechaliqui, datetime agdt_iniperiodo, datetime agdt_finperiodo)
public function datetime wf_fechacese (long agl_empleado, datetime agdt_fechaceseactual, datetime agdt_fechainiperi, datetime agdt_fechafinperi)
public function integer wf_cargafiltros ()
public function string wf_paisemisor (readonly string as_pais)
public function integer wf_procesa_ar13 (string as_estado)
public subroutine closewindow ()
public function string fw_sindicalizado (string as_periodo, long al_codigoempleado)
public function string fw_situacionempleado (string as_estadoempleado)
public function string fw_categoriaocupacional (string as_codigocargo)
public function string fw_regimenpensionarioalta (long al_empleado, string as_tiporegpen, string as_codiafp)
public function integer fw_verifica_existe_sunat (string as_numedocumento, string as_indiniactual)
public function double fw_rembasicainicial (string as_gradosalario, string as_tipoplanilla, long al_codiopersona)
public function integer wf_procesa_ar26 ()
public function string fw_bajaempleado (long agl_empleado, string ags_numedocu, string ags_periodo, datetime agdt_fechacese, datetime agdt_iniperiodo, datetime agdt_finperiodo)
public function integer wf_procesa_ar27 ()
public function integer fw_verificaestadopensionista (long al_codiempleado)
public subroutine fw_actualizadatos ()
public function integer wf_procesa_ar29 ()
public function string fw_estado_pago_pendiente (string ags_documento, datetime agdt_iniperiodo, datetime agdt_finperiodo, string ags_caso)
public function integer wf_procesa_ar30 ()
public function integer wf_procesa_ar31 ()
public function integer wf_procesa_ar5_sindicalizado ()
end prototypes

public function string wf_limpiar (string par_cadena);integer w%_pos
string w$_cadena_final, w$_caracter

par_cadena = TRIM(LOWER(par_cadena))
For w%_pos = 1 to Len( par_cadena )
	w$_caracter = Mid( par_cadena, w%_pos, 1 )
	if not isNumber (w$_caracter) then
	
		Choose Case w$_caracter
			Case "ñ",'Ñ'
			//	w$_caracter = "n"
			Case "á",'Á'
				w$_caracter = "a"			
			Case "é",'É'
				w$_caracter = "e"			
			Case "í",'Í'
				w$_caracter = "i"			
			Case "ó",'Ó'
				w$_caracter = "o"			
			Case "ú",'Ú','Ü','ü'
				w$_caracter = "u"
			End Choose
			
			if not ASC(UPPER(w$_caracter)) > 64 and ASC(UPPER(w$_caracter)) < 91 then  // No es Alpha
			//	w$_caracter = " "
			end if
		
	end if
	w$_cadena_final += UPPER(w$_caracter)		
			
Next

Return w$_cadena_final
end function

public function string wf_tipodocumento (string par_tipodocumento);string w$_retorno

SELECT MA_MiscelaneosDetalle.ValorCodigo1  
INTO :w$_retorno  
FROM MA_MiscelaneosDetalle  
WHERE ( MA_MiscelaneosDetalle.AplicacionCodigo = 'HR' ) AND  
( MA_MiscelaneosDetalle.CodigoTabla = 'TIPODOCI' ) AND  
( MA_MiscelaneosDetalle.Compania = '999999' ) AND  
( MA_MiscelaneosDetalle.CodigoElemento = :par_tipodocumento )          ;

return w$_retorno


end function

public subroutine wf_generaciondependientes ();//double w#_file1
//long w%_rowcount
//string w$_apellido_paterno, w$_apellido_materno , w$_nombres 
//long w%_result1, w%_fila
//string w$_archivo1
//string w$_sexo 
//string w$_estado, w$_domiciliopropio
//string w$_fechanacimiento 
//
//w$_archivo1 = iv$_documentofiscal + ".der"
//
//if iv%_pidioarchivo = 0 then
//
//	w%_result1 = GetFileSaveName("Seleccione el archivo",  & 
//		w$_archivo1, w$_archivo1, ".der",  &
//		"Archivo Asegurado ESSALUD (*.der),*.der,")
//
//	if w%_result1 = 0 then return 
//	iv%_pidioarchivo = 1
//
//end if 
//
//ST_1.TEXT = 'DERECHOHABIENTES'
//
//w#_file1 = FileOpen ( w$_archivo1, LineMode!, Write!, LockWrite!, Replace! )
//
//w%_rowcount = dw_sourcedep.rowcount()
//
//For w%_fila = 1 to w%_rowcount
//
//	iv$_linea = left(f_nonulo_str(wf_tipodocumento(dw_sourcedep.getitemstring(w%_fila ,"tipodocumento"))) + ' ',1) + '|'
//	iv$_linea += left(f_nonulo_str(dw_sourcedep.getitemstring(w%_fila ,"documento")) + fill(' ',15),15) + '|'
//	
//	iv$_linea += left(f_nonulo_str(wf_tipodocumento(dw_sourcedep.getitemstring(w%_fila ,"tipodocumentoidentidad"))) + '  ',2) + '|'
//	iv$_linea += left(f_nonulo_str(dw_sourcedep.getitemstring(w%_fila ,"documentoidentidad")) + fill(' ',15),15) + '|'
//
//	// Apellido Paterno
//	w$_apellido_paterno = f_nonulo_str(dw_sourcedep.GetItemString ( w%_fila, "ApellidoPaterno" ))
//	iv$_linea +=  left(wf_limpiar(w$_apellido_paterno) + fill(' ',20),20) + '|'
//	
//	// Apellido Materno
//	w$_apellido_materno = f_nonulo_str(dw_sourcedep.GetItemString ( w%_fila, "ApellidoMaterno" ))
//	iv$_linea +=  left(wf_limpiar(w$_apellido_materno) + fill(' ',20),20)+ '|'
//	
//	// Nombres
//	w$_nombres = f_nonulo_str(dw_sourcedep.GetItemString ( w%_fila, "Nombres" ))
//	iv$_linea +=  left(wf_limpiar(w$_nombres) + fill(' ',20),20)+ '|'
//	
//	w$_fechanacimiento = string(dw_sourcedep.GetItemDateTime ( w%_fila, "fechanacimiento" ), "dd/mm/yyyy")
//	
//	if isnull(w$_fechanacimiento ) or len(w$_fechanacimiento ) < 0 then
//		iv$_linea += '00/00/0000' + '|'
//	else
//		iv$_linea += w$_fechanacimiento + '|'
//	end if 
//
//	w$_sexo = f_nonulo_str(dw_sourcedep.GetItemString ( w%_fila, "sexo" ))
//	if w$_sexo = 'M' then
//		iv$_linea +=  '1'+ '|'
//	else
//		iv$_linea +=  '2'+ '|'
//	end if 
//	
//	iv$_linea +=  left(f_nonulo_str(wf_tipodependiente(dw_sourcedep.GetItemString ( w%_fila, "TipoDependiente" ))) + ' ',1) + '|'
//	
//	iv$_linea +=  left(f_nonulo_str(wf_tipodocatencionmedica(dw_sourcedep.GetItemString ( w%_fila, "TipoDocumentoAtencionMedica" ))) + ' ',1)+ '|'
//	
//	iv$_linea +=  left(f_nonulo_str(dw_sourcedep.GetItemString ( w%_fila, "DocumentoAtencionMedica" )) + fill(' ', 20),20)+ '|'
//
//	w$_estado = f_nonulo_str(dw_sourcedep.GetItemString ( w%_fila, "Estado" ))
//	if w$_estado = 'A' then
//		iv$_linea += '10' + '|'
//	else
//		iv$_linea += '11' + '|'
//	end if 
//	
//	iv$_linea +=  left(f_nonulo_str(wf_motivobajadepe(dw_sourcedep.GetItemString ( w%_fila, "MotivoBaja" )))+ ' ',1) + '|'
//	
//	iv$_linea +=  left(f_nonulo_str(dw_sourcedep.GetItemString ( w%_fila, "DocumentoIncapacidad" )) + fill(' ',20),20) + '|'
//	
//	w$_domiciliopropio = f_nonulo_str(dw_sourcedep.GetItemString ( w%_fila, "DocumentoIncapacidad" ))
//	if w$_domiciliopropio = 'S' then
//		iv$_linea +=  '1' + '|'
//	else
//		iv$_linea +=  '0' + '|'
//	end if 
//	
//	iv$_linea += left(f_nonulo_str(dw_sourcedep.GetItemString ( w%_fila, "Direccion"	)) + fill(' ',20) ,20 )+ '|'
//	iv$_linea += left(f_nonulo_str(dw_sourcedep.GetItemString ( w%_fila, "Numero"		)) + fill(' ',4) ,4 )+ '|'
//	iv$_linea += left(f_nonulo_str(dw_sourcedep.GetItemString ( w%_fila, "Interior"	)) + fill(' ',4) ,4 )+ '|'
//	iv$_linea += left(f_nonulo_str(dw_sourcedep.GetItemString ( w%_fila, "pdtzona"		)) + fill(' ',20) ,20 )+ '|'
//	iv$_linea += left(f_nonulo_str(dw_sourcedep.GetItemString ( w%_fila, "referenciasdireccion")) + fill(' ',40) ,40 )+ '|'
//	iv$_linea += left(wf_tipovia(f_nonulo_str(dw_sourcedep.GetItemString ( w%_fila, "pdttipocalle"	))) + fill(' ',2) ,2 )+ '|'
//	iv$_linea += left(wf_tipozona(f_nonulo_str(dw_sourcedep.GetItemString ( w%_fila, "pdttipozona"	))) + fill(' ',2) ,2 )+ '|'
//	iv$_linea += left(f_nonulo_str(dw_sourcedep.GetItemString ( w%_fila, "ubigeo"		)) + fill(' ',6) ,6 )+ '|'
//	FileWrite ( w#_file1, iv$_linea )
//	uo_progress.uf_Set_Position( w%_fila / w%_rowcount * 100 )
//Next
//
//FileClose ( w#_file1 )
//
end subroutine

public function string wf_tipodependiente (string par_tipodependiente);string w$_retorno

SELECT MA_MiscelaneosDetalle.ValorCodigo1  
INTO :w$_retorno  
FROM MA_MiscelaneosDetalle  
WHERE ( MA_MiscelaneosDetalle.AplicacionCodigo = 'HR' ) AND  
( MA_MiscelaneosDetalle.CodigoTabla = 'TIPOVINC' ) AND  
( MA_MiscelaneosDetalle.Compania = '999999' ) AND  
( MA_MiscelaneosDetalle.CodigoElemento = :par_tipodependiente )          ;

return w$_retorno


end function

public function string wf_tipodocatencionmedica (string par_tipodocumento);string w$_retorno

SELECT MA_MiscelaneosDetalle.ValorCodigo1  
INTO :w$_retorno  
FROM MA_MiscelaneosDetalle  
WHERE ( MA_MiscelaneosDetalle.AplicacionCodigo = 'HR' ) AND  
( MA_MiscelaneosDetalle.CodigoTabla = 'TIPODOAM' ) AND  
( MA_MiscelaneosDetalle.Compania = '999999' ) AND  
( MA_MiscelaneosDetalle.CodigoElemento = :par_tipodocumento )          ;

return w$_retorno


end function

public function string wf_motivobajadepe (string par_motivobaja);string w$_retorno

SELECT MA_MiscelaneosDetalle.ValorCodigo1  
INTO :w$_retorno  
FROM MA_MiscelaneosDetalle  
WHERE ( MA_MiscelaneosDetalle.AplicacionCodigo = 'HR' ) AND  
( MA_MiscelaneosDetalle.CodigoTabla = 'DEPEMOBA' ) AND  
( MA_MiscelaneosDetalle.Compania = '999999' ) AND  
( MA_MiscelaneosDetalle.CodigoElemento = :par_motivobaja )          ;

return w$_retorno


end function

public subroutine wf_generaciondjt ();//double w#_file1
//long w%_rowcount , w%_fila
//long w%_result1 
//string w$_archivo1
//double w#_tipocambioant, w#_tipocambionuevo, w#_quinta
//string w$_monedapago
//
//w#_tipocambioant = Double (sle_tcambioant.Text)
//w#_tipocambionuevo = Double (sle_tcambiopago.Text)
//
//w$_archivo1 = "0600" + f_nonulo_str(left(iv$_periodo,6) + iv$_documentofiscal + ".djt")
//
//if iv%_pidioarchivo = 0 then
//
//	w%_result1 = GetFileSaveName("Seleccione el archivo",  & 
//		w$_archivo1, w$_archivo1, ".djt",  &
//		"Archivo Asegurado ESSALUD (*.djt),*.djt,")
//
//	if w%_result1 = 0 then return 
//	
//	iv%_pidioarchivo = 1
//
//end if 
//
//ST_1.TEXT = 'DJT'
//
//w#_file1 = FileOpen ( w$_archivo1, LineMode!, Write!, LockWrite!, Replace! )
//
//w%_rowcount = dw_sourcedjt.rowcount()
//
//For w%_fila = 1 to w%_rowcount
//
//	w$_monedapago = dw_sourcedjt.GetItemString (w%_fila, "monedapago")
//	
//	iv$_linea = f_nonulo_str(wf_tipodocumento(dw_sourcedjt.getitemstring(w%_fila ,"tipodocumento")))  + '|'
//	iv$_linea += f_nonulo_str(dw_sourcedjt.getitemstring(w%_fila ,"documento")) + '|'
//	
//	long w%_diastrabajados
//	w%_diastrabajados = f_nonulo(dw_sourcedjt.GetItemNumber ( w%_fila, "DiasTrabajados" ))
//	if w%_diastrabajados > 30 then
//		w%_diastrabajados = 30
//	end if
//	
//	// Si es febrero
//	if mid (iv$_Periodo,5,2) = "02" then
//		long w%_anio, w%_limite
//		
//		// Si es biciesto
//		w%_anio = long (mid (iv$_periodo,1,4))
//		if mod (w%_anio, 4) = 0 then
//			w%_limite = 29
//		else
//			w%_limite = 28
//		end if
//		if w%_diastrabajados > w%_limite then
//			w%_diastrabajados = w%_limite
//		end if
//	end if
//	
//	if rb_dolares.Checked = TRUE then
//	
//		if w$_monedapago = "LO" then
//			iv$_linea +=  string(w%_diastrabajados, "00" ) + '|'
//			if cbx_afectoaies.Checked = TRUE then
//				if cbx_patronales.checked then
//					iv$_linea +=  string(f_nonulo(round(dw_sourcedjt.GetItemNumber ( w%_fila, "RemIES" ) / w#_tipocambionuevo,2))) + '|'
//				else
//					iv$_linea +=  string(f_nonulo(round(dw_sourcedjt.GetItemNumber ( w%_fila, "RemIES" ) ,2))) + '|'
//				end if
//			else
//				iv$_linea +=  '|'				
//			end if
//				
//			if dw_sourcedjt.GetItemNumber ( w%_fila, "RemPensiones" ) <> 0 then
//				if cbx_deducciones.checked then
//					iv$_linea +=  string(f_nonulo(round(dw_sourcedjt.GetItemNumber ( w%_fila, "RemPensiones" ) / w#_tipocambionuevo,2))) + '|'
//				else
//					iv$_linea +=  string(f_nonulo(round(dw_sourcedjt.GetItemNumber ( w%_fila, "RemPensiones" ) ,2))) + '|'
//				end if
//			else
//				iv$_linea +=   '|'				
//			end if
//			
//			if cbx_patronales.checked then
//				iv$_linea +=  string(f_nonulo(round(dw_sourcedjt.GetItemNumber ( w%_fila, "RemSalud" ) / w#_tipocambionuevo,2))) + '|'
//			else
//				iv$_linea +=  string(f_nonulo(round(dw_sourcedjt.GetItemNumber ( w%_fila, "RemSalud" ) ,2))) + '|'
//			end if
//			iv$_linea +=  '|'
////			if f_nonulo(round(dw_sourcedjt.GetItemNumber ( w%_fila, "Tributo5ta" ),0)) <> 0 then
//				if cbx_deducciones.checked then
//					iv$_linea +=  string(f_nonulo(round(dw_sourcedjt.GetItemNumber ( w%_fila, "Rem5ta" ) / w#_tipocambionuevo,2))) + '|'
//				else
//					iv$_linea +=  string(f_nonulo(round(dw_sourcedjt.GetItemNumber ( w%_fila, "Rem5ta" ) ,2))) + '|'
//				end if
////			else
////				iv$_linea +=  "0" + '|'		
////			end if
//			w#_quinta = dw_sourcedjt.GetItemNumber ( w%_fila, "Tributo5ta" )
//			if w#_quinta < 0 then w#_quinta = 0
//			if cbx_deducciones.checked then
//				iv$_linea +=  string(f_nonulo(round( w#_quinta / w#_tipocambionuevo ,2))) + '|'
//			else
//				iv$_linea +=  string(f_nonulo(round( w#_quinta ,2))) + '|'
//			end if
//		else
//			iv$_linea +=  string(w%_diastrabajados, "00" ) + '|'
//			if cbx_afectoaies.Checked = TRUE then
//				if cbx_patronales.checked then
//					iv$_linea +=  string(f_nonulo(round(dw_sourcedjt.GetItemNumber ( w%_fila, "RemIES" ) / w#_tipocambioant,2))) + '|'
//				else
//					iv$_linea +=  string(f_nonulo(round(dw_sourcedjt.GetItemNumber ( w%_fila, "RemIES" ) ,2))) + '|'
//				end if
//			else
//				iv$_linea +=  '|'				
//			end if
//			if dw_sourcedjt.GetItemNumber ( w%_fila, "RemPensiones" ) <> 0 then
//				if cbx_deducciones.checked then
//					iv$_linea +=  string(f_nonulo(round(dw_sourcedjt.GetItemNumber ( w%_fila, "RemPensiones" ) / w#_tipocambioant,2))) + '|'
//				else
//					iv$_linea +=  string(f_nonulo(round(dw_sourcedjt.GetItemNumber ( w%_fila, "RemPensiones" ) ,2))) + '|'
//				end if
//			else
//				iv$_linea +=   '|'				
//			end if
//			if cbx_patronales.checked then
//				iv$_linea +=  string(f_nonulo(round(dw_sourcedjt.GetItemNumber ( w%_fila, "RemSalud" ) / w#_tipocambioant,2))) + '|'
//			else
//				iv$_linea +=  string(f_nonulo(round(dw_sourcedjt.GetItemNumber ( w%_fila, "RemSalud" ) ,2))) + '|'
//			end if 
//			iv$_linea +=  '|'
////			if f_nonulo(round(dw_sourcedjt.GetItemNumber ( w%_fila, "Tributo5ta" ),0)) <> 0 then
//				if cbx_deducciones.checked then
//					iv$_linea +=  string(f_nonulo(round(dw_sourcedjt.GetItemNumber ( w%_fila, "Rem5ta" ) / w#_tipocambioant,2))) + '|'
//				else
//					iv$_linea +=  string(f_nonulo(round(dw_sourcedjt.GetItemNumber ( w%_fila, "Rem5ta" ) ,2))) + '|'
//				end if
////			else
////				iv$_linea +=  "0" + '|'		
////			end if
//			w#_quinta = dw_sourcedjt.GetItemNumber ( w%_fila, "Tributo5ta" )
//			if w#_quinta < 0 then w#_quinta = 0
//			if cbx_deducciones.checked then
//				iv$_linea +=  string(f_nonulo(round(w#_quinta  / w#_tipocambioant,2))) + '|'		
//			else
//				iv$_linea +=  string(f_nonulo(round(w#_quinta  ,2))) + '|'		
//			end if
//		end if
//		
//	else
//			iv$_linea +=  string(w%_diastrabajados, "00" ) + '|'
//			if cbx_afectoaies.Checked = TRUE then
//				iv$_linea +=  string(f_nonulo(round(dw_sourcedjt.GetItemNumber ( w%_fila, "RemIES" ) ,2))) + '|'
//			else
//				iv$_linea +=  '|'				
//			end if
//			if dw_sourcedjt.GetItemNumber ( w%_fila, "RemPensiones" ) <> 0 then
//				iv$_linea +=  string(f_nonulo(round(dw_sourcedjt.GetItemNumber ( w%_fila, "RemPensiones" ) ,2))) + '|'
//			else
//				iv$_linea +=   '|'				
//			end if
//			iv$_linea +=  string(f_nonulo(round(dw_sourcedjt.GetItemNumber ( w%_fila, "RemSalud" ) ,2))) + '|'
//			iv$_linea +=  '|'
////			if f_nonulo(round(dw_sourcedjt.GetItemNumber ( w%_fila, "Tributo5ta" ),0)) <> 0 then
//				iv$_linea +=  string(f_nonulo(round(dw_sourcedjt.GetItemNumber ( w%_fila, "Rem5ta" ) ,2))) + '|'
//	//		else
//	//			iv$_linea +=  "0" + '|'		
//	//		end if
//			
//			w#_quinta = dw_sourcedjt.GetItemNumber ( w%_fila, "Tributo5ta" )
//			if w#_quinta < 0 then w#_quinta = 0
//			iv$_linea +=  string(f_nonulo(round( w#_quinta ,2))) + '|'		
//	end if
//	
//	FileWrite ( w#_file1, iv$_linea )
//	uo_progress.uf_Set_Position( w%_fila / w%_rowcount * 100 )
//	
//Next
//
//FileClose ( w#_file1 )
//
end subroutine

public function string wf_sinpunto (double par_numero);string w$_numero

w$_numero = string (par_numero , fill('0',13) + '.00') 

return left(w$_numero ,13 ) + right(w$_numero ,2 )




end function

public function string wf_tipovia (string par_tipovia);string w$_retorno

SELECT MA_MiscelaneosDetalle.ValorCodigo1  
INTO :w$_retorno  
FROM MA_MiscelaneosDetalle  
WHERE ( MA_MiscelaneosDetalle.AplicacionCodigo = 'HR' ) AND  
( MA_MiscelaneosDetalle.CodigoTabla = 'TIPOVIAS' ) AND  
( MA_MiscelaneosDetalle.Compania = '999999' ) AND  
( MA_MiscelaneosDetalle.CodigoElemento = :par_tipovia )          ;

return w$_retorno


end function

public function string wf_tipozona (string par_tipozona);string w$_retorno
string w$_tipozona

w$_tipozona = string (long (par_tipozona), "00")

SELECT MA_MiscelaneosDetalle.ValorCodigo1  
INTO :w$_retorno  
FROM MA_MiscelaneosDetalle  
WHERE ( MA_MiscelaneosDetalle.AplicacionCodigo = 'HR' ) AND  
( MA_MiscelaneosDetalle.CodigoTabla = 'TIPOZONA' ) AND  
( MA_MiscelaneosDetalle.Compania = '999999' ) AND  
( MA_MiscelaneosDetalle.CodigoElemento = :w$_tipozona )          ;

return w$_retorno


end function

public subroutine wf_generacionsctr ();//string w$_company
//double w#_file1, w#_file2, w#_impuesto, w#_tasa
//long w%_rowcount
//long w%_result1, w%_result2, w%_fila
//string w$_archivo1, w$_archivo2
//
//w$_company =left (iv$_CompaniaSocio,6)
//
//ST_1.TEXT = 'Seguro Complementario de Riesgo'
//
//w$_archivo1 = "0610" + f_nonulo_str(left(iv$_periodo,6) + iv$_documentofiscal + ".sct")
//
//if iv%_pidioarchivo = 0 then
//
//	w%_result1 = GetFileSaveName("Seleccione el archivo",  & 
//		w$_archivo1, w$_archivo1, ".SCT",  &
//		"Seguro Complementario de Riesgo (*.sct),*.sct,")
//
//	if w%_result1 = 0 then return 
//	
//	iv%_pidioarchivo = 1
//
//end if 
//
//w#_file1 = FileOpen ( w$_archivo1, LineMode!, Write!, LockWrite!, Replace! )
//w%_rowcount = dw_sourcesctr.rowcount()
//// Detalle
//
//SELECT	FactorPorcentaje
//INTO	:w#_impuesto
//FROM	IMPUESTOS
//WHERE	Impuesto = 'IGV';
//
//
//For w%_fila = 1 to w%_rowcount
//	iv$_linea = left(f_nonulo_str(wf_tipodocumento(dw_sourcesctr.getitemstring(w%_fila ,"tipodocumento"))) + ' ',1) + '|'
//	iv$_linea += left(f_nonulo_str(dw_sourcesctr.getitemstring(w%_fila ,"documento")) + fill(' ',15),15) + '|'
//	
//	// RUC
//	iv$_linea +=  left(wf_limpiar(em_SCTRRucCentroRiesgo.Text) + fill(' ',11),11) + '|'
//	
//	// Correlativo
//	iv$_linea +=  left(wf_limpiar(em_SCTRCorrelativo.Text) + fill(' ',3),3) + '|'
//	
//	// Monto y Tasa
//	iv$_linea += string(f_nonulo(round(dw_sourcesctr.GetItemDecimal ( w%_fila, "MontoSCTR" ), 2))) + '|'
//	w#_tasa = dw_sourcesctr.GetItemDecimal ( w%_fila, "TasaSCTR" ) * (1 + w#_impuesto / 100)
//	iv$_linea += string(f_nonulo(round(w#_tasa, 2))) + '|'
//	
//	FileWrite ( w#_file1, iv$_linea )
//	uo_progress.uf_Set_Position( w%_fila / w%_rowcount * 100 )
//Next
//
//FileClose ( w#_file1 )
//
end subroutine

public function integer wf_generacion_file (string par_tipo, string par_descripcion, string par_nombrefile);string w$_company
double w#_file1, w#_file2
long w%_rowcount
string w$_apellido_paterno, w$_apellido_materno , w$_nombres 
long w%_result1, w%_result2, w%_fila,w%_columna
string w$_archivo1, w$_archivo2
string w$_sexo , w$_tipoasistenciasocial , w$_estadoempleado, w$_situaciontrabajador
string w$_acctrabajo , w$_essaludvida
string w$_fechanacimiento , w$_fechaingreso , w$_fechacese 
string w$_tipodocumento
string w$_formulario='0601'

w$_company =left (iv$_CompaniaSocio,6) 

ST_1.TEXT = par_descripcion

w$_archivo1= par_nombrefile

w$_archivo1=replace(w$_archivo1,pos(w$_archivo1,'ffff'),4,w$_formulario)

w$_archivo1=replace(w$_archivo1,pos(w$_archivo1,'aaaamm'),6,iv$_periodo)

w$_archivo1=replace(w$_archivo1,pos(w$_archivo1,'###########'),11,iv$_documentofiscal)

//w$_archivo1 = iv$_documentofiscal + ".ASE"

w%_result1 = GetFileSaveName("Seleccione el archivo",  & 
	w$_archivo1, w$_archivo1, "",  &
	par_descripcion)

if w%_result1 = 1 then
	iv%_pidioarchivo = 1
	w#_file1 = FileOpen ( w$_archivo1, LineMode!, Write!, LockWrite!, Replace! )

	w%_rowcount = dw_source.rowcount()
// Detalle
	For w%_fila = 1 to w%_rowcount
	   iv$_linea =''	
	 For w%_columna = 1 to 39 	
		If w%_columna=10 or w%_columna=16 or w%_columna=23 then
			w$_tipodocumento =string(dw_source.GetItemDateTime ( w%_fila, w%_columna), "dd/mm/yyyy")
		else 	
  		 w$_tipodocumento =f_nonulo_str(dw_source.getitemstring(w%_fila ,w%_columna))
		end if	
      iv$_linea += w$_tipodocumento + '|'
	 Next
		FileWrite ( w#_file1, iv$_linea )
		uo_progress.uf_Set_Position( w%_fila / w%_rowcount * 100 )
	Next
//		w$_tipodocumento = left(f_nonulo_str(wf_tipodocumento(dw_source.getitemstring(w%_fila ,"tipodocumento"))) + ' ',1)
//		iv$_linea = w$_tipodocumento + '|'
//		iv$_linea += left(f_nonulo_str(dw_source.getitemstring(w%_fila ,"documento")) + fill(' ',15),15) + '|'
//		
//		// Apellido Paterno
//		w$_apellido_paterno = f_nonulo_str(dw_source.GetItemString ( w%_fila, "ApellidoPaterno" ))
//		iv$_linea +=  left(wf_limpiar(w$_apellido_paterno) + fill(' ',20),20 ) + '|'
//		
//		// Apellido Materno
//		w$_apellido_materno = f_nonulo_str(dw_source.GetItemString ( w%_fila, "ApellidoMaterno" ))
//		iv$_linea +=  left(wf_limpiar(w$_apellido_materno) + fill(' ',20),20)+ '|'
//		
//		// Nombres
//		w$_nombres = f_nonulo_str(dw_source.GetItemString ( w%_fila, "Nombres" ))
//		iv$_linea +=  left(wf_limpiar(w$_nombres) + fill(' ',20),20) + '|'
//		
//		
//		w$_fechanacimiento = string(dw_source.GetItemDateTime ( w%_fila, "fechanacimiento" ), "dd/mm/yyyy")
//		
//		if isnull(w$_fechanacimiento ) then
//			iv$_linea += '00/00/0000' + '|'
//		else
//			iv$_linea += w$_fechanacimiento + '|'
//		end if 
//
//		w$_sexo = f_nonulo_str(dw_source.GetItemString ( w%_fila, "sexo" ))
//		if w$_sexo = 'M' then
//			iv$_linea +=  '1'+ '|'
//		else
//			iv$_linea +=  '2'+ '|'
//		end if 
//		
//		iv$_linea +=  left(f_eliminar_caracter_de_cadena(f_nonulo_str(dw_source.GetItemString ( w%_fila, "telefono" )),"-") + fill(' ',7),7)+ '|'
//
//		w$_fechaingreso = string(dw_source.GetItemDateTime ( w%_fila, "fechaingreso" ), "dd/mm/yyyy")
//		
//		if isnull(w$_fechaingreso ) then
//			iv$_linea += '00/00/0000' + '|'
//		else
//			iv$_linea += w$_fechaingreso + '|'
//		end if 
//		
//		w$_tipoasistenciasocial = 	f_nonulo_str(dw_source.GetItemString ( w%_fila, "tipoasistenciasocial")) 
//		w$_estadoempleado = 	f_nonulo_str(dw_source.GetItemString ( w%_fila, "estadoempleado"))
//		if w$_tipoasistenciasocial = 'PRI' then
//			if w$_estadoempleado = '0' then   // activo afiliado a EPS
//				w$_situaciontrabajador = '10'
//			elseif w$_estadoempleado = '2' then   // Baja afiliado a EPS
//				w$_situaciontrabajador = '12'
//			else                                  // Licencia afiliado a EPS
//				w$_situaciontrabajador = '14'
//			end if 
//		else
//			if w$_estadoempleado = '0' then   // activo no afiliado a EPS
//				w$_situaciontrabajador = '11'
//			elseif w$_estadoempleado = '2' then   // Baja no afiliado a EPS
//				w$_situaciontrabajador = '13'
//			else                                  // Licencia no afiliado a EPS
//				w$_situaciontrabajador = '15'
//			end if 
//		end if 
//		
//		iv$_linea += w$_situaciontrabajador+ '|'
//		
//		w$_acctrabajo = f_nonulo_str(dw_source.GetItemString ( w%_fila, "flagacctrabajo") )
////		if w$_acctrabajo = 'S' then
////			iv$_linea += '99' + '|'
////		else
//			iv$_linea += left(f_nonulo_str(dw_source.GetItemString ( w%_fila, "tipotrabajador")),2)+ '|'
////		end if 
//		
//		w$_fechacese = string(dw_source.GetItemDateTime ( w%_fila, "fechacese" ), "dd/mm/yyyy")
//		
//		if isnull(w$_fechacese ) then
//			iv$_linea += '00/00/0000' + '|'
//		else
//			iv$_linea += w$_fechacese + '|'
//		end if 
//		
//		if w$_situaciontrabajador = '10' then
//			iv$_linea += left(f_nonulo_str(dw_source.GetItemString ( w%_fila, "RUCCentroAsistenciaSocial")) + fill(' ',11),11)+ '|'
//		else
//			iv$_linea += '|'
//		end if	
//		
//		w$_essaludvida = f_nonulo_str(dw_source.GetItemString ( w%_fila, "flagipssvida") )
//		if w$_essaludvida = 'S' then
//			iv$_linea += '1' + '|'
//		else
//			iv$_linea += '0' + '|'
//		end if 
//		
//		iv$_linea += f_nonulo_str(wf_regimenpensionario(dw_source.GetItemString ( w%_fila, "TipoPension")) ) + '|'
//		
//		if w$_acctrabajo = 'S' then
//			iv$_linea += '1' + '|'
//		else
//			iv$_linea += '0' + '|'
//		end if
//		
// 		string w$_fechainiciopension
//		w$_fechainiciopension = string(dw_source.GetItemDateTime ( w%_fila, "fechainiciopension" ), "dd/mm/yyyy")
//		iv$_linea += w$_fechainiciopension + '|'
//
//		if w$_tipodocumento <> "1" then
//			iv$_linea += left(f_nonulo_str(dw_source.GetItemString ( w%_fila, "Direccion"	)) + fill(' ',20) ,20 )+ '|'
//			iv$_linea += left(f_nonulo_str(dw_source.GetItemString ( w%_fila, "Numero"		)) + fill(' ',4) ,4 )+ '|'
//			iv$_linea += left(f_nonulo_str(dw_source.GetItemString ( w%_fila, "Interior"	)) + fill(' ',4) ,4 )+ '|'
//			iv$_linea += left(f_nonulo_str(dw_source.GetItemString ( w%_fila, "PDTZona"		)) + fill(' ',20) ,20 )+ '|'
//			iv$_linea += left(f_nonulo_str(dw_source.GetItemString ( w%_fila, "referenciasdireccion")) + fill(' ',40) ,40 )+ '|'
//			iv$_linea += left(wf_tipovia(f_nonulo_str(dw_source.GetItemString ( w%_fila, "pdttipocalle"	))) + fill(' ',2) ,2 )+ '|'
//			iv$_linea += left(wf_tipozona(f_nonulo_str(dw_source.GetItemString ( w%_fila, "pdttipozona"	))) + fill(' ',2) ,2 )+ '|'
//			iv$_linea += left(f_nonulo_str(dw_source.GetItemString ( w%_fila, "ubigeo"		)) + fill(' ',6) ,6 )+ '|'
//		else
//			iv$_linea += left(f_nonulo_str('') + fill(' ',20) ,20 )+ '|'
//			iv$_linea += left(f_nonulo_str('') + fill(' ',4) ,4 )+ '|'
//			iv$_linea += left(f_nonulo_str('') + fill(' ',4) ,4 )+ '|'
//			iv$_linea += left(f_nonulo_str('') + fill(' ',20) ,20 )+ '|'
//			iv$_linea += left(f_nonulo_str('') + fill(' ',40) ,40 )+ '|'
//			iv$_linea += left(wf_tipovia(f_nonulo_str('')) + fill(' ',2) ,2 )+ '|'
//			iv$_linea += left(wf_tipozona(f_nonulo_str('')) + fill(' ',2) ,2 )+ '|'
//			iv$_linea += left(f_nonulo_str('') + fill(' ',6) ,6 )+ '|'			
	//	end if
		

	FileClose ( w#_file1 )

 Return 0

end if

end function

public function integer wf_procesa_file (string par_tipo, string par_descripcion, string par_nombrefile);/*
------------------------------------------------------------------------------------------------------
Objeto					: wf_procesa_file
Objetivo					: Procesa los archivos seleccionados
Autor						: 
Fecha						: 
Nro. RQ					: 
Parámetros Entrada	: Tipo, Descripción, Nombre Archivo
Parámetros Salida		: Ninguno
Observación				: Ninguno
------------------------------------------------------------------------------------------------------
Modificaciones
Nro. RQ		Fecha			Usuario			Descripción
------------------------------------------------------------------------------------------------------
RQ 00047		12/07/2012	JCOAGUILAP		Actualiza el tipo de archivos
------------------------------------------------------------------------------------------------------
*/
string w$_company
double w#_file1, w#_file2
long w%_rowcount
string w$_apellido_paterno, w$_apellido_materno , w$_nombres 
long w%_result1, w%_result2, w%_fila,w%_columna
string w$_archivo1, w$_archivo2
integer li_return

w$_company =left (iv$_CompaniaSocio,8) 

ST_1.TEXT = par_descripcion

w$_archivo1= par_nombrefile

li_return = 0
	
Choose case par_tipo
	CASE 'ESP'
   		wf_procesa_ar1()
	CASE 'EDD'
   		wf_procesa_ar2_edd()		
	CASE 'LDD' // RQ 00047
   		wf_procesa_ar2_sdd()			
	CASE 'MED'
	CASE 'IDE' // RQ 00047
			wf_procesa_ar4()
			fw_ActualizaDatos()
	CASE 'TRA' // RQ 00047
			wf_procesa_ar5()
	CASE 'PEN' // RQ 00047
			wf_procesa_ar6()
	CASE 'PS4' // RQ 00047
			wf_procesa_ar7()
	CASE 'S00'
			wf_procesa_ar8()
	CASE 'PFL' // RQ 00047
			wf_procesa_ar9()
	CASE 'TER' // RQ 00047
	CASE 'PER' // RQ 00047
			wf_procesa_ar11()
	CASE 'OR5' // RQ 00047
			wf_procesa_ar12()
	CASE 'DHA','DHB' // RQ 00047
		wf_procesa_ar13(Right(par_tipo, 1)) // Envia "A" o "B" según el caso
	CASE 'JOR'
		wf_procesa_ar14()
	CASE 'SNL' // RQ 00047
		wf_procesa_ar15()
	CASE 'NOT'
		wf_procesa_ar16()
	CASE 'EST' // RQ 00047
		wf_procesa_ar17()
	CASE 'REM'
		wf_procesa_ar18()
	CASE 'RPE' // RQ 00047
		wf_procesa_ar19()		
	CASE '4TA'
		wf_procesa_ar20()		
	CASE 'FOR'
		wf_procesa_ar21()
	CASE 'PTE' // RQ 00047
	CASE 'TOC'
		wf_procesa_ar26()		
	CASE 'POC'
		wf_procesa_ar27()
	CASE 'EDU'
		wf_procesa_ar29()
	CASE 'CTA'
		wf_procesa_ar30()
	CASE 'AOS'
		li_return = wf_procesa_ar31()
	Case  Else
			messagebox("Error","Archivo no encontrado")
	
End Choose		

Return li_return



end function

public function integer wf_procesa_ar1 ();long w%_fila,w%_rowcount 
string W$_COMPANY
string w$_tipo,w$_codigo,w$_denominacion,w$_indcentroriesgo
double  w%_tasa

w$_company =left (iv$_CompaniaSocio,8)
dw_source_01.SetTransObject(SQLCA)
dw_source_01.retrieve(w$_company)

w%_rowcount=dw_source_01.rowcount()

DELETE FROM RTPS_AR1_ESP
WHERE PERIODO = :iv$_periodo
AND COMPANIASOCIO =:W$_COMPANY
AND TIPOINGRESO='A'
USING SQLCA;

if sqlca.sqlcode < 0 then
	string w$_msg
	w$_msg = sqlca.sqlerrtext
	rollback;
	f_msg(w$_msg)
	return -1
end if

COMMIT;
uo_progress.uf_Set_Position(0)
uo_progress.uf_Check(FALSE)

datetime w%_hoy 
w%_hoy = f_today()
	
For w%_fila=1 to w%_rowcount 

	w$_codigo=dw_source_01.Getitemstring(w%_fila,'codigo')
	w$_tipo=dw_source_01.GetItemString(w%_fila,'tipoestablecimiento')
	w$_denominacion=dw_source_01.GetItemString(w%_fila,'denominacion')
	w$_indcentroriesgo=dw_source_01.GetItemString(w%_fila,'indcentroriesgo')
	w%_tasa=dw_source_01.GetItemNumber(w%_fila,'tasa')
	
	
	INSERT INTO RTPS_AR1_ESP
	(	TIPO,CODIGO,
		DENOMINACION ,INDCENTRORIESGO ,	
		TASA ,	PERIODO,	
		COMPANIASOCIO ,	TIPOINGRESO,	
		INDERROR ,	UltimoUsuario ,
		UltimaFechaModif
	)
	VALUES
	(	:w$_tipo,:w$_codigo,
		:w$_denominacion,:w$_indcentroriesgo,
		:w%_tasa,:iv$_periodo,
		:w$_company,'A',
		'N',:str_global.gv_userid,
		:w%_hoy
	)
	USING SQLCA;
	if sqlca.sqlcode < 0 then
		w$_msg = sqlca.sqlerrtext
		rollback;
		f_msg(w$_msg)
		return -1
	end if
		uo_progress.uf_Set_Position( w%_fila / w%_rowcount * 100 )

Next 	
	
COMMIT;

RETURN 0
end function

public function integer wf_procesa_ar2 ();long w%_fila,w%_rowcount 
string W$_COMPANY
string w$_RUCEMPRESADESTACO,w$_RAZONSOCIAL, w$_CODIGOACTIVIDAD
STRING w$_DENOMINACION, w$_INDCENTRORIESGO, w$_TASA

w$_company =left (iv$_CompaniaSocio,8) 
	
//edd	
	dw_source_02_edd.SetTransObject(SQLCA)
	dw_source_02_edd.retrieve()
	w%_rowcount=dw_source_02_edd.rowcount()

		DELETE FROM RTPS_AR2_EDD
		WHERE PERIODO = :iv$_periodo
		AND COMPANIASOCIO =:W$_COMPANY
		AND TIPOINGRESO='A'
		USING SQLCA;

		COMMIT;

	For w%_fila=1 to w%_rowcount 
		w$_RUCEMPRESADESTACO=f_nonulo_str(dw_source_02_edd.GetitemString(w%_fila,1))
		w$_RAZONSOCIAL=f_nonulo_str(dw_source_02_edd.GetitemString(w%_fila,2))
		w$_CODIGOACTIVIDAD=f_nonulo_str(String(dw_source_02_edd.GetitemNumber(w%_fila,3)))

		INSERT INTO RTPS_AR2_EDD
			(RUCEMPRESADESTACO,
			RAZONSOCIAL,
			CODIGOACTIVIDAD,
			PERIODO,	
			COMPANIASOCIO ,	
			TIPOINGRESO,	
			INDERROR ,
			UltimoUsuario ,
			UltimaFechaModif)
		VALUES
		(:w$_RUCEMPRESADESTACO,:w$_RAZONSOCIAL,:w$_CODIGOACTIVIDAD,
		:iv$_periodo,:w$_company,'A','N',
		:str_global.gv_userid,:str_global.gv_today)
		USING SQLCA;
		
	Next 	
	
		COMMIT;

//sdd	
	dw_source_02_sdd.SetTransObject(SQLCA)
	dw_source_02_sdd.retrieve()
	w%_rowcount=dw_source_02_sdd.rowcount()

		DELETE FROM RTPS_AR2_SDD
		WHERE PERIODO = :iv$_periodo
		AND COMPANIASOCIO =:W$_COMPANY
		AND TIPOINGRESO='A'
		USING SQLCA;

		COMMIT;

	For w%_fila=1 to w%_rowcount 
		w$_RUCEMPRESADESTACO=f_nonulo_str(dw_source_02_sdd.GetitemString(w%_fila,1))
		w$_DENOMINACION=f_nonulo_str(dw_source_02_sdd.GetitemString(w%_fila,2))
		w$_INDCENTRORIESGO=f_nonulo_str(dw_source_02_sdd.GetitemString(w%_fila,3))
		w$_TASA=f_nonulo_str(String(dw_source_02_sdd.GetitemNumber(w%_fila,4)))

		INSERT INTO RTPS_AR2_SDD
			(RUCEMPRESADESTACO,
			DENOMINACION,
			INDCENTRORIESGO,
			INDCENTRORIESGO,
			TASA,
			PERIODO,	
			COMPANIASOCIO ,	
			TIPOINGRESO,	
			INDERROR ,
			UltimoUsuario ,
			UltimaFechaModif)
		VALUES
		(:w$_RUCEMPRESADESTACO,:w$_DENOMINACION,:w$_INDCENTRORIESGO,:w$_TASA,
		:iv$_periodo,:w$_company,'A','N',
		:str_global.gv_userid,:str_global.gv_today)
		USING SQLCA;
		
	Next 	
	
		COMMIT;


RETURN 0
end function

public function integer wf_procesa_ar10 ();long w%_fila,w%_rowcount 
string W$_COMPANY
string w$_tipodoc,w$_numdoc,w$_turno


	w$_company =left (iv$_CompaniaSocio,8) 
	dw_source_10.SetTransObject(SQLCA)
	dw_source_10.retrieve(w$_company)
	w%_rowcount=dw_source_10.rowcount()

		DELETE FROM AR10_TRAXTUR
		WHERE PERIODO = :iv$_periodo
		AND COMPANIASOCIO =:W$_COMPANY
		AND TIPOINGRESO='A'
		USING SQLCA;

		COMMIT;
uo_progress.uf_Set_Position(0)
uo_progress.uf_Check(FALSE)	
	For w%_fila=1 to w%_rowcount 

		w$_tipodoc=f_nonulo_str(wf_tipodocumento(dw_source_10.GetitemString(w%_fila,1)))
		w$_numdoc=f_nonulo_str(dw_source_10.GetitemString(w%_fila,2))
		w$_turno=String(dw_source_10.GetitemNumber(w%_fila,3))

		INSERT INTO AR10_TRAXTUR
		(TIPODOC,NUMDOC,CORRTUR,
   	PERIODO,	COMPANIASOCIO,	TIPOINGRESO,	INDERROR ,
   	UltimoUsuario ,UltimaFechaModif)
		VALUES
		(:w$_tipodoc,:w$_numdoc,:w$_turno,
		:iv$_periodo,:w$_company,'A','N',
		:str_global.gv_userid,:str_global.gv_today)
		USING SQLCA;
			uo_progress.uf_Set_Position( w%_fila / w%_rowcount * 100 )
	Next 	
	
		COMMIT;


RETURN 0
end function

public function integer wf_procesa_ar9 ();/*
------------------------------------------------------------------------------------------------------
Objeto					: wf_procesa_ar9
Objetivo					: Procesa la información del archivo 9
Autor						: 
Fecha						: 
Nro. RQ					: 
Parámetros Entrada	: Ninguno
Parámetros Salida		: Ninguno
Observación				: Ninguno
------------------------------------------------------------------------------------------------------
Modificaciones
Nro. RQ		Fecha			Usuario			Descripción
------------------------------------------------------------------------------------------------------
RQ 00047		16/08/2012	JCOAGUILAP		Actualiza estructura el archivo
------------------------------------------------------------------------------------------------------
*/
long w%_fila,w%_rowcount,w%_persona
string W$_COMPANY, w$_periodo
string w$_tipodoc,w$_numdoc
string w$_niveledu,w$_ocupacion
string w$_discapacidad,w$_tipforpro
string w$_hornor,w$_indmadre
string w$_afieps
Datetime w%_fecini,w%_fecins
String ls_PaisEmisor, ls_TipoModaLab // RQ 00047
 
w$_periodo =iv$_periodo+mid(iv$_periodo,5,2)

w$_company =left (iv$_CompaniaSocio,8) 
dw_source_09.SetTransObject(SQLCA)
dw_source_09.retrieve(w$_company,w$_periodo)
w%_rowcount=dw_source_09.rowcount()

DELETE FROM RTPS_AR9_T04
WHERE PERIODO = :iv$_periodo
AND COMPANIASOCIO =:W$_COMPANY
AND TIPOINGRESO='A'
USING SQLCA;

if sqlca.sqlcode < 0 then
	string w$_msg
	w$_msg = sqlca.sqlerrtext
	rollback;
	f_msg(w$_msg)
	return -1
end if

COMMIT;

uo_progress.uf_Set_Position(0)
uo_progress.uf_Check(FALSE)					

datetime w%_hoy
w%_hoy = f_today()

For w%_fila=1 to w%_rowcount 
	w%_persona=dw_source_09.getItemNumber(w%_fila,'persona')
	w$_tipodoc=Right('00'+f_nonull_left(wf_tipodocumento(dw_source_09.GetitemString(w%_fila,'tipodocumento')), 2), 2)
	w$_numdoc=f_nonull_left(dw_source_09.GetitemString(w%_fila,'documento'), 15)
	If f_nonulo_str(dw_source_09.GetitemString(w%_fila,'tipoasistenciasocial'))='IPS' then
		w$_afieps='1'
	else
		w$_afieps='2'
	END IF 
	w$_Niveledu=f_nonull_left(dw_source_09.GetitemString(w%_fila,'niveleducativortps'), 2)
	w$_ocupacion=f_nonull_left(wf_ocupacion(dw_source_09.GetitemDecimal(w%_fila,'codigocargo')), 6)
	w$_indmadre=f_nonull_left(dw_source_09.GetitemString(w%_fila,'flagmadreresponsabilidad'), 1)
	w$_discapacidad=f_nonull_left(dw_source_09.getItemString(w%_fila,'flagdiscapacidad'), 1)
	w$_tipforpro=f_nonull_left(dw_source_09.getItemString(w%_fila,'flagcentroformacion'), 1)
	w$_hornor=f_nonull_left(dw_source_09.getItemString(w%_fila,'flaghorarionocturno'), 1)
	// RQ 00047 Inicio
	ls_PaisEmisor = f_nonull_left(wf_paisemisor(dw_source_09.getItemString(w%_fila,'paisemisordocumento')), 3)
	ls_TipoModaLab = f_nonull_left(dw_source_09.getItemString(w%_fila,'tipomodalaboral'), 2)
	// RQ 00047 Fin

	INSERT INTO RTPS_AR9_T04
	(	TIPODOC	,
		NUMERODOC	,
		SEGUROMEDICO	,
		NIVELEDUCATIVO	,
		OCUPACION	,
		INDMADRERESP	,
		DISCAPACIDAD	,
		TIPOCENTFORM	,
		INDNOCTURNO	,
		PERIODO	,
		COMPANIASOCIO	,
		TIPOINGRESO	,
		INDERROR	,
		ULTIMOUSUARIOGENER	,
		ULTIMAFECHAGENER,
		PAISEMISORDOC, // RQ 00047 Inicio
		TIPOMODAFORM   // RQ 00047 Fin	
	) 
	VALUES
	(
		:w$_tipodoc,:w$_numdoc,
		:w$_afieps,:w$_Niveledu,:w$_ocupacion,:w$_indmadre,
		:w$_discapacidad,:w$_tipforpro,:w$_hornor,
		:iv$_periodo,:w$_company,'A','N',
		:str_global.gv_userid,:w%_hoy,
		:ls_PaisEmisor, :ls_TipoModaLab) // RQ 00047
	USING SQLCA;
	
	if sqlca.sqlcode < 0 then
		w$_msg = sqlca.sqlerrtext
		rollback;
		f_msg(w$_msg)
		return -1
	end if

	uo_progress.uf_Set_Position( w%_fila / w%_rowcount * 100 )
	
Next 	
	
COMMIT;

uo_progress.uf_Set_Position(100)
uo_progress.uf_Check(TRUE)


RETURN 0
end function

public function integer wf_procesa_ar3 ();//long w%_fila,w%_rowcount,w%_secuencia,w%_filas,w%_persona
//string W$_COMPANY
//string w$_tipodoc,w$_numdoc,w$_apepat,w$_apemat,w$_nombres,w$_categoria,w$_trapen
//string w$_tipopen,w$_rucint,w$_sexo,w$_telefono,w$_reglab,w$_siteps,w$_tipotra
//string w$_codeps,w$_essavida,w$_regpen,w$_cuspp,w$_sctrs,w$_sctrp,w$_nacion
//string w$_discap,w$_email,w$_banco,w$_tipocuenta,w$_numcuenta,w$_periodicidad
//string w$_tiporem,w$_control,w$_sindicato,w$_muni,w$_Niveledu,w$_ocupacion,w$_Tipocont
//string w$_estcivil,w$_fdomi,w$_ruc
//string w$_tipovia,w$_nombrevia,w$_numerovia,w$_interior
//string w$_tipozona,w$_nombrezona,w$_referencia,w$_ubigeo
//Datetime w%_fecnac,w%_fecbaja,w%_fecins
//
//
//
//	w$_company =left (iv$_CompaniaSocio,8) 
//	dw_source_03.SetTransObject(SQLCA)
//	dw_source03_dir.SetTransObject(SQLCA)
//	dw_source_03.retrieve(w$_company)
//	w%_rowcount=dw_source_03.rowcount()
//
//
//		DELETE FROM AR3_TRA
//		WHERE PERIODO = :iv$_periodo
//		AND COMPANIASOCIO =:W$_COMPANY
//		AND TIPOINGRESO='A'
//		USING SQLCA;
// 
//		COMMIT;
//
//uo_progress.uf_Set_Position(0)
//uo_progress.uf_Check(FALSE)	

//	For w%_fila=1 to w%_rowcount 
//
//		w%_persona=dw_source_03.getItemNumber(w%_fila,45)
//		w$_tipodoc=f_nonulo_str(wf_tipodocumento(dw_source_03.GetitemString(w%_fila,1)))
//		w$_numdoc=Left (f_nonulo_str(dw_source_03.GetitemString(w%_fila,2)), 15)
//
//		w$_apepat=Left (f_nonulo_str(dw_source_03.GetitemString(w%_fila,3)),40)
//		
//		w$_apemat=Left (f_nonulo_str(dw_source_03.GetitemString(w%_fila,4)),40)
//		w$_nombres=Left (f_nonulo_str(dw_source_03.GetitemString(w%_fila,5)),40)
//		w$_categoria=f_nonulo_str(wf_categoriatrabajador(dw_source_03.GetitemString(w%_fila,6)))
//
//		if dw_source_03.GetitemString(w%_fila,7)='1' then
//			w$_trapen='1'
//		else
//			w$_trapen='0'
//		end if 
//		if w$_categoria='2' or w$_trapen='1' then
//			w$_tipopen=f_nonulo_str(dw_source_03.GetitemString(w%_fila,8))
//		else
//			w$_tipopen=''
//		end if	
//		if w$_categoria='4' then 
//			w$_rucint=f_nonulo_str(dw_source_03.GetitemString(w%_fila,9))
//		else
//			w$_rucint=''
//		end if	
//		w%_fecnac=dw_source_03.getItemDateTime(w%_fila,10)
//		if dw_source_03.GetitemString(w%_fila,11)='F' then
//			w$_sexo='2'
//		else
//			w$_sexo='1'
//		end if	
//		
//
//		w$_telefono=left(f_eliminar_caracter_de_cadena(f_nonulo_str(dw_source_03.GetitemString(w%_fila,12)),"-") + fill(' ',7),7)
//		w$_reglab=f_nonulo_str(wf_regimenlaboral(w$_company))
//		//w$_siteps=f_nonulo_str(wf_situacioneps(dw_source_03.GetitemString(w%_fila,14)))
//		w$_tipotra=f_nonulo_str(wf_tipotrabajador(dw_source_03.GetitemString(w%_fila,6)))
//		w%_fecbaja=dw_source_03.getItemDateTime(w%_fila,15)
//		w$_codeps=f_nonulo_str(wf_eps(dw_source_03.getItemString(w%_fila,16)))
//
//		
//		if dw_source_03.getItemString(w%_fila,17)='S'  then
//			w$_essavida='1'
//		else
//			w$_essavida='0'
//		end if	
//		w$_regpen=f_nonulo_str(wf_regimenpensionario(dw_source_03.GetitemString(w%_fila,13),dw_source_03.GetitemString(w%_fila,18)))
//		w$_cuspp=f_nonulo_str(dw_source_03.getItemString(w%_fila,19))
//		w$_sctrs=f_nonulo_str(dw_source_03.getItemString(w%_fila,20))
//		w$_sctrp=f_nonulo_str(dw_source_03.getItemString(w%_fila,21))
//		w%_fecins=dw_source_03.getItemDateTime(w%_fila,22)
//		w$_nacion=f_nonulo_str(dw_source_03.getItemString(w%_fila,23))
//		w$_discap=f_nonulo_str(dw_source_03.getItemString(w%_fila,24))
//		w$_email=f_nonulo_str(dw_source_03.getItemString(w%_fila,25))
//		if dw_source_03.getItemString(w%_fila,26)='IB' 	or dw_source_03.getItemString(w%_fila,26)='TR'then
//			if dw_source_03.getItemString(w%_fila,27)='LO' then
//				w$_banco=f_nonulo_str(wf_banco(dw_source_03.getItemString(w%_fila,28)))
//				
//				Choose case dw_source_03.getItemString(w%_fila,28)
//					Case 'A' 
//						w$_tipocuenta='1'
//					Case 'C'	
//						w$_tipocuenta='2'
//					Case Else
//						w$_tipocuenta='3'
//				End Choose		
//				
//				w$_numcuenta=f_nonulo_str(wf_banco(dw_source_03.getItemString(w%_fila,30)))
//			else	
//				w$_banco=f_nonulo_str(dw_source_03.getItemString(w%_fila,31))
//				Choose case dw_source_03.getItemString(w%_fila,32)
//					Case 'A' 
//						w$_tipocuenta='1'
//					Case 'C'	
//						w$_tipocuenta='2'
//					Case Else
//						w$_tipocuenta='3'
//				End Choose		
//				w$_numcuenta=f_nonulo_str(dw_source_03.getItemString(w%_fila,33))
//			end if	
//		else
//			w$_banco=''
//			w$_tipocuenta=''
//			w$_numcuenta=''
//		end if
//		w$_periodicidad=f_nonulo_str(wf_periodicidad(dw_source_03.GetitemString(w%_fila,34)))
//		w$_tiporem=f_nonulo_str(dw_source_03.getItemString(w%_fila,35))
//		if f_nonulo_str(dw_source_03.getItemString(w%_fila,36))<>'1' then
//			w$_control='0'
//		else
//			w$_control=f_nonulo_str(dw_source_03.getItemString(w%_fila,36))
//		end if
//		if f_nonulo_str(dw_source_03.getItemString(w%_fila,37))<>'1' then
//			w$_sindicato='0'
//		else
//			w$_sindicato=f_nonulo_str(dw_source_03.getItemString(w%_fila,37))
//		end if
//		if w$_tipodoc='11' then
//			w$_muni=f_nonulo_str(dw_source_03.getItemString(w%_fila,38))
//		else
//			w$_muni=''
//		end if	
//		w$_Niveledu=''//pendiente funcion de conversion
//		//obsoleto		w$_ocupacion=f_nonulo_str(wf_ocupacion(dw_source_03.GetitemString(w%_fila,40)))
//		w$_ocupacion=f_nonulo_str(wf_ocupacion(dw_source_03.GetitemDecimal(w%_fila,15)))
//		w$_Tipocont=f_nonulo_str(wf_tipocontrato(dw_source_03.GetitemString(w%_fila,41)))
//		w$_estcivil=f_nonulo_str(wf_estadocivil(dw_source_03.getItemString(w%_fila,42)))
//		if f_nonulo_str(dw_source_03.getItemString(w%_fila,43))<>'2' then
//			w$_fdomi='1'
//		else
//			w$_fdomi=f_nonulo_str(dw_source_03.getItemString(w%_fila,43))
//		end if	
//		w$_ruc=f_nonulo_str(dw_source_03.getItemString(w%_fila,44))
//	
//
//				w$_tipovia=''
//				w$_nombrevia=''
//				w$_numerovia=''
//				w$_interior=''
//				w$_tipozona=''
//				w$_nombrezona=''
//				w$_referencia=''
//				w$_ubigeo=''
//
//
//
//		SELECT COALESCE(MAX(SECUENCIA),0) INTO :w%_secuencia
//		FROM DIRECCION
//		WHERE PERSONA=:w%_persona AND SECUENCIA>=0;
//		
//		dw_source03_dir.retrieve(w%_persona,w%_secuencia)
//
//		For w%_filas=1 to dw_source03_dir.rowcount()
//				w$_tipovia=Left (wf_tipovia(dw_source03_dir.GetItemString(w%_filas,3)),2)
//				w$_nombrevia=Left (dw_source03_dir.GetItemString(w%_filas,4), 20)
//				w$_numerovia=Left (dw_source03_dir.GetItemString(w%_filas,5), 4)
//				w$_interior=Left (dw_source03_dir.GetItemString(w%_filas,6), 4)
//				w$_tipozona=Left (wf_tipozona(dw_source03_dir.GetItemString(w%_filas,7)),2)
//				w$_nombrezona=Left (dw_source03_dir.GetItemString(w%_filas,8),20)
//				w$_referencia=Left (dw_source03_dir.GetItemString(w%_filas,9), 40)
//				w$_ubigeo=Left (dw_source03_dir.GetItemString(w%_filas,10), 6)
//	
//		Next
//
//		INSERT INTO AR3_TRA
//		(TIPODOC,
//		NUMERODOC,   
//         APEPATERNO,   
//         APEMATERNO,   
//         NOMBRES,   
//         CATEGORIA,   
//         TRAPENSION,   
//         TIPOPENSION,   
//         RUCINTERMEDIACION,   
//         FECHANAC,   
//         SEXO,   
//         TELEFONO,   
//         REGIMEN,   
//         SITEPS,   
//         TIPOTRABAJADOR,   
//         FECHABAJA,   
//         CODEPS,   
//         ESSALUDVIDA,   
//         REGPENSION,   
//         CUSPP,   
//         SCTRSALUD,   
//         SCTRPENSION,   
//         FECHAREGPENSION,   
//         NACIONALIDAD,   
//         DISCAPACIDAD,   
//         EMAIL,   
//         ENTFINANCIERA,   
//         TIPOCUENTA,   
//         NUMCUENTA,   
//         PERIOCIDAD,   
//         TIPREMUN,   
//         CONTROL,   
//         SINDICALIZADO,   
//         MUNPARTIDA,   
//         NIVELEDUCATIVO,   
//         OCUPACION,   
//         TIPOCONTRATO,   
//         ESTCIVIL,   
//         DOMICILIADO,   
//         RUCPERSONA,   
//         DOMTIPOVIA,   
//         DOMNOMBREVIA,   
//         DOMNUMEROVIA,   
//         DOMINTERIOR,   
//         DOMTIPOZONA,   
//         DOMNOMZONA,   
//         DOMREFERENCIA,   
//         DOMUBIGEO,   
//         PERIODO,   
//         COMPANIASOCIO,   
//         TIPOINGRESO,   
//         INDERROR,   
//         UltimoUsuario,   
//         UltimaFechaModif ) 
//		VALUES
//		(:w$_tipodoc,:w$_numdoc,:w$_apepat,:w$_apemat,:w$_nombres,:w$_categoria,:w$_trapen,
//		 :w$_tipopen,:w$_rucint,:w%_fecnac,:w$_sexo,:w$_telefono,:w$_reglab,:w$_siteps,
//		 :w$_tipotra,:w%_fecbaja,:w$_codeps,:w$_essavida,:w$_regpen,:w$_cuspp,:w$_sctrs,
//		 :w$_sctrp,:w%_fecins,:w$_nacion,:w$_discap,:w$_email,:w$_banco,:w$_tipocuenta,
//		 :w$_numcuenta,:w$_periodicidad,:w$_tiporem,:w$_control,:w$_sindicato,:w$_muni,
//		 :w$_Niveledu,:w$_ocupacion,:w$_Tipocont,:w$_estcivil,:w$_fdomi,:w$_ruc,:w$_tipovia,
//		 :w$_nombrevia,:w$_numerovia,:w$_interior,:w$_tipozona,:w$_nombrezona,:w$_referencia,:w$_ubigeo,
//		:iv$_periodo,:w$_company,'A','N',
//		:str_global.gv_userid,:str_global.gv_today)
//		USING SQLCA;
//		if SQLCA.SQLCode <> 0 then
//			f_msg (w$_numdoc)
//		end if
//	Next 	
//	uo_progress.uf_Set_Position( w%_fila / w%_rowcount * 100 )	
//		COMMIT;
//

RETURN 0
end function

public function integer wf_procesa_ar4 ();/*
----------------------------------------------------------------------------------------------------------------------------------------------------------
Objeto             : wf_procesa_ar4()
Objetivo      		 : Genera la data para el archivo T00
Autor              : PYOVERA
Fecha					 : 13/01/2012
Nro. RQ				 : ###
Parámetros Entrada : Ninguno
Parámetros Salida	 : 0 ==> Función culminó satisfactóriamente
                    -1 ==> Función No culminó satisfactóriamente
Observación   		 : Ninguna
----------------------------------------------------------------------------------------------------------------------------------------------------------
Modificaciones
Nro. RQ		Fecha      	  Usuario        Descripción
----------------------------------------------------------------------------------------------------------------------------------------------------------
RQ. 00047	11/07/2012	  JCOAGUILAP	  Agregar nuevos campos para T-Registro, modificar la longitud del telefono y recuperar el correo electronico
----------------------------------------------------------------------------------------------------------------------------------------------------------
*/

String 	los_CodiCia,los_CodiPeriodo, los_CodiPeriodoanterior, los_message, los_TipoDocu,los_NumeDocu,los_ApelPate,los_ApelMate,los_Nombres, &
			los_Sexo,los_CodNacion,los_NumTelefono, los_Email, los_EssaVida ,los_IndDomiciliado,  los_TipoVia,los_NomVia,los_NumVia,los_Interior, &
			los_tipoZona,los_NomZona,los_Referencia,los_CodUbigeo, ls_IndFuente
Long 		lol_MesInicio,lol_Anio, lol_fila, lol_fila1, lol_CodiPersona, lol_filas, lol_CodSec, lol_ConPago
DateTime	lodt_FecIniPeriodo, lodt_FecFinPeriodo,  lodt_FecDelDia, lodt_FecNaci
Date 		lod_FecIniPeriodo,lod_FecFinPeriodo

String   ls_PaisEmisor, ls_CodigoLDN, ls_Dir1Dpto, ls_Dir1Manzana, ls_Dir1Lote, ls_Dir1Km, ls_Dir1Block &
          ,ls_Dir1Etapa, ls_Dir2TipoVia, ls_Dir2NomVia, ls_Dir2NroVia, ls_Dir2Dpto, ls_Dir2Interior, ls_Dir2Manzana &
	      ,ls_Dir2Lote, ls_Dir2Km, ls_Dir2Block, ls_Dir2Etapa, ls_Dir2TipoZona, ls_Dir2NomZona &
	      , ls_Dir2Ref, ls_Dir2Ubigeo, ls_AsigEssalud,ls_IndAltaBaja, ls_IndIniActual, ls_PeriAntPost, ls_IndUniPer &
		 , ls_IndPlanOtros
Boolean	lb_InsertaRegistro //lb_SavePago		 

dw_filtro.accepttext( )

los_CodiCia 			=left (iv$_CompaniaSocio,8) 
los_CodiPeriodo 	= iv$_periodo+mid(iv$_periodo,5,2)
ls_PeriAntPost 		= is_PeriAntePost + mid(is_PeriAntePost,5,2)
lodt_FecIniPeriodo	= DateTime(Date('01/'+mid(iv$_periodo,5,2)+'/'+mid(iv$_periodo,1,4)))
lod_FecIniPeriodo	= Date(lodt_FecIniPeriodo)

ls_IndAltaBaja = dw_filtro.object.ind_altabaja[1]
ls_IndIniActual 	= dw_filtro.object.ind_iniactual[1]
ls_IndUniPer 	= dw_filtro.object.ind_unicoper[1]
ls_IndPlanOtros	= dw_filtro.object.plani_otros[1]
ls_IndFuente	= dw_filtro.object.ind_origen[1]

lol_MesInicio 	= Month(lod_FecIniPeriodo)
lol_Anio 			= Year(lod_FecIniPeriodo)

//Rango Inicial:
lod_FecIniPeriodo = Date(lol_Anio, lol_MesInicio, 1)
//Rango Final:
IF lol_MesInicio < 12 THEN
	lod_FecFinPeriodo = RelativeDate( Date(lol_Anio, lol_MesInicio+ 1, 1),  - 1)
ELSE
	lod_FecFinPeriodo = RelativeDate( Date(lol_Anio + 1, 1, 1),  - 1)
END IF
lodt_FecFinPeriodo=DateTime(lod_FecFinPeriodo)

IF IsNUll(ls_PeriAntPost) OR TRIM(ls_PeriAntPost)='' THEN
	los_CodiPeriodoanterior=String(Long(iv$_periodo)-1)
	if Mid(los_CodiPeriodoanterior,5,2) ='00' 	then 
		los_CodiPeriodoanterior=String(Long(iv$_periodo)-89)
	end if
	los_CodiPeriodoanterior		=los_CodiPeriodoanterior+mid(los_CodiPeriodoanterior,5,2)
ELSE
	los_CodiPeriodoanterior = ls_PeriAntPost
END IF

IF ls_IndUniPer = '1' Then //Solo el periodo actual
	los_CodiPeriodoanterior = los_CodiPeriodo
END IF

IF ls_IndPlanOtros = '1' THEN
	ls_IndIniActual = 'T'
END IF

dw_source_04.SetTransObject(SQLCA)
dw_source04_dir.SetTransObject(SQLCA)
dw_source_04.retrieve(los_CodiCia,los_CodiPeriodo,los_CodiPeriodoanterior,ls_IndAltaBaja, ls_IndIniActual)

lol_filas=dw_source_04.rowcount()

DELETE FROM RTPS_AR4_T00                                                     
WHERE PERIODO = :iv$_periodo
AND COMPANIASOCIO =:los_CodiCia
AND TIPOINGRESO='A'
USING SQLCA;

if sqlca.sqlcode < 0 then	
	los_message = sqlca.sqlerrtext
	Rollback;
	f_msg(los_message)
	Return -1
end if
COMMIT;
		
uo_progress.uf_Set_Position(0)
uo_progress.uf_Check(FALSE)					

lodt_FecDelDia = f_today()

For lol_fila=1 to lol_filas 

	lol_CodiPersona	=dw_source_04.getItemNumber(lol_fila,"persona")
	los_TipoDocu		= Right('00'+f_nonull_left(wf_tipodocumento(dw_source_04.GetitemString(lol_fila,"tipodocumento")), 2), 2) 	
	los_NumeDocu		=f_nonull_left(dw_source_04.GetitemString(lol_fila,'documento'),15)
	los_ApelPate		=f_nonull_left(wf_limpiar(dw_source_04.GetitemString(lol_fila,'apellidopaterno')), 40)
	los_ApelMate		=f_nonull_left(wf_limpiar(dw_source_04.GetitemString(lol_fila,'apellidomaterno')),40)
	los_Nombres		=f_nonull_left(wf_limpiar(dw_source_04.GetitemString(lol_fila,'nombres')), 40)
	lodt_FecNaci		=dw_source_04.getItemDateTime(lol_fila,'fechanacimiento')

	if dw_source_04.GetitemString(lol_fila,'sexo')='F' then
		los_Sexo='2'
	else
		los_Sexo='1'
	end if	
	
	los_CodNacion=f_nonull_left(wf_nacionalidad(dw_source_04.getItemString(lol_fila,'nacionalidad')), 4)
	
	if los_TipoDocu = '01' then // RQ 00047 - Se incrementó un cero
		los_CodNacion='9589'
	end if	
	
	// RQ 00047 Inicio
	ls_PaisEmisor = f_nonull_left(wf_paisemisor(dw_source_04.getItemString(lol_fila,'paisemisordocumento')), 3)
	
	los_NumTelefono=f_nonull_left(f_eliminar_caracter_de_cadena(dw_source_04.GetitemString(lol_fila,'telefono'),"-"),9)
	if len(los_NumTelefono) < 6 Or Not IsNumber(los_NumTelefono) then // Valida si es numérico
		los_NumTelefono=''
	end if	
	ls_CodigoLDN = f_nonull_left(f_miscelaneacodigo1('SH', 'CODTELFLDN', dw_source_04.getItemString(lol_fila,'codigociudadtelefono')), 3)
	// Si tiene telefono coloca el Código LDN a "1" por defecto
	If ( IsNull(ls_CodigoLDN) Or Trim(ls_CodigoLDN) = '' ) And   Len(los_NumTelefono) > 0 Then ls_CodigoLDN = '1'	
	IF IsNull(los_NumTelefono) Or Trim(los_NumTelefono)='' THEN  ls_CodigoLDN = ''
	
	//**********INICIO: 19/02/2018**********	
	If MID(TRIM(los_NumTelefono),1,1) = '9' AND LEN(TRIM(los_NumTelefono)) = 9 Then 
		ls_CodigoLDN = ''			
	End If
	//**********FIN: 19/02/2018**********
	
	los_Email=f_nonull_left(wf_limpiar(dw_source_04.GetitemString(lol_fila,'correoelectronico')), 50)
	If Not Pos(los_Email, '@') > 0 Then los_Email = '' // Si no tiene el arroba pasa vacio
	If Pos(los_Email, ' ') > 0 Then los_Email = '' // Si tiene espacio en blanco pasa vacio
		
	// Resetea las variables de direcciones
	los_TipoVia	= '';	los_NomVia = ''; los_NumVia = ''; los_Interior = ''; los_tipoZona = ''; los_NomZona = '';
   	los_Referencia = ''; los_CodUbigeo = ''; ls_Dir1Dpto = ''; ls_Dir1Manzana = ''; ls_Dir1Lote = ''; ls_Dir1Km = '';
   	ls_Dir1Block = ''; ls_Dir1Etapa = ''
	ls_Dir2TipoVia = ''; ls_Dir2NomVia = ''; ls_Dir2NroVia = ''; ls_Dir2Dpto = ''; ls_Dir2Interior = ''; ls_Dir2Manzana = '';
   	ls_Dir2Lote = ''; ls_Dir2Km = ''; ls_Dir2Block = ''; ls_Dir2Etapa = ''; ls_Dir2TipoZona = ''; ls_Dir2NomZona = '';
   	ls_Dir2Ref = ''; ls_Dir2Ubigeo = ''; ls_AsigEssalud = ''

	// Se obtienen los datos de domicilio del empleado (Sólo si está activo)
	IF dw_source04_dir.retrieve(lol_CodiPersona) <= 0 THEN
		ls_AsigEssalud = '1'
	END IF
	
	For lol_fila1 = 1 To Min(dw_source04_dir.rowcount(), 2) // Máximo 2 direcciones
		
		If los_TipoDocu <> '01' Then
	
		If lol_fila1 = 1 Then // Primera dirección
	
			los_TipoVia	    = f_nonull_left(wf_tipovia(dw_source04_dir.GetItemString(lol_fila1, 'pdttipocalle')), 2)
			los_NomVia	    = f_nonull_left(dw_source04_dir.GetItemString(lol_fila1, 'direccion'), 20)
			los_NumVia	    = f_nonull_left(dw_source04_dir.GetItemString(lol_fila1, 'numero'), 4)
			los_Interior    = f_nonull_left(dw_source04_dir.GetItemString(lol_fila1, 'interior'), 4)
			los_tipoZona    = f_nonull_left(wf_tipozona(dw_source04_dir.GetItemString(lol_fila1, 'pdttipozona')), 2)
			los_NomZona	    = f_nonull_left(dw_source04_dir.GetItemString(lol_fila1, 'pdtzona'), 20)
			los_Referencia	 = f_nonull_left(dw_source04_dir.GetItemString(lol_fila1, 'referenciasdireccion'), 40)
			los_CodUbigeo	 = f_nonull_left(dw_source04_dir.GetItemString(lol_fila1, 'ubigeo'), 6)
			ls_Dir1Dpto 	 = f_nonull_left(dw_source04_dir.GetItemString(lol_fila1, 'numdep'), 4)
			ls_Dir1Manzana  = f_nonull_left(dw_source04_dir.GetItemString(lol_fila1, 'manzana'), 4)	
			ls_Dir1Lote		 = f_nonull_left(dw_source04_dir.GetItemString(lol_fila1, 'lote'), 4)
			ls_Dir1Km		 = f_nonull_left(dw_source04_dir.GetItemString(lol_fila1, 'kilometro'), 4)
			ls_Dir1Block	 = f_nonull_left(dw_source04_dir.GetItemString(lol_fila1, 'block'), 4)
			ls_Dir1Etapa	 = f_nonull_left(dw_source04_dir.GetItemString(lol_fila1, 'etapa'), 4)
			
			IF (IsNull(los_TipoVia) OR Trim(los_TipoVia) = '')  AND Len(los_NomVia) > 0    THEN los_TipoVia='12'
			IF (IsNull(los_tipoZona) OR Trim(los_tipoZona) = '')  AND Len(los_NomZona) > 0    THEN los_tipoZona='12'
			IF (IsNull(los_NomVia) OR Trim(los_NomVia) = '')  AND Len(los_TipoVia) > 0    THEN los_TipoVia=''
			IF (IsNull(los_NomZona) OR Trim(los_NomZona) = '')  AND Len(los_tipoZona) > 0    THEN los_tipoZona=''
			
		Else // Segunda dirección
			
			ls_Dir2TipoVia	 = f_nonull_left(wf_tipovia(dw_source04_dir.GetItemString(lol_fila1, 'pdttipocalle')), 2)
			ls_Dir2NomVia	 = f_nonull_left(dw_source04_dir.GetItemString(lol_fila1, 'direccion'), 20)
			ls_Dir2NroVia	 = f_nonull_left(dw_source04_dir.GetItemString(lol_fila1, 'numero'), 4)
			ls_Dir2Dpto		 = f_nonull_left(dw_source04_dir.GetItemString(lol_fila1, 'numdep'), 4)
			ls_Dir2Interior = f_nonull_left(dw_source04_dir.GetItemString(lol_fila1, 'interior'), 4)
			ls_Dir2Manzana	 = f_nonull_left(dw_source04_dir.GetItemString(lol_fila1, 'manzana'), 4)
			ls_Dir2Lote		 = f_nonull_left(dw_source04_dir.GetItemString(lol_fila1, 'lote'), 4)
			ls_Dir2Km		 = f_nonull_left(dw_source04_dir.GetItemString(lol_fila1, 'kilometro'), 4)
			ls_Dir2Block	 = f_nonull_left(dw_source04_dir.GetItemString(lol_fila1, 'block'), 4)
			ls_Dir2Etapa	 = f_nonull_left(dw_source04_dir.GetItemString(lol_fila1, 'etapa'), 4)
			ls_Dir2TipoZona = f_nonull_left(wf_tipozona(dw_source04_dir.GetItemString(lol_fila1, 'pdttipozona')), 2)
			ls_Dir2NomZona  = f_nonull_left(dw_source04_dir.GetItemString(lol_fila1, 'pdtzona'), 20)
			ls_Dir2Ref		 = f_nonull_left(dw_source04_dir.GetItemString(lol_fila1, 'referenciasdireccion'), 40)
			ls_Dir2Ubigeo	 = f_nonull_left(dw_source04_dir.GetItemString(lol_fila1, 'ubigeo'), 6)
		
			IF (IsNull(ls_Dir2TipoVia) OR Trim(ls_Dir2TipoVia) = '')  AND Len(ls_Dir2NomVia) > 0    THEN ls_Dir2TipoVia='12'			
			IF (IsNull(ls_Dir2TipoZona) OR Trim(ls_Dir2TipoZona) = '')  AND Len(ls_Dir2NomZona) > 0    THEN ls_Dir2TipoZona='12'			
			IF (IsNull(ls_Dir2NomVia) OR Trim(ls_Dir2NomVia) = '')  AND Len(ls_Dir2TipoVia) > 0    THEN ls_Dir2TipoVia=''			
			IF (IsNull(ls_Dir2NomZona) OR Trim(ls_Dir2NomZona) = '')  AND Len(ls_Dir2TipoZona) > 0    THEN ls_Dir2TipoZona=''
			
		End If
		End If
					
		// Verifica si tiene activo el indicador de asignacion essalud
		If dw_source04_dir.GetItemString(lol_fila1, 'asignacionessalud') = 'S' Then 
			ls_AsigEssalud = String(lol_fila1)
		End If
	Next
	
	lol_ConPago=1
	If ls_IndFuente = 'S' Then	
		//Solo para las altas verifica que tenga pago en el periodo para registrarlo en el T-registro	
		lol_ConPago = f_verifica_pago_boleta(lol_CodiPersona, los_CodiPeriodo, '%' )
	End If
	
	If lol_ConPago > 0 Then
		lb_InsertaRegistro = True
	Else
		lb_InsertaRegistro = False
	End If
		
	If lb_InsertaRegistro Then
		// RQ 00047 Fin
		//Verifica si es pensionista y si esta con pension suspendida o Licencia (sin remuner. con vinc.lab)
		IF fw_verificaEstadoPensionista(lol_CodiPersona) = 0 THEN	
			//Si para carga inicial de personal nuevo-altas, no cargados en julio del 2011 por sunat
			//Verifica que el DNI del prestador no haya sido ya ingresado
			IF fw_verifica_existe_sunat( los_NumeDocu, '1' ) = 0 THEN
				DEBUGBREAK()
				INSERT INTO RTPS_AR4_T00                                                     		
				(TIPODOC, 			 NUMERODOC, 		APEPATERNO, 	   APEMATERNO,  		NOMBRES,
				 FECHANAC, 		    SEXO, 				NACIONALIDAD,     TELEFONO,  			EMAIL,  
				 ESSALUDVIDA,   	 DOMICILIADO,   	DOMTIPOVIA,   	   DOMNOMBREVIA,   	DOMNUMEROVIA,
				 DOMINTERIOR,   	 DOMTIPOZONA,   	DOMNOMZONA,   	   DOMREFERENCIA,   	DOMUBIGEO,
				 PERIODO,   		 COMPANIASOCIO,   TIPOINGRESO,      INDERROR,   		UltimoUsuario,
				 UltimaFechaModif, PAISEMISORDOC,   CODIGOLDN,        DOMDEPARTAMENTO,  DOMMANZANA, // RQ 00047 Inicio
				 DOMLOTE,          DOMKILOMETRO,    DOMBLOCK,         DOMETAPA,         DOMTIPOVIA2,
				 DOMNOMBREVIA2,    DOMNUMEROVIA2,   DOMDEPARTAMENTO2, DOMINTERIOR2,     DOMMANZANA2,
				 DOMLOTE2,         DOMKILOMETRO2,   DOMBLOCK2,        DOMETAPA2,        DOMTIPOZONA2,
				 DOMNOMZONA2,      DOMREFERENCIA2,  DOMUBIGEO2,       ASIGNACIONESSALUD // RQ 00047 Fin
				 ) 
				VALUES
				(:los_TipoDocu,	:los_NumeDocu,	  :los_ApelPate,	  :los_ApelMate,	  :los_Nombres,
				 :lodt_FecNaci,	:los_Sexo,		  :los_CodNacion,	  :los_NumTelefono, :los_Email,
				 :los_EssaVida,	:los_IndDomiciliado,	:los_TipoVia, :los_NomVia,		  :los_NumVia,
				 :los_Interior,	:los_tipoZona,	  :los_NomZona,	  :los_Referencia,  :los_CodUbigeo,
				 :iv$_periodo,		:los_CodiCia,		'A',					'N',				  :str_global.gv_userid,
				 :lodt_FecDelDia, :ls_PaisEmisor,  :ls_CodigoLDN,    :ls_Dir1Dpto,     :ls_Dir1Manzana, // RQ 00047 Inicio
				 :ls_Dir1Lote,    :ls_Dir1Km,      :ls_Dir1Block,    :ls_Dir1Etapa,    :ls_Dir2TipoVia,
				 :ls_Dir2NomVia,  :ls_Dir2NroVia,  :ls_Dir2Dpto,     :ls_Dir2Interior, :ls_Dir2Manzana,
				 :ls_Dir2Lote,    :ls_Dir2Km,      :ls_Dir2Block,    :ls_Dir2Etapa,    :ls_Dir2TipoZona,
				 :ls_Dir2NomZona, :ls_Dir2Ref,     :ls_Dir2Ubigeo,   :ls_AsigEssalud // RQ 00047 Fin
				 )USING SQLCA;
				
				if sqlca.sqlcode < 0 then
					los_message = sqlca.sqlerrtext
					Rollback;
					f_msg(los_message)
					Return -1
				end if
				
			END IF
		END IF
	End If
	
	uo_progress.uf_Set_Position( lol_fila / lol_filas * 100 )
	
Next 	

COMMIT;

uo_progress.uf_Set_Position(100)
uo_progress.uf_Check(TRUE)


Return 0
end function

public function integer wf_procesa_ar5 ();/*
----------------------------------------------------------------------------------------------------------------------------------------------------------
Objeto            : wf_procesa_ar5
Objetivo      		: Genera la data para el archivo T01
Autor             : PYOVERA
Fecha					: 13/01/2012
Nro. RQ				: ###
Parámetros Entrada: Ninguno
Parámetros Salida	:  0  ==> Función culminó satisfactóriamente
                    -1  ==> Función No culminó satisfactóriamente
Observación   		: Ninguna
----------------------------------------------------------------------------------------------------------------------------------------------------------
ModIficaciones
Nro. RQ		Fecha         Usuario        Descripción
----------------------------------------------------------------------------------------------------------------------------------------------------------
RQ 00047		11/07/2012	  JCOAGUILAP	  Agregar nuevos campos para T-Registro, modIficar la longitud del telefono y recuperar el correo electronico
----------------------------------------------------------------------------------------------------------------------------------------------------------
*/
String		los_CodiCia, los_CodiPeriodo,los_CodiPeriodoanterior,los_TipoDocu,los_NumeDocu,los_CodTipCont,los_TipoTrab,los_RegiLabo,los_NiveEduc,los_CodiOcup, &
			los_CodRegPen,los_IndiDiscPers,los_CodiCusp,los_FlgSctSld,los_FlgSctPen,los_FlgRegAlt,los_FlgJorMax,los_FlgHorNoc,los_OtroIngrQnta, los_FlgSindicato, &
			los_Periodicidad,los_AfilEps,los_CodCiaEps,los_SitEpsEmpl,los_FlgExoQta,los_SituEspe,los_TipoPago,los_EstaEmpl,los_AfiTuPens,los_CateOcup,los_EviDobTri,&
			los_AsistSocial, los_TipoPlanilla, los_TipoPension, los_CodiAfp, ls_PaisEmisor, ls_RUC, los_GradoSalario,los_Message, ls_IndAltaBaja, ls_IndIniActual,ls_IndUniPer, &
			ls_CasoModIfica, ls_Caso, ls_PeriAntPost,ls_IndPlanOtros, los_NiveEductmp,ls_IndFuente
Datetime lodt_FecIniPen,lodt_FechCese,lodt_FecIniPeriodo,lodt_FecFinPeriodo,lodt_FechLiqu,lodt_FecDelDia, lodt_nulo
Date 		lod_FecIniPeriodo,lod_FecFinPeriodo, lod_FechaIngresoBoleta
Long 		lol_fila,lol_filas,lol_CodiPersona, lol_MesInicio,lol_Anio, lol_VerIfica,lol_ConPago
Double  	ldb_SueldoPartidoSinGrado, ldb_RemBasicaInicial
Boolean	lb_InsertaRegistro

dw_filtro.accepttext( )

los_CodiCia 				=Left (iv$_CompaniaSocio,8)
los_CodiPeriodo 		= iv$_periodo+mid(iv$_periodo,5,2)
ls_IndAltaBaja 			= dw_filtro.object.ind_altabaja[1]
ls_IndIniActual 			= dw_filtro.object.ind_iniactual[1]
ls_CasoModIfica  		= dw_filtro.object.casomodyf[1]
ls_IndUniPer 			= dw_filtro.object.ind_unicoper[1]
lodt_FecIniPeriodo		= DateTime(Date('01/'+mid(iv$_periodo,5,2)+'/'+mid(iv$_periodo,1,4)))
lodt_FecDelDia 			= f_today()
lod_FecIniPeriodo		= Date(lodt_FecIniPeriodo)
lol_MesInicio 			= Month(lod_FecIniPeriodo)
lol_Anio 					= Year(lod_FecIniPeriodo)
ls_PeriAntPost 			= is_PeriAntePost + mid(is_PeriAntePost,5,2)
ls_IndPlanOtros			= dw_filtro.object.plani_otros[1]
ls_IndFuente			= dw_filtro.object.ind_origen[1]

//Evaluar si es una "modificacion" de afiliación a sindicato
if ls_IndAltaBaja = '2' AND ls_CasoModIfica = '06'  then
	wf_procesa_ar5_sindicalizado()
	return 0
End If

//rango inicial:
lod_FecIniPeriodo 		= Date(lol_Anio, lol_MesInicio, 1)
//rango final:
If lol_MesInicio < 12 Then
	lod_FecFinPeriodo = RelativeDate( Date(lol_Anio, lol_MesInicio+ 1, 1),  - 1)
Else 
	lod_FecFinPeriodo = RelativeDate( Date(lol_Anio + 1, 1, 1),  - 1)
End If
lodt_FecFinPeriodo	= DateTime(lod_FecFinPeriodo)

If IsNUll(ls_PeriAntPost) OR TRIM(ls_PeriAntPost)='' Then
	los_CodiPeriodoanterior=String(Long(iv$_periodo)-1)
	If Mid(los_CodiPeriodoanterior,5,2) ='00' 	Then 
		los_CodiPeriodoanterior=String(Long(iv$_periodo)-89)
	End If
	los_CodiPeriodoanterior		=los_CodiPeriodoanterior+mid(los_CodiPeriodoanterior,5,2)
Else
	los_CodiPeriodoanterior = ls_PeriAntPost
End If

If ls_IndUniPer = '1' Then //Solo el periodo actual
	los_CodiPeriodoanterior = los_CodiPeriodo
End If
If ls_IndPlanOtros = '1' Then
	ls_IndIniActual = 'T'
End If

dw_source_05.SetTransObject(SQLCA)
dw_source_05.retrieve(los_CodiCia,los_CodiPeriodo,los_CodiPeriodoanterior, ls_IndAltaBaja, ls_IndIniActual,ls_CasoModIfica)
lol_filas=dw_source_05.rowcount()

DELETE FROM RTPS_AR5_T01
WHERE PERIODO = :iv$_periodo
AND COMPANIASOCIO =:los_CodiCia
AND TIPOINGRESO='A'USING SQLCA;
If sqlca.sqlcode < 0 Then
	los_Message = sqlca.sqlerrtext
	Rollback;
	f_msg(los_Message)
	Return -1
End If
COMMIT;
	
uo_progress.uf_Set_Position(0)
uo_progress.uf_Check(FALSE)			

FOR lol_fila=1 TO lol_filas 
	
	SetNull(lodt_nulo)
	setnull(lodt_FechLiqu)
	
	los_TipoDocu		=	Right('00'+f_nonull_left(wf_tipodocumento(dw_source_05.GetitemString(lol_fila,'tipodocumento')), 2), 2) // RQ 00047 - Formato 00
	los_NumeDocu		=	f_nonull_left(dw_source_05.GetitemString(lol_fila,'documento'), 15)
	ls_PaisEmisor     	=  f_nonull_left(wf_paisemisor(dw_source_05.getItemString(lol_fila,'paisemisordocumento')), 3)
	los_TipoTrab		=	f_nonulo_str(wf_tipotrabajador(dw_source_05.GetitemString(lol_fila,'TipoTrabajador')))/*no se usa*/
	los_RegiLabo	 	=	Right('00'+f_nonull_left(dw_source_05.object.RegimenLaboral[lol_fila], 2),2)
	los_NiveEduc		=	f_nonull_left(dw_source_05.GetitemString(lol_fila,'niveleducativortps'), 2)	
	ls_RUC				=  f_nonull_left(dw_source_05.getItemString(lol_fila,'DocumentoFiscal'), 11)
	lol_CodiPersona	=	dw_source_05.getItemNumber(lol_fila,'persona')		

	los_TipoPlanilla 	=  f_nonulo_str(dw_source_05.GetitemString(lol_fila,'tipoplanilla'))
	los_GradoSalario 	=  f_nonulo_str(dw_source_05.GetitemString(lol_fila,'GradoSalarial'))
	ldb_SueldoPartidoSinGrado  = dw_source_05.GetItemDecimal(lol_fila,'SueldoPartidoSinGrado')
		
	//Nivel Educativo
	If los_TipoPlanilla = 'CO' Then
		//los_NiveEduc='13'
		If TRIM(los_NiveEduc)='' Then
			los_NiveEduc='13'
		End If
	Else
		/*temporal*/
		/*If los_NiveEduc > '12' Then
			SELECT MAX(I.TRSituacionEducativa)
			INTO		:los_NiveEductmp
			FROM HR_EmpleadoInstruccion I WHERE I.Empleado= :lol_CodiPersona AND I.TRSituacionEducativa IS NOT NULL
			AND I.TRInstEducativa IS NOT NULL AND I.TRCarrera IS NOT NULL Using Sqlca;
			
			If los_NiveEductmp > '12' Then
				los_NiveEduc = los_NiveEduc
			Else
				los_NiveEduc = '12'
			End If			
		End If
				
		If TRIM(los_NiveEduc)='' Then 			
			SELECT MAX(I.TRSituacionEducativa)
			INTO		:los_NiveEduc		
			FROM HR_EmpleadoInstruccion I WHERE I.Empleado= :lol_CodiPersona AND I.TRSituacionEducativa IS NOT NULL
			AND I.TRInstEducativa IS NOT NULL AND I.TRCarrera IS NOT NULL Using Sqlca;

			If sqlca.sqlcode < 0 Then
				los_NiveEduc=''
			End If			
		End If	*/
		If IsNull(los_NiveEduc) OR TRIM(los_NiveEduc)='' Then
			los_NiveEduc='12'
		End If
	End If
	//Ocupacion
	los_CodiOcup=f_nonulo_str(wf_ocupacion(dw_source_05.GetitemDecimal(lol_fila,'Ocupacion' )))
	If los_CodiOcup='' Then
		los_CodiOcup = '999001'
	End If 
	//Discapacidad
	los_IndiDiscPers	=	f_nonull_left(dw_source_05.getItemString(lol_fila,'flagdiscapacidad'), 1)
	//Regimen Pensionario
	los_TipoPension	= f_nonull_left(dw_source_05.GetitemString(lol_fila,'tipopension'), 2)
	los_CodiCusp		= f_nonull_left(dw_source_05.getItemString(lol_fila,'numeroafp'),12)
	//Tipo Contrato
	los_CodTipCont=f_nonull_left(wf_tipocontrato(dw_source_05.GetitemString(lol_fila,'tipocontrato')), 2)
	//Sindicalizado
	los_FlgSindicato = fw_sindicalizado( los_CodiPeriodo, lol_CodiPersona )
	/*Remuneracion Basica Inicial*/
	If los_TipoPlanilla = 'EM'  OR  los_TipoPlanilla = 'CA' Then
		If ldb_SueldoPartidoSinGrado > 0 Then
			ldb_RemBasicaInicial = ldb_SueldoPartidoSinGrado 
		Else
			ldb_RemBasicaInicial = fw_RemBasicaInicial(los_GradoSalario, los_TipoPlanilla, lol_CodiPersona)
		End If			
	Else
		fw_RemBasicaInicial(los_GradoSalario, los_TipoPlanilla, lol_CodiPersona)
	End If

	//Situacion del Empleado
	los_EstaEmpl	=dw_source_05.getItemString(lol_fila,'estadoempleado')
	If los_EstaEmpl = '0' Then los_EstaEmpl='1'

	If ls_CasoModIfica = '98' Then
		los_EstaEmpl = '2'
	End If
	If ls_CasoModIfica = '99' Then
		los_EstaEmpl = fw_estado_pago_pEndiente(los_NumeDocu, lodt_FecIniPeriodo, lodt_FecFinPeriodo,ls_CasoModIfica)
	End If

	
	los_SitEpsEmpl = fw_SituacionEmpleado(los_EstaEmpl)
			
	los_FlgSctPen		=f_nonulo_str(dw_source_05.getItemString(lol_fila,'flagsctrpension'))	
	los_FlgRegAlt		=f_nonulo_str(dw_source_05.getItemString(lol_fila,'Flagregimenalternativo'))
	los_FlgJorMax		=f_nonulo_str(dw_source_05.getItemString(lol_fila,'flagjornadamaxima'))
	los_FlgHorNoc		=f_nonulo_str(dw_source_05.getItemString(lol_fila,'flaghorarionocturno'))		
	los_Periodicidad	=f_nonulo_str(dw_source_05.GetitemString(lol_fila,'periodicidad'))
	los_FlgExoQta		=f_nonulo_str(dw_source_05.getItemString(lol_fila,'flagquintaexonerada'))
	los_SituEspe		=f_nonulo_str(dw_source_05.getItemString(lol_fila,'situacionespecial'))
	los_TipoPago		=f_nonulo_str(wf_tipopago(dw_source_05.getItemString(lol_fila,'tipopago')))
	los_CateOcup		=fw_CategoriaOcupacional( f_nonulo_str(dw_source_05.getItemString(lol_fila,'categoria')) )		
	los_EviDobTri		=f_nonulo_str(dw_source_05.getItemString(lol_fila,'EvitDobleTributa'))
	
	If ls_CasoModIfica = '98' OR ls_CasoModIfica = '99' Then
		SetNull(los_TipoTrab);			SetNull(los_RegiLabo); 		SetNull(los_NiveEduc); 			SetNull(los_CodiOcup);			
		SetNull(los_IndiDiscPers);		SetNull(los_CodRegPen);		SetNull(lodt_FecIniPen); 			SetNull(los_CodiCusp);			
		SetNull(los_FlgSctSld);			SetNull(los_FlgSctPen);		SetNull(los_CodTipCont);		SetNull(los_FlgRegAlt); 		
		SetNull(los_FlgJorMax); 			SetNull(los_FlgHorNoc);		SetNull(los_OtroIngrQnta);		SetNull(los_FlgSindicato); 	
		SetNull(los_Periodicidad); 		SetNull(los_Periodicidad);	SetNull(los_AfilEps);				SetNull(los_CodCiaEps); 		
		SetNull(los_FlgExoQta);			SetNull(los_SituEspe);		SetNull(los_TipoPago); 			SetNull(los_AfiTuPens); 		
		SetNull(los_CateOcup); 			SetNull(los_EviDobTri);		SetNull(ldb_RemBasicaInicial);	SetNull(ls_RUC);		
	End If
	
	If los_FlgSctPen <> '1' Then
		los_FlgSctPen=''
	End If
		
	//SE AGREGO PARA LOS PEndIENTES POR LIQUIDAR
	If ls_CasoModIfica = '99'  AND los_EstaEmpl = 'NO' Then
		lol_VerIfica = 0
	End If
	If ls_CasoModIfica = '99'  AND los_EstaEmpl = '4' Then
		lol_VerIfica = 1
	End If
	If ls_CasoModIfica = '98'  AND los_EstaEmpl = '2' Then
		lol_VerIfica = 1
	End If	
	
	//Solo aplica para ALTAS
	
	//Validamos que este cargado en T00 del periodo
	lol_VerIfica		= 0
	lol_ConPago		= 1
	
	If ls_IndAltaBaja = '1'  Then
		SELECT	COUNT(1)	INTO :lol_VerIfica
		FROM		RTPS_AR4_T00	WITH(NoLock)
		WHERE	Periodo=	:iv$_periodo AND	TIPODOC	=:los_TipoDocu AND NumeroDoc=	:los_NumeDocu	Using SQLCA;	
		
		If sqlca.sqlcode < 0 Then
			lol_VerIfica=0
		End If
		//Solo si se indica que se incluya a las altas procesadas en la Planila del Mes	
		If ls_IndFuente = 'S' Then				
			lol_ConPago = f_verIfica_pago_boleta(lol_CodiPersona, los_CodiPeriodo, '%' )
		End If
	Else
		lol_VerIfica = fw_verIfica_existe_sunat( los_NumeDocu, ls_IndIniActual )
	End If

	If lol_ConPago > 0 Then
		lb_InsertaRegistro = True
	Else
		lb_InsertaRegistro = False
	End If
	
	If	lol_VerIfica > 0 Then	
		If lb_InsertaRegistro Then

		INSERT INTO RTPS_AR5_T01
		(
			TIPODOC,			NUMERODOC,		TIPOTRABAJADOR,		REGIMEN,				NIVELEDUCATIVO,
			OCUPACION,		DISCAPACIDAD,	REGPENSION,				FECHAREGPENSION,	CUSPP,
			SCTRSALUD,		SCTRPENSION,	TIPOCONTRATO,			INDATIPICO,			INDJORNADAMAXIMA	,
			INDNOCTURNO,	INDOTROS5TA,	SINDICALIZADO,			PERIOCIDAD,			INDAFILEPS	,
			CODEPS,			SITEPS,			INDRENTAEXON,			INDSITESPECIAL,	TIPOPAGO,
			AFITUPENSION,	CATEOCUPACION,	EVITDOBLETRIBUTA,		PERIODO,				COMPANIASOCIO,
			TIPOINGRESO,	INDERROR,		ULTIMOUSUARIOGENER,	ULTIMAFECHAGENER, PAISEMISORDOC,	// RQ 00047 Inicio
			RUC,           REMUNERACION   ) // RQ 00047 Fin
		VALUES
		(	:los_TipoDocu,		:los_NumeDocu,			:los_TipoTrab,				:los_RegiLabo,			:los_NiveEduc,
			:los_CodiOcup,		:los_IndiDiscPers,	:los_CodRegPen,			:lodt_FecIniPen,		:los_CodiCusp,
			:los_FlgSctSld,	:los_FlgSctPen,		:los_CodTipCont,			:los_FlgRegAlt,		:los_FlgJorMax,
			:los_FlgHorNoc,	:los_OtroIngrQnta,	:los_FlgSindicato,		:los_Periodicidad,	:los_AfilEps,
			:los_CodCiaEps,	:los_SitEpsEmpl,		:los_FlgExoQta,			:los_SituEspe,			:los_TipoPago, 
			:los_AfiTuPens,	:los_CateOcup,			:los_EviDobTri,			:iv$_periodo,			:los_CodiCia,
			'A',					'N',						:str_global.gv_userid,	:lodt_FecDelDia, 		:ls_PaisEmisor, // RQ 00047 Inicio
			:ls_RUC,				:ldb_RemBasicaInicial	) // RQ 00047 Fin
		USING SQLCA;		
		If sqlca.sqlcode < 0 Then
			los_Message = sqlca.sqlerrtext
			Rollback;
			f_msg(los_Message)
			Return -1
		End If
		End If
	End If
	
	uo_progress.uf_Set_Position( lol_fila / lol_filas * 100 )
	
NEXT	

COMMIT;

uo_progress.uf_Set_Position(100)
uo_progress.uf_Check(TRUE)

Return 0
end function

public function integer wf_procesa_ar6 ();/*
------------------------------------------------------------------------------------------------------
Objeto					: wf_procesa_ar6
Objetivo					: Procesa la información del archivo 6
Autor						: 
Fecha						: 
Nro. RQ					: 
Parámetros Entrada	: Ninguno
Parámetros Salida		: Ninguno
Observación				: Ninguno
------------------------------------------------------------------------------------------------------
Modificaciones
Nro. RQ		Fecha			Usuario			Descripción
------------------------------------------------------------------------------------------------------
RQ 00047		08/08/2012	JCOAGUILAP		Actualiza el tipo de archivo. Agregar campo pais emisor
------------------------------------------------------------------------------------------------------
*/
String		los_CodiCia, los_tipodocu,los_numdocu,los_tipotra, los_regpen,los_cuspp, los_siteps,los_tippago,los_estadoempleado, &
			ls_IndIniActual, ls_IndUniPer,  los_CodiPeriodo,los_CodiPeriodoanterior,los_Message, ls_PaisEmisor, ls_IndAltaBaja, ls_PeriAntPost
Datetime ldt_fecins,ldt_periodo,ldt_feccese,ldt_finperiodo,ldt_fecliq,ldt_fechoy
Date 		ld_FecInicio,ld_FecFin
Long 		ll_fila,ll_rowcount,ll_persona,lv_mes,lv_anio,lol_existe

is_TipoEmpleado = 'PE'

dw_filtro.accepttext( )

los_CodiCia 			= left (iv$_CompaniaSocio,8) 
los_CodiPeriodo 	= iv$_periodo+mid(iv$_periodo,5,2)
ls_IndAltaBaja 		= dw_filtro.object.ind_altabaja[1]
ls_IndIniActual 		= dw_filtro.object.ind_iniactual[1]
ls_IndUniPer 		= dw_filtro.object.ind_unicoper[1]
ls_PeriAntPost 			= is_PeriAntePost + mid(is_PeriAntePost,5,2)

ldt_periodo=DateTime(Date('01/'+mid(iv$_periodo,5,2)+'/'+mid(iv$_periodo,1,4)))
ld_FecInicio=Date(ldt_periodo)

lv_mes = Month(ld_FecInicio)
lv_anio = Year(ld_FecInicio)
//rango inicial:
ld_FecInicio = Date(lv_anio, lv_mes, 1)

//rango final:
IF lv_mes < 12 THEN
	ld_FecFin = RelativeDate( Date(lv_anio, lv_mes+ 1, 1),  - 1)
ELSE
	ld_FecFin = RelativeDate( Date(lv_anio + 1, 1, 1),  - 1)
END IF

ldt_finperiodo=DateTime(ld_FecFin)

IF IsNUll(ls_PeriAntPost) OR TRIM(ls_PeriAntPost)='' THEN
	los_CodiPeriodoanterior=String(Long(iv$_periodo)-1)
	if Mid(los_CodiPeriodoanterior,5,2) ='00' 	then 
		los_CodiPeriodoanterior=String(Long(iv$_periodo)-89)
	end if
	los_CodiPeriodoanterior		=los_CodiPeriodoanterior+mid(los_CodiPeriodoanterior,5,2)
ELSE
	los_CodiPeriodoanterior = ls_PeriAntPost
END IF

IF ls_IndUniPer = '1' Then //Solo el periodo actual
	los_CodiPeriodoanterior = los_CodiPeriodo
END IF

dw_source_06.SetTransObject(SQLCA)
dw_source_06.retrieve(los_CodiCia,los_CodiPeriodo,los_CodiPeriodoanterior,ls_IndAltaBaja,ls_IndIniActual)
ll_rowcount=dw_source_06.rowcount()

DELETE FROM RTPS_AR6_T02
WHERE PERIODO = :iv$_periodo
AND COMPANIASOCIO =:los_CodiCia
AND TIPOINGRESO='A'
USING SQLCA;

if sqlca.sqlcode < 0 then
	los_Message = sqlca.sqlerrtext
	rollback;
	f_msg(los_Message)
	return -1
end if
		
COMMIT;

uo_progress.uf_Set_Position(0)
uo_progress.uf_Check(FALSE)	

ldt_fechoy = f_today()

For ll_fila=1 to ll_rowcount 
	ll_persona			=dw_source_06.getItemNumber(ll_fila,'persona')	
	los_tipodocu			=Right('00'+f_nonull_left(wf_tipodocumento(dw_source_06.GetitemString(ll_fila,'tipodocumento')), 2), 2) // RQ 00047 - Formato 00
	los_numdocu		=f_nonulo_str(dw_source_06.GetitemString(ll_fila,'documento'))
	los_tipotra			=f_nonulo_str(wf_tipotrabajador(dw_source_06.GetitemString(ll_fila,'tipotrabajador')))
	los_regpen			=f_nonulo_str(wf_regimenpensionario(dw_source_06.GetitemString(ll_fila,'tipopension'),dw_source_06.GetitemString(ll_fila,'codigoafp')))
	ldt_fecins			=dw_source_06.getItemDateTime(ll_fila,'fechainiciopension')
	los_cuspp			=f_nonulo_str(dw_source_06.getItemString(ll_fila,'numeroafp'))	
	los_estadoempleado=dw_source_06.getItemString(ll_fila,'estadoempleado')
	ldt_feccese			=wf_FechaCese(ll_persona,dw_source_06.getItemDateTime(ll_fila,'fechacese'),ldt_periodo, ldt_finperiodo)

	IF ls_IndAltaBaja = '0' THEN
		setnull(ldt_fecliq)		
		ldt_fecliq					=wf_fechaliquidacion(ll_persona)
		los_estadoempleado 	= wf_EstadoEmpleado(ll_persona,los_estadoempleado,los_CodiPeriodo, ldt_feccese,ldt_fecliq, ldt_periodo, ldt_finperiodo)
	END IF
	//Solo para pensionistas en estado Sin remuneracion Con Vinculo Laboral, se les considera como cesados
	if los_estadoempleado = '3' then los_estadoempleado='2'
	
	los_siteps		=f_nonulo_str(wf_situacioneps(dw_source_06.GetitemString(ll_fila,'tipoasistenciasocial'),los_estadoempleado))
	los_tippago		=f_nonulo_str(wf_tipopago(dw_source_06.getItemString(ll_fila,'tipopago')))
	ls_PaisEmisor 	= f_nonull_left(wf_paisemisor(dw_source_06.getItemString(ll_fila,'paisemisordocumento')), 3) // RQ 00047
	
	//Verifica si es pensionista y si esta con licencia o sin remuner. con vinc.lab
	IF fw_verificaEstadoPensionista(ll_persona) = 0 THEN	
		
		//If para carga inicial de personal nuevo-altas, no cargados en julio del 2011 por sunat
		IF fw_verifica_existe_sunat( los_numdocu, '1' ) = 0 THEN
					
			INSERT INTO RTPS_AR6_T02
			(
				TIPODOC	,		NUMERODOC	,
				TIPOPENSIONISTA	,		REGPENSION	,
				FECHAREGPENSION	,		CUSPP	,
				SITEPS	,		TIPOPAGO	,
				PERIODO	,		COMPANIASOCIO	,
				TIPOINGRESO	,		INDERROR	,
				ULTIMOUSUARIOGENER	,		ULTIMAFECHAGENER,
				PAISEMISORDOC // RQ 00047
			) 
			VALUES
			(
				:los_tipodocu,:los_numdocu,
				:los_tipotra,:los_regpen,:ldt_fecins,
				:los_cuspp,:los_siteps,
				:los_tippago,
				:iv$_periodo,:los_CodiCia,'A','N',
				:str_global.gv_userid,:ldt_fechoy,
				:ls_PaisEmisor // RQ 00047
			)
			USING SQLCA;
	
		END IF
	END IF	
	uo_progress.uf_Set_Position( ll_fila / ll_rowcount * 100 )
	
	if sqlca.sqlcode < 0 then
		los_Message = sqlca.sqlerrtext
		rollback;
		f_msg(los_Message)
		return -1
	end if
		
Next

COMMIT;

//Se depura aquellos pensionistas que reciben pension x viudez y jubilacioin
wf_depurapensionista(los_CodiPeriodo,'PEN') // RQ 00047
COMMIT USING SQLCA;

RETURN 0
end function

public function integer wf_procesa_ar7 ();/*
------------------------------------------------------------------------------------------------------
Objeto					: wf_procesa_ar7
Objetivo					: Procesa la información del archivo 7
Autor						: 
Fecha						: 
Nro. RQ					: 
Parámetros Entrada	: Ninguno
Parámetros Salida		: Ninguno
Observación				: Ninguno
------------------------------------------------------------------------------------------------------
Modificaciones
Nro. RQ		Fecha			Usuario			Descripción
------------------------------------------------------------------------------------------------------
RQ 00047		15/08/2012	JCOAGUILAP		Actualiza estructura el archivo
------------------------------------------------------------------------------------------------------
*/

String 		ls_CodiCia,ls_periodo, ls_tipodoc,ls_NumeDocu,ls_Ruc, ls_EvitaDobleTributa,ls_apepat, ls_apemat, ls_nombres, ls_domiciliado, ls_Message,ls_IndLogistica
Long 			ll_fila,ll_rowcount
DateTime 	ldt_hoy

dw_filtro.accepttext( )

ls_IndLogistica = dw_filtro.object.ind_logistica[1]

ls_periodo =iv$_periodo+mid(iv$_periodo,5,2)
ls_CodiCia =left (iv$_CompaniaSocio,8) 

IF ls_IndLogistica = '1' THEN
	dw_source_07.dataOBject="dw_pe_procesa_ar7_ps4_log"
	dw_source_07.SetTransObject(SQLCA)
	dw_source_07.retrieve(Left(ls_CodiCia,6),Left(ls_periodo,6))
ELSE
	dw_source_07.dataOBject="dw_pe_procesa_ar7_ps4"
	dw_source_07.SetTransObject(SQLCA)
	dw_source_07.retrieve(ls_CodiCia,ls_periodo)
END IF


ll_rowcount=dw_source_07.rowcount()

DELETE FROM RTPS_AR7_T03
WHERE PERIODO = :iv$_periodo
AND COMPANIASOCIO =:ls_CodiCia
AND TIPOINGRESO='A'
USING SQLCA;

if sqlca.sqlcode < 0 then

	ls_Message = sqlca.sqlerrtext
	rollback;
	f_msg(ls_Message)
	return -1
end if		

COMMIT;
uo_progress.uf_Set_Position(0)
uo_progress.uf_Check(FALSE)	

ldt_hoy = f_today()


For ll_fila=1 to ll_rowcount
	ls_domiciliado = f_nonull_left(dw_source_07.GetitemString(ll_fila,'flagdomiciliado'), 1)
	ls_Ruc = f_nonull_left(dw_source_07.GetitemString(ll_fila,'documentofiscal'), 11)
	If ls_domiciliado = '1' Then
		ls_tipodoc = '06' // Tipo de documento RUC
		ls_NumeDocu = ls_Ruc
	Else
		ls_tipodoc = Right('00'+f_nonull_left(wf_tipodocumento(dw_source_07.GetitemString(ll_fila,'tipodocumento')), 2), 2)
		ls_NumeDocu = f_nonull_left(dw_source_07.GetitemString(ll_fila,'documento'), 15)	
	End If
	ls_apepat = f_nonull_left(dw_source_07.GetitemString(ll_fila,'apellidopaterno'), 40)
	ls_apemat = f_nonull_left(dw_source_07.GetitemString(ll_fila,'apellidomaterno'), 40)
	ls_nombres = f_nonull_left(dw_source_07.GetitemString(ll_fila,'nombres'), 40)
	ls_EvitaDobleTributa=f_nonull_left(dw_source_07.getItemString(ll_fila,'EVITDOBLETRIBUTA'), 1)

	INSERT INTO RTPS_AR7_T03
	(
		TIPODOC,
		NUMERODOC,
		APELLIDOPATERNO,
		APELLIDOMATERNO,
		NOMBRES,
		FLAGDOMICILIADO,
		RUCPRESTADOR,
		EVITDOBLETRIBUTA,
		PERIODO,
		COMPANIASOCIO, 
		TIPOINGRESO,
		INDERROR,
		UltimoUsuario,
		UltimaFechaModif
	) 
	VALUES
	(:ls_tipodoc,:ls_NumeDocu,
	:ls_apepat,
	:ls_apemat,
	:ls_nombres,
	:ls_domiciliado,
	:ls_Ruc,
	:ls_EvitaDobleTributa,
	:iv$_periodo,:ls_CodiCia,'A','N',
	:str_global.gv_userid,:str_global.gv_today)
	USING SQLCA;

	uo_progress.uf_Set_Position( ll_fila / ll_rowcount * 100 )
	
	if sqlca.sqlcode < 0 then
		ls_Message = sqlca.sqlerrtext
		rollback;
		f_msg(ls_Message)
		return -1
	end if
	
Next 	

COMMIT;


RETURN 0
end function

public function integer wf_procesa_ar8 ();long w%_fila,w%_rowcount
string W$_COMPANY,w$_periodo
string w$_tipodoc,w$_numdoc,w$_solicitud,w$_ejercicio,w$_medio
Datetime w%_fecini,w%_fecfin,w%_fecpres
 
w$_periodo =iv$_periodo+mid(iv$_periodo,5,2)
w$_company =left (iv$_CompaniaSocio,8) 
dw_source_08.SetTransObject(SQLCA)
dw_source_08.retrieve(w$_company,iv$_periodo)
w%_rowcount=dw_source_08.rowcount()

DELETE FROM RTPS_AR8_S00
WHERE PERIODO = :iv$_periodo
AND COMPANIASOCIO =:W$_COMPANY
AND TIPOINGRESO='A'
USING SQLCA;

COMMIT;

For w%_fila=1 to w%_rowcount 
	if 	dw_source_08.GetitemString(w%_fila,1)<>'6' then
		  w$_tipodoc=f_nonulo_str(wf_tipodocumento(dw_source_08.GetitemString(w%_fila,1)))
  else
		w$_tipodoc='6'
	 end if		
	w$_numdoc=f_nonulo_str(dw_source_08.GetitemString(w%_fila,2))
	w$_solicitud=dw_source_08.GetitemString(w%_fila,3)
	w%_fecpres=dw_source_08.GetitemDatetime(w%_fila,4)
	w$_ejercicio=mid(dw_source_08.Getitemstring(w%_fila,5),1,4)
	if dw_source_08.GetitemString(w%_fila,6) ='I' then
		w$_medio='1'
	else
		w$_medio='2'
	end if	
	
	INSERT INTO RTPS_AR8_S00
	(TIPODOC,
	NUMERODOC,
	NUMOPESUSP,
	FECPRESENTSUSP,
	EJERCICIOSUSP,
	MEDIOPRESENT,
	  PERIODO,
	  COMPANIASOCIO, 
	  TIPOINGRESO,
	  INDERROR,
	  UltimoUsuario,
	  UltimaFechaModif
) 
	VALUES
	(:w$_tipodoc,:w$_numdoc,:w$_solicitud,:w%_fecpres,:w$_ejercicio,:w$_medio,
	:iv$_periodo,:w$_company,'A','N',
	:str_global.gv_userid,:str_global.gv_today)
	USING SQLCA;
	
Next 	
	
COMMIT;


RETURN 0
end function

public function integer wf_procesa_ar11 ();/*
------------------------------------------------------------------------------------------------------
Objeto					: wf_procesa_ar11
Objetivo					: Procesa la información del archivo 11
Autor						: 
Fecha						: 
Nro. RQ					: 
Parámetros Entrada	: Ninguno
Parámetros Salida		: Ninguno
Observación				: Ninguno
------------------------------------------------------------------------------------------------------
Modificaciones
Nro. RQ		Fecha			Usuario			Descripción
------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------
*/
String 		ls_company,ls_periodo, ls_estado,ls_periodoanterior,ls_periodocese, ls_tipodoc,ls_numdoc,ls_categoria,  ls_TipoModForm, &
				ls_PaisEmisor, ls_TipoRegistro, ls_Indicador, ls_CodigoEPS, ls_CodigoAFP, ls_IndAltaBaja, ls_IndIniActual, ls_TipoPrestador, &
				ls_CasoModifica , ls_IndUniPer, ls_PeriAntPost, ls_IndPlanOtros,ls_IndFuente
Datetime 	ldt_fechaingreso, ldt_fechacese, ldt_fechanull,ldt_periodo,ldt_finperiodo,ldt_fecliq
DateTime 	ldt_FecHoy
Date 			ld_FecInicio,ld_FecFin
Long	 		ll_fila,ll_rowcount,ll_persona,ll_mes,ll_anio, ll_existe,lol_ConPago
Boolean		lb_InsertaRegistro

dw_filtro.accepttext( )
setnull(ldt_fechanull)

ls_IndAltaBaja 		= dw_filtro.object.ind_altabaja[1]
ls_IndIniActual 		= dw_filtro.object.ind_iniactual[1]
ls_TipoPrestador 	= dw_filtro.object.tipoprestador[1]
ls_CasoModifica  	= dw_filtro.object.casomodyf[1]
ls_IndUniPer 		= dw_filtro.object.ind_unicoper[1]
ls_PeriAntPost 		= is_PeriAntePost + mid(is_PeriAntePost,5,2)
ls_IndPlanOtros		= dw_filtro.object.plani_otros[1]
ls_IndFuente		= dw_filtro.object.ind_origen[1]

ldt_periodo	=DateTime(Date('01/'+mid(iv$_periodo,5,2)+'/'+mid(iv$_periodo,1,4)))
ld_FecInicio	=Date(ldt_periodo)
ll_mes 		= Month(ld_FecInicio)
ll_anio 		= Year(ld_FecInicio)

//rango inicial:
ld_FecInicio = Date(ll_anio, ll_mes, 1)
//rango final:
IF ll_mes < 12 THEN
	ld_FecFin = RelativeDate( Date(ll_anio, ll_mes+ 1, 1),  - 1)
ELSE
	ld_FecFin = RelativeDate( Date(ll_anio + 1, 1, 1),  - 1)
END IF
ldt_finperiodo=DateTime(ld_FecFin)

ls_periodo 			=iv$_periodo+mid(iv$_periodo,5,2)
ls_company 			=left (iv$_CompaniaSocio,8) 

IF IsNUll(ls_PeriAntPost) OR TRIM(ls_PeriAntPost)='' THEN
	ls_periodoanterior=String(Long(iv$_periodo)-1)
	if Mid(ls_periodoanterior,5,2) ='00' 	then 
		ls_periodoanterior=String(Long(iv$_periodo)-89)
	end if
	ls_periodoanterior		=ls_periodoanterior+mid(ls_periodoanterior,5,2)
ELSE
	ls_periodoanterior = ls_PeriAntPost
END IF

IF ls_IndUniPer = '1' Then //Solo el periodo actual
	ls_periodoanterior = ls_periodo
END IF
IF ls_IndPlanOtros = '1' THEN
	ls_IndIniActual = 'T'
END IF

dw_source_11.SetTransObject(SQLCA)
dw_source_11.retrieve(ls_company, ls_periodo, ls_periodoanterior, ls_IndAltaBaja, ls_IndIniActual, ls_CasoModifica)
ll_rowcount=dw_source_11.rowcount()

DELETE FROM RTPS_AR11_P00
WHERE PERIODO = :iv$_periodo
AND COMPANIASOCIO =:ls_company
AND TIPOINGRESO='A'
USING SQLCA;

if sqlca.sqlcode < 0 then
	string w$_msg
	w$_msg = sqlca.sqlerrtext
	rollback;
	f_msg(w$_msg)
	return -1
end if

COMMIT;
	
uo_progress.uf_Set_Position(0)
uo_progress.uf_Check(FALSE)							

ldt_FecHoy = f_today()

For ll_fila=1 to ll_rowcount 
			
	ls_tipodoc			=Right('00'+f_nonull_left(wf_tipodocumento(dw_source_11.GetitemString(ll_fila,'tipodocumento')), 2), 2) 
	ls_numdoc			=f_nonulo_str(dw_source_11.GetitemString(ll_fila,'documento'))		
	ls_PaisEmisor 		=f_nonull_left(wf_paisemisor(dw_source_11.getItemString(ll_fila,'paisemisordocumento')), 3)
	ls_categoria			=dw_source_11.GetitemString(ll_fila,'categoriatrabajador')			
	ls_TipoRegistro		=dw_source_11.getItemString(ll_fila,'tiporegistro')
	
	ldt_fechaingreso	=dw_source_11.object.FechaInicio[ll_fila]  
	ldt_fechacese		=dw_source_11.object.FechaFin[ll_fila]
	ls_Indicador 		=f_nonulo_str(dw_source_11.GetitemString(ll_fila,'indicador'))
	ls_CodigoEPS 		=f_nonulo_str(dw_source_11.GetitemString(ll_fila,'codigoeps'))
	ls_CodigoAFP 		=f_nonulo_str(dw_source_11.GetitemString(ll_fila,'codigoafp'))
	
	ll_persona			=dw_source_11.getItemNumber(ll_fila,"persona")
	ls_estado			=f_nonulo_str(dw_source_11.GetitemString(ll_fila,'estadoempleado'))	
	ldt_fecliq				=wf_fechaliquidacion(ll_persona)

	IF ls_categoria='6' THEN ls_categoria='1'
	
	Choose Case ls_IndAltaBaja
		Case '0' //Baja
			SetNull(ldt_fechaingreso)	
			ls_estado 	= fw_bajaempleado(ll_persona,ls_numdoc,ls_periodo, ldt_fechacese, ldt_periodo, ldt_finperiodo)
			IF ls_estado <> 'NO' THEN
				Choose Case ls_TipoRegistro
					Case '1'
						Choose Case ls_IndIniActual
							Case '0' // Inicial
								ls_Indicador=wf_motivocese(Long(Trim(dw_source_11.GetitemString(ll_fila,'indicador'))))						
								if IsNull(ls_Indicador) then
									ls_Indicador='07'
								end if
							Case '1' //Actual
								IF isNull(ldt_fechacese)    THEN
									ldt_fechacese=wf_FechaCese(ll_persona,ldt_fechacese,ldt_periodo, ldt_finperiodo)
								END IF
								If ls_estado='2' Or ls_estado='4' Then
									ls_Indicador=wf_motivocese(Long(Trim(dw_source_11.GetitemString(ll_fila,'indicador'))))						
									if IsNull(ls_Indicador) then
										ls_Indicador='07'
									end if
								End If	
						End Choose							
					Case '2'
						IF isNull(ldt_fechacese) THEN
							ldt_fechacese=wf_FechaCese(ll_persona,ldt_fechacese,ldt_periodo, ldt_finperiodo)
						END IF
					Case '3'
						If ls_Indicador = '01' Then // Si tiene EPS
							ls_CodigoEPS = f_nonulo_str(dw_source_11.GetitemString(ll_fila,'codigoeps'))
						Else
							ls_CodigoEPS = ''	
						End If
					Case '4'
						ls_Indicador = f_nonull_left(wf_regimen_pensionario(ls_Indicador,ls_CodigoAFP,ldt_fechaingreso,ll_persona,ls_periodo), 2)
						If ls_Indicador = '99' Then // Sin regimen
							ldt_fechacese = ldt_fechanull
						End If
				End Choose	
			END IF
		Case '1'//Alta
			SetNull(ldt_fechacese)
			Choose Case ls_TipoRegistro
				Case '1'
					IF IsNull(ldt_fechaingreso) THEN
						ldt_fechaingreso=wf_fechaingresoperiodo(ll_persona,ls_periodo,ldt_fechacese,ls_estado)	
					END IF					
				Case '2'
					IF IsNull(ldt_fechaingreso) THEN
						ldt_fechaingreso=wf_fechaingresoperiodo(ll_persona,ls_periodo,ldt_fechacese,ls_estado)	
					END IF
				Case '3'
					If ls_Indicador = '01' Then // Si tiene EPS
						ls_CodigoEPS = f_nonulo_str(dw_source_11.GetitemString(ll_fila,'codigoeps'))
					Else
						ls_CodigoEPS = ''	
					End If
				Case '4'	
					ls_Indicador = f_nonull_left(wf_regimenpensionario(ls_Indicador,ls_CodigoAFP), 2)
					If ls_Indicador = '99' Then // Sin regimen
						ldt_fechaingreso = ldt_fechanull
						ldt_fechacese = ldt_fechanull
					End If
			End Choose
		Case '2' //Modificaciones			
			Choose Case ls_TipoRegistro
				Case '1'	
					IF ls_CasoModifica = '99' THEN
						ls_estado = fw_estado_pago_pendiente(ls_numdoc, ldt_periodo, ldt_finperiodo,ls_CasoModifica)											
					END IF
				Case '2'
					SetNull(ldt_fechacese)	
					IF ls_CasoModifica = '04' OR ls_CasoModifica = '05' OR ls_CasoModifica = '06' THEN
						SetNull(ldt_fechaingreso)
					END IF	
					IF ls_CasoModifica = '98' THEN
						SetNull(ldt_fechaingreso)
					END IF
					IF ls_CasoModifica = '99' THEN
						//SetNull(ldt_fechaingreso)
						ls_estado = fw_estado_pago_pendiente(ls_numdoc, ldt_periodo, ldt_finperiodo,ls_CasoModifica)											
					END IF
				Case '3'
				Case '4'	
			End Choose
	End Choose
	if ls_categoria='5' then
		ls_TipoModForm = dw_source_11.GetitemString(ll_fila,'tipomodalidad')
	else
		ls_TipoModForm = ''
	end if
	
	ll_existe = 1
	IF ls_IndAltaBaja = '0' OR ls_IndAltaBaja = '2' THEN
		IF  fw_verifica_existe_sunat( ls_numdoc, ls_IndIniActual ) > 0 THEN // Para que pase, debe exisitri el registro
			ll_existe  = 0
		END IF
		IF ls_IndAltaBaja = '0' AND ls_estado='NO' THEN ll_existe=1 // No considerarlo como baja 
		IF ls_IndAltaBaja = '2' AND ls_CasoModifica = '98' AND ls_estado='2' THEN ll_existe=0 // Considerar Los pendientes por liquidar
		IF ls_IndAltaBaja = '2' AND ls_CasoModifica = '99' AND ls_estado='4' THEN ll_existe=0 // Considerar Los pendientes por liquidar
	END IF

	//Solo aplica para ALTAS
//	IF ls_IndAltaBaja = '1' THEN //ALTA
//		ll_existe  = fw_verifica_existe_sunat( ls_numdoc, ls_IndIniActual ) // Para que pase, no debe exisitri el registro
//	END IF
		
	//Validamos que este cargado en T00 del periodo
	lol_ConPago		= 1
	
	If ls_IndAltaBaja = '1'  Then
		SELECT	COUNT(1)	INTO :ll_existe
		FROM		RTPS_AR4_T00	WITH(NoLock)
		WHERE	Periodo=	:iv$_periodo AND	TIPODOC	=:ls_tipodoc AND NumeroDoc=	:ls_numdoc	Using SQLCA;
		
		If sqlca.sqlcode < 0 Then
			ll_existe=0
		End If
		If ll_existe > 0 Then 
			ll_existe = 0
		Else
			ll_existe=1
		End If
		//Solo si se indica que se incluya a las altas procesadas en la Planila del Mes	
		If ls_IndFuente = 'S' Then				
			lol_ConPago = f_verifica_pago_boleta(ll_persona, ls_periodo, '%' )
		End If
	End If

	If lol_ConPago > 0 Then
		lb_InsertaRegistro = True
	Else
		lb_InsertaRegistro = False
	End If
				
	If lb_InsertaRegistro Then
		//Verifica si es pensionista y si esta con licencia o sin remuner. con vinc.lab
		IF fw_verificaEstadoPensionista(ll_persona) = 0 THEN
			
			IF   ll_existe = 0 THEN
					 
				INSERT INTO RTPS_AR11_P00
				(	TIPODOC,
					 NUMDOC,
					 CATEGORIA,
					 FECHAINICIO,
					 FECHAFIN,
					 TIPOFIN,
					 TIPOMODFORMATIVA,
					 PERIODO,
					 COMPANIASOCIO, 
					 TIPOINGRESO,
					 INDERROR,
					 UltimoUsuario,
					 UltimaFechaModif,
					 PAISEMISORDOC, // RQ 00047 Inicio
					 TIPOREGISTRO,
					 CODIGOEPS // RQ 00047 Fin
				) 
				VALUES
				(:ls_tipodoc,:ls_numdoc,:ls_categoria,:ldt_fechaingreso,:ldt_fechacese,
				:ls_Indicador, :ls_TipoModForm, // RQ 00047
				:iv$_periodo,:ls_company,'A','N',
				:str_global.gv_userid,:ldt_FecHoy,
				:ls_PaisEmisor, // RQ 00047 Inicio
				:ls_TipoRegistro,
				:ls_CodigoEPS) // RQ 00047 Fin
				USING SQLCA;
				
				if sqlca.sqlcode < 0 then
					w$_msg = sqlca.sqlerrtext
					rollback;
					f_msg(w$_msg)
					return -1
				end if	
			
			END IF
		END IF
	End If

	uo_progress.uf_Set_Position( ll_fila / ll_rowcount * 100 )	
Next 	

COMMIT;
//Se depura aquellos pensionistas que reciben pension x viudez y jubilacioin
wf_depurapensionista(Mid(ls_periodo,1,6),'PER')

uo_progress.uf_Set_Position(100)
uo_progress.uf_Check(TRUE)

RETURN 0
end function

public function integer wf_procesa_ar12 ();long w%_fila,w%_rowcount
string W$_COMPANY,w$_periodo
string w$_tipodoc,w$_numdoc,w$_ruc, w$_razonsocial
string w$_periodofiscal

w$_periodo =iv$_periodo+mid(iv$_periodo,5,2)
w$_company =left (iv$_CompaniaSocio,8) 
dw_source_12.SetTransObject(SQLCA)
w$_periodofiscal = mid(iv$_periodo,1,4)
 dw_source_12.retrieve(w$_company,w$_periodo, w$_periodofiscal)
w%_rowcount=dw_source_12.rowcount()

DELETE FROM RTPS_AR12_O00
WHERE PERIODO = :iv$_periodo
AND COMPANIASOCIO =:W$_COMPANY
AND TIPOINGRESO='A'
USING SQLCA;

if sqlca.sqlcode < 0 then
	string w$_msg
	w$_msg = sqlca.sqlerrtext
	rollback;
	f_msg(w$_msg)
	return -1
end if

COMMIT;
uo_progress.uf_Set_Position(0)
uo_progress.uf_Check(FALSE)	

datetime w%_hoy
w%_hoy = f_today()

For w%_fila=1 to w%_rowcount 

	w$_tipodoc=f_nonulo_str(wf_tipodocumento(dw_source_12.GetitemString(w%_fila,'tipodocumento')))
	w$_numdoc=f_nonulo_str(dw_source_12.GetitemString(w%_fila,'documento'))
	w$_ruc=dw_source_12.GetitemString(w%_fila,'ruc')
	w$_razonsocial=dw_source_12.GetitemString(w%_fila,'descripcion')
	
	
	INSERT INTO RTPS_AR12_O00
	(	TIPODOC,
		NUMDOC,
		RUCOTRAEMPRESA,
		RAZONSOCIAL,
		PERIODO,
		COMPANIASOCIO, 
		TIPOINGRESO,
		INDERROR,
		UltimoUsuario,
		UltimaFechaModif
	) 
	VALUES
	(
		:w$_tipodoc,:w$_numdoc,
		:w$_ruc,:w$_razonsocial,
		:iv$_periodo,:w$_company,
		'A','N',
		:str_global.gv_userid,:w%_hoy)
	USING SQLCA;

	if sqlca.sqlcode < 0 then
		w$_msg = sqlca.sqlerrtext
		rollback;
		f_msg(w$_msg)
		return -1
	end if

	uo_progress.uf_Set_Position( w%_fila / w%_rowcount * 100 )
	
Next 	
	
COMMIT;


RETURN 0
end function

public function string wf_categoriatrabajador (string par_tipotrabajador);string w$_retorno

SELECT CategoriaRTPS  
INTO :w$_retorno  
FROM HR_TipoTrabajador	  
WHERE ( HR_TipoTrabajador.TipoTrabajador= :par_tipotrabajador )          ;

return w$_retorno


end function

public function string wf_tipotrabajador (string par_tipotrabajador);string w$_retorno

SELECT codigoseguro
INTO :w$_retorno  
FROM HR_TipoTrabajador	  
WHERE ( HR_TipoTrabajador.TipoTrabajador= :par_tipotrabajador )          ;

return w$_retorno
end function

public function string wf_regimenlaboral (string par_empresa);string w$_retorno

SELECT REgimenLaboralRTPS 
INTO :w$_retorno  
FROM CompaniaMast  
WHERE companiacodigo in 
(select company from 
Companyowner where 
Companyowner  = :par_empresa )          ;

return w$_retorno

end function

public function string wf_periodicidad (string par_planilla);string w$_retorno

SELECT Periodicidad
INTO :w$_retorno  
FROM PR_tipoPlanilla	  
WHERE ( TipoPlanilla= :par_planilla )          ;

return w$_retorno
end function

public function string wf_tipocontrato (string par_contrato);string w$_retorno

SELECT TipoContratoPE
INTO :w$_retorno  
FROM HR_tipoContrato  
WHERE TipoContrato= :par_contrato  ;

return right ('00' + trim (w$_retorno),2)

end function

public function string wf_estadocivil (string par_estado);string w$_retorno,w$_estado


Choose Case par_estado
	Case 'C'
		w$_retorno='02'
	Case 'D'
		w$_retorno='04'
	Case 'S'
		w$_retorno='01'
	Case 'V'
		w$_retorno='03'
	Case 'O'
		w$_retorno='05'
End Choose

return w$_retorno
		
end function

public function string wf_eps (string par_eps);string w$_retorno


SELECT MA_MiscelaneosDetalle.CodigoElemento
INTO :w$_retorno  
FROM MA_MiscelaneosDetalle  
WHERE ( MA_MiscelaneosDetalle.AplicacionCodigo = 'PR' ) AND  
( MA_MiscelaneosDetalle.CodigoTabla = 'RTPS_TB_14' ) AND  
( MA_MiscelaneosDetalle.Compania = '999999' ) AND  
( MA_MiscelaneosDetalle.ValorCodigo1 = substring(:par_eps,1,10) )          ;

if w$_retorno='' then w$_retorno='0'

return w$_retorno

end function

public function string wf_banco (string par_banco);string w$_retorno

SELECT bancoRTPS
INTO :w$_retorno  
FROM BANCO  
WHERE Banco = :par_banco          ;

return w$_retorno
end function

public function string wf_regimenpensionario (string par_pension, string par_afp);string w$_retorno
String		los_pension
IF par_pension = 'GRA' THEN
	los_pension='DLR'
ELSE
	los_pension = par_pension
END IF

SELECT MA_MiscelaneosDetalle.ValorCodigo1  
INTO :w$_retorno  
FROM MA_MiscelaneosDetalle  
WHERE ( MA_MiscelaneosDetalle.AplicacionCodigo = 'PR' ) AND  
( MA_MiscelaneosDetalle.CodigoTabla = 'REGPENSI' ) AND  
( MA_MiscelaneosDetalle.Compania = '999999' ) AND  
( MA_MiscelaneosDetalle.CodigoElemento = :par_pension )          ;


if w$_retorno='1' then
		SELECT codigoRTPS 
		INTO :w$_retorno  
		FROM HR_AFP  
		WHERE CodigoAfp= :par_afp           ;
end if	

return right ('0' + trim (w$_retorno),2)


end function

public function string wf_nacionalidad (string par_pais);string w$_retorno

SELECT codigortps
INTO :w$_retorno  
FROM PAIS  
WHERE pais = :par_pais          ;


//inicializacion de variable julio 2008
if w$_retorno='' or isnull(w$_retorno) then
	w$_retorno='9589'
end if	


return w$_retorno
end function

public function string wf_tipopago (string par_tipo);string w$_retorno

SELECT tipopagoRTPS
INTO :w$_retorno  
FROM TIPOPAGO  
WHERE TipoPago = :par_tipo          ;

return w$_retorno
end function

public function string wf_situacioneps (string par_asistencia, string par_estado);String ls_situaciontrabajador,ls_estadoempleado

ls_estadoempleado=par_estado

if ls_estadoempleado = '0'  or ls_estadoempleado = '1' then   // activo afiliado a EPS
	ls_situaciontrabajador = '1'
end if 	
if ls_estadoempleado = '2' then   // Cesado
	ls_situaciontrabajador = '0'
end if
if ls_estadoempleado = '3' then   // Suspencion perfecta 
	ls_situaciontrabajador = '3'
end if
if ls_estadoempleado = '4' then   // Sin vinculo con pago pendiente afiliado a EPS
	ls_situaciontrabajador = '2'
end if
			
Return ls_situaciontrabajador
end function

public function integer wf_procesa_a14 ();long w%_fila,w%_rowcount
string W$_COMPANY,w$_periodo
string w$_tipodoc,w$_numdoc,w$_codigoconcepto
double w%_diastrabajados, w%_horasextras, w%_horastrabajadas
 
 w$_codigoconcepto = "'0050','0060','0070'"
 
	w$_periodo =iv$_periodo+mid(iv$_periodo,5,2)
	w$_company =left (iv$_CompaniaSocio,8) 
	dw_source_14.SetTransObject(SQLCA)
	dw_source_14.retrieve(w$_company,w$_periodo,w$_codigoconcepto)
	w%_rowcount=dw_source_14.rowcount()

		DELETE FROM AR18_JOR
		WHERE PERIODO = :iv$_periodo
		AND COMPANIASOCIO =:W$_COMPANY
		AND TIPOINGRESO='A'
		USING SQLCA;

		COMMIT;

	uo_progress.uf_Set_Position(0)
	uo_progress.uf_Check(FALSE)					

	For w%_fila=1 to w%_rowcount 

		w$_tipodoc=f_nonulo_str(wf_tipodocumento(dw_source_14.GetitemString(w%_fila,1)))
		w$_numdoc=f_nonulo_str(dw_source_14.GetitemString(w%_fila,2))
		w%_diastrabajados=dw_source_14.GetitemDecimal(w%_fila,3)
		w%_horasextras=dw_source_14.GetitemDecimal(w%_fila,4)
		w%_horastrabajadas=w%_diastrabajados*8
		
		INSERT INTO RTPS_AR14_JOR
		(TIPODOC,
		 NUMDOC,
		 NUMDIATRABAJADOS,
		 NUMHORASNORMALES,
		 NUMHORASSOBRETIEMPO,
	    PERIODO,
	    COMPANIASOCIO, 
	    TIPOINGRESO,
	    INDERROR,
	    UltimoUsuario,
	    UltimaFechaModif
   ) 
		VALUES
		(:w$_tipodoc,:w$_numdoc,:w%_diastrabajados,:w%_horasextras,:w%_horastrabajadas,
		:iv$_periodo,:w$_company,'A','N',
		:str_global.gv_userid,:str_global.gv_today)
		USING SQLCA;
		
	uo_progress.uf_Set_Position( w%_fila / w%_rowcount * 100 )
		
	Next 	
	
	COMMIT;

	uo_progress.uf_Set_Position(100)
	uo_progress.uf_Check(TRUE)

RETURN 0
end function

public function integer wf_procesa_ar14 ();/*
------------------------------------------------------------------------------------------------------
Objeto					: wf_procesa_ar14
Objetivo					: Procesa la información del archivo 14
Autor						: 
Fecha						: 
Nro. RQ					: 
Parámetros Entrada	: Ninguno
Parámetros Salida		: Ninguno
Observación				: Ninguno
------------------------------------------------------------------------------------------------------
Modificaciones
Nro. RQ		Fecha			Usuario			Descripción
------------------------------------------------------------------------------------------------------
RQ 00047		08/08/2012	JCOAGUILAP		Actualiza el tipo de archivo
------------------------------------------------------------------------------------------------------
*/
long w%_fila,w%_rowcount, lol_CodiPersona
string W$_COMPANY,w$_periodo, ls_IndAltaBaja
string w$_tipodoc,w$_numdoc,w$_codigoconcepto
double w%_diastrabajados, w%_diastrabajadosoriginal, w%_horasextras, w%_horastrabajadas
double	w%NUMMINNORMALES,w%NUMMINSOBRETIEMPO
datetime w%_hoy
string w$_msg, los_SitEps
Boolean  lob_Inserta = True
Boolean	lb_SavePago

dw_filtro.accepttext( )
 
w$_codigoconcepto = f_sql_read_parametrosmast_$_explicacion('PR','999999','RTPSCONJHE')

w$_periodo =iv$_periodo+mid(iv$_periodo,5,2)
w$_company =left (iv$_CompaniaSocio,8) 
dw_source_14.SetTransObject(SQLCA)
dw_source_14.retrieve(w$_company,w$_periodo,w$_codigoconcepto)
w%_rowcount=dw_source_14.rowcount()

ls_IndAltaBaja = dw_filtro.object.ind_altabaja[1]

DELETE FROM RTPS_AR14_JOR
WHERE PERIODO = :iv$_periodo
AND COMPANIASOCIO =:W$_COMPANY
AND TIPOINGRESO='A'
USING SQLCA;

if sqlca.sqlcode < 0 then
	w$_msg = sqlca.sqlerrtext
	rollback;
	f_msg(w$_msg)
	return -1
end if

COMMIT;

uo_progress.uf_Set_Position(0)
uo_progress.uf_Check(FALSE)					

w%_hoy = f_today()

For w%_fila=1 to w%_rowcount 

	w$_tipodoc=Right('00'+f_nonull_left(wf_tipodocumento(dw_source_14.GetitemString(w%_fila,'tipodocumento')),2),2) // RQ 00047
	w$_numdoc=f_nonull_left(dw_source_14.GetitemString(w%_fila,'documento'), 15) // RQ 00047
	w%_diastrabajados=f_nonulo (dw_source_14.GetitemDecimal(w%_fila,'diastrabajados'))
	w%_diastrabajadosoriginal=f_nonulo (dw_source_14.GetitemDecimal(w%_fila,'diastrabajadosoriginal'))
	if f_sql_read_parametrosmast_$('PR','999999','RTPSDTPDTA') = 'S' then  // DiasTrabajados en lugar de DiasTrabajadosPDT
		w%_diastrabajados = w%_diastrabajadosoriginal
	end if
	lol_CodiPersona	=dw_source_14.getItemNumber(w%_fila,"empleado")
	
	// Si es febrero
	if mid (iv$_Periodo,5,2) = "02" then
		long w%_anio, w%_limite
		
		// Si es biciesto
		w%_anio = long (mid (iv$_periodo,1,4))
		if mod (w%_anio, 4) = 0 then
			w%_limite = 29
		else
			w%_limite = 28
		end if
		if w%_diastrabajados > w%_limite then
			w%_diastrabajados = w%_limite
		end if
	else
		choose case long (mid (iv$_periodo,5,2))
				case 1,3,5,7,8,10,12
				if w%_diastrabajados > 31 then
					w%_diastrabajados = 31
				end if
					
				case 4,6,9,11
				if w%_diastrabajados > 30 then
					w%_diastrabajados = 30
				end if
		end choose
	end if

	if w%_diastrabajados<0 then 
		w%_diastrabajados=0 
	end if
	
	w%_horasextras=dw_source_14.GetitemDecimal(w%_fila,'horasextras')
	w%_horastrabajadas=w%_diastrabajados*8

//modificado el 12/08/2008
	w%NUMMINNORMALES=dw_source_14.GetitemDecimal(w%_fila,'NUMMINNORMALES')
	w%NUMMINSOBRETIEMPO=dw_source_14.GetitemDecimal(w%_fila,'NUMMINSOBRETIEMPO')
// fin de modificado el 12/08/2008	

//Buscamos la situacion del trabajador en e archivo T001 y si es 18 o 19 entonces no se le carga la jornada laboral
	lob_Inserta = True
	los_SitEps = f_datosarchivospdt(iv$_periodo, w$_numdoc, 'TRA', 'SITEPS') // RQ 00047
	
	if los_SitEps = '18' then lob_Inserta = False
	if los_SitEps = '19' then  lob_Inserta = False
	
	//Solo para las altas verifica que tenga pago en el periodo para registrarlo en el T-registro
	lb_SavePago = True
	If ls_IndAltaBaja = '1' Then
		If f_verifica_pago_boleta(lol_CodiPersona, w$_periodo, '%' ) > 0 Then
			lb_SavePago=True
		Else
			lb_SavePago=False
		End If
	End If	
	
	If lb_SavePago Then
		if  lob_Inserta = True then		
		
			INSERT INTO RTPS_AR14_JOR
			(	TIPODOC,
				 NUMDOC,
				 NUMDIATRABAJADOS,
				 NUMHORASNORMALES,
				 NUMMINNORMALES,
				 NUMHORASSOBRETIEMPO,
				 NUMMINSOBRETIEMPO,
				 PERIODO,
				 COMPANIASOCIO, 
				 TIPOINGRESO,
				 INDERROR,
				 UltimoUsuario,
				 UltimaFechaModif
			) 
			VALUES
			(	:w$_tipodoc,:w$_numdoc,:w%_diastrabajados,
				:w%_horastrabajadas,
				:w%NUMMINNORMALES,
				:w%_horasextras,
				:w%NUMMINSOBRETIEMPO,
				:iv$_periodo,:w$_company,'A','N',
				:str_global.gv_userid,:w%_hoy)
			USING SQLCA;
						
			if sqlca.sqlcode < 0 then
				w$_msg = sqlca.sqlerrtext
				rollback;
				f_msg(w$_msg)
				return -1
			end if
		end if
	End If
		
	uo_progress.uf_Set_Position( w%_fila / w%_rowcount * 100 )
		
Next 	

COMMIT;

uo_progress.uf_Set_Position(100)
uo_progress.uf_Check(TRUE)

RETURN 0
end function

public function string wf_motivocese (integer par_motivo);string w$_retorno

SELECT codigoRTPS
INTO :w$_retorno  
FROM HR_MotivoCese
WHERE Motivo= :par_motivo ;

return w$_retorno

end function

public function string wf_ocupacion (integer par_cargo);string w$_retorno

SELECT 	CodigoRTPS  
INTO :w$_retorno  
FROM hr_puestoempresa	  
WHERE ( codigopuesto= :par_cargo)          ;

return w$_retorno
end function

public subroutine wf_proceso_ar21 ();
end subroutine

public function integer wf_procesa_ar21 ();long w%_fila,w%_rowcount
string W$_COMPANY,w$_periodo
string w$_tipodoc,w$_numdoc,w$_codigoconcepto
double w%_montodev, w%_montopag
 
w$_periodo =iv$_periodo+mid(iv$_periodo,5,2)
w$_company =left (iv$_CompaniaSocio,8) 
dw_source_21.SetTransObject(SQLCA)
dw_source_21.retrieve(w$_company,w$_periodo)
w%_rowcount=dw_source_21.rowcount()

DELETE FROM RTPS_AR21_FOR
WHERE PERIODO = :iv$_periodo
AND COMPANIASOCIO =:W$_COMPANY
AND TIPOINGRESO='A'
USING SQLCA;

if sqlca.sqlcode < 0 then
	string w$_msg
	w$_msg = sqlca.sqlerrtext
	rollback;
	f_msg(w$_msg)
	return -1
end if

COMMIT;

uo_progress.uf_Set_Position(0)
uo_progress.uf_Check(FALSE)					

datetime w%_hoy
w%_hoy = f_today()

For w%_fila=1 to w%_rowcount 

	w$_tipodoc=f_nonulo_str(wf_tipodocumento(dw_source_21.GetitemString(w%_fila,'tipodocumento')))
	w$_numdoc=f_nonulo_str(dw_source_21.GetitemString(w%_fila,'documento'))
	w%_montopag=dw_source_21.GetitemDecimal(w%_fila,'montopagado')

	INSERT INTO RTPS_AR21_FOR
	(	TIPODOC,		NUMDOC,
		MONTO,		PERIODO,
		COMPANIASOCIO, 		TIPOINGRESO,
		INDERROR,		UltimoUsuario,
		UltimaFechaModif
   ) 
	VALUES
	(	:w$_tipodoc,:w$_numdoc,
		:w%_montopag,:iv$_periodo,
		:w$_company,'A',
		'N',:str_global.gv_userid,
		:w%_hoy)
	USING SQLCA;
		
	if sqlca.sqlcode < 0 then
		w$_msg = sqlca.sqlerrtext
		rollback;
		f_msg(w$_msg)
		return -1
	end if
	
	uo_progress.uf_Set_Position( w%_fila / w%_rowcount * 100 )
		
Next 	
	
COMMIT;

uo_progress.uf_Set_Position(100)
uo_progress.uf_Check(TRUE)

RETURN 0
end function

public function integer wf_procesa_ar17 ();/*
------------------------------------------------------------------------------------------------------
Objeto					: wf_procesa_ar17
Objetivo					: Procesa la información del archivo 17
Autor						: 
Fecha						: 
Nro. RQ					: 
Parámetros Entrada	: Ninguno
Parámetros Salida		: Ninguno
Observación				: Ninguno
------------------------------------------------------------------------------------------------------
ModIficaciones
Nro. RQ		Fecha			Usuario			Descripción
------------------------------------------------------------------------------------------------------
RQ 00047		08/08/2012	JCOAGUILAP		Actualiza el tipo de archivo. Agregar campo pais emisor
------------------------------------------------------------------------------------------------------
*/
String 	ls_Company,ls_periodo, ls_establec,los_SitEps,ls_Message, ls_TipoDoc,ls_NumDoc,ls_ruc, ls_RazonSocial,ls_periodoanterior, &
			ls_PaisEmisor,ls_IndAltaBaja,ls_IndIniActual, ls_IndUniPer, ls_IndPlanOtros,ls_IndFuente,ls_PeriAntPost
Long		ll_fila,ll_RowCount	, lol_CodiPersona,lol_ConPago,lol_VerIfica
Datetime ldt_hoy
Boolean  lob_Inserta = True
Boolean	lb_InsertaRegistro

ls_periodo 			= iv$_periodo+mid(iv$_periodo,5,2)
ls_Company 		= left (iv$_CompaniaSocio,8) 
ls_IndAltaBaja 		= dw_filtro.object.ind_altabaja[1]
ls_IndIniActual 		= dw_filtro.object.ind_iniactual[1]
ls_IndUniPer 		= dw_filtro.object.ind_unicoper[1]
ls_IndPlanOtros		= dw_filtro.object.plani_otros[1]
ls_IndFuente		= dw_filtro.object.ind_origen[1]
ls_PeriAntPost 		= is_PeriAntePost + mid(is_PeriAntePost,5,2)


IF IsNUll(ls_PeriAntPost) OR TRIM(ls_PeriAntPost)='' THEN
	ls_periodoanterior=String(Long(iv$_periodo)-1)
	if Mid(ls_periodoanterior,5,2) ='00' 	then 
		ls_periodoanterior=String(Long(iv$_periodo)-89)
	end if
	ls_periodoanterior		=ls_periodoanterior+mid(ls_periodoanterior,5,2)
ELSE
	ls_periodoanterior = ls_PeriAntPost
END IF

If ls_IndUniPer = '1' Then //Solo el periodo actual
	ls_periodoanterior = ls_periodo
END If
If ls_IndPlanOtros = '1' THEN
	ls_IndIniActual = 'T'
END If

dw_source_17.SetTransObject(SQLCA)
dw_source_17.retrieve(ls_Company,ls_periodo, ls_periodoanterior, ls_IndAltaBaja, ls_IndIniActual)
ll_RowCount=dw_source_17.rowcount()

DELETE FROM RTPS_AR17_TES
WHERE PERIODO = :iv$_periodo
AND COMPANIASOCIO =:ls_Company
AND TIPOINGRESO='A'
USING SQLCA;

If sqlca.sqlcode < 0 then
	ls_Message = sqlca.sqlerrtext
	rollback;
	f_msg(ls_Message)
	return -1
end If

COMMIT;

ldt_hoy = f_today()

uo_progress.uf_Set_Position(0)
uo_progress.uf_Check(FALSE)	

For ll_fila= 1 to ll_RowCount 	
	ls_TipoDoc=Right('00'+f_nonull_left(wf_tipodocumento(dw_source_17.GetitemString(ll_fila,'tipodocumento')), 2), 2) // RQ 00047 - Formato 00
	ls_NumDoc=f_nonulo_str(dw_source_17.GetitemString(ll_fila,'documento'))
	ls_ruc=dw_source_17.GetitemString(ll_fila,'documentofiscal')
	ls_establec=dw_source_17.GetitemString(ll_fila,'codigo')
	
	lob_Inserta = True
	los_SitEps = f_datosarchivospdt(iv$_periodo, ls_NumDoc, 'TRA', 'SITEPS') // RQ 00047
	ls_PaisEmisor = f_nonull_left(wf_paisemisor(dw_source_17.getItemString(ll_fila,'paisemisordocumento')), 3) // RQ 00047	
	lol_CodiPersona	=dw_source_17.getItemNumber(ll_fila,"empleado")
	
	If los_SitEps = '2' then lob_Inserta = False
	
	If  lob_Inserta = True then
		
		//Solo aplica para ALTAS
		
		//Validamos que este cargado en T00 del periodo
		lol_VerIfica		= 0
		lol_ConPago		= 1
		
		If ls_IndAltaBaja = '1'  Then
			SELECT	COUNT(1)	INTO :lol_VerIfica
			FROM		RTPS_AR4_T00	WITH(NoLock)
			WHERE	Periodo=	:iv$_periodo AND	TIPODOC	=:ls_TipoDoc AND NumeroDoc=	:ls_NumDoc	Using SQLCA;
			
			If sqlca.sqlcode < 0 Then
				lol_VerIfica=0
			End If
			//Solo si se indica que se incluya a las altas procesadas en la Planila del Mes	
			If ls_IndFuente = 'S' Then				
				lol_ConPago = f_verIfica_pago_boleta(lol_CodiPersona, ls_periodo, '%' )
			End If
		Else
			lol_VerIfica = fw_verIfica_existe_sunat( ls_NumDoc, ls_IndIniActual )
		End If
	
		If lol_ConPago > 0 Then
			lb_InsertaRegistro = True
		Else
			lb_InsertaRegistro = False
		End If
	
		
		If lol_VerIfica > 0 Then
			If  lb_InsertaRegistro then
			
				//If para carga inicial de personal nuevo-altas, no cargados en julio del 2011 por sunat
				//Entra solo si no existe en sunat
					  
				INSERT INTO RTPS_AR17_TES
				(	TIPODOC, NUMDOC, RUCEMPDESTACO, CODESTABLECIMIENTO,  PERIODO,
					COMPANIASOCIO, TIPOINGRESO, 	INDERROR, UltimoUsuario, UltimaFechaModIf,
					PAISEMISORDOC ) // RQ 00047
				VALUES
				(	:ls_TipoDoc,:ls_NumDoc, :ls_ruc, :ls_establec, :iv$_periodo,
					:ls_Company, 'A', 'N',:str_global.gv_userid, :ldt_hoy,
					:ls_PaisEmisor )	USING SQLCA; // RQ 00047
			
				If sqlca.sqlcode < 0 then
					ls_Message = sqlca.sqlerrtext
					rollback;
					f_msg(ls_Message)
					return -1
				end If
			
			end If
		End If
	End if
	
	uo_progress.uf_Set_Position( ll_fila / ll_RowCount * 100 )

Next 	
	
COMMIT;

//Agregado por RLRL 13.10.2010
ll_RowCount	= dw_source_17_02.Retrieve( ls_Company, Mid(ls_periodo, 1, 6)  )
For ll_fila= 1 to ll_RowCount
	ls_TipoDoc	=	f_nonulo_str(wf_tipodocumento(dw_source_17_02.GetitemString(ll_fila,'tipodocumento')))
	ls_NumDoc	=	f_nonulo_str(dw_source_17_02.GetitemString(ll_fila,'documento'))
	ls_ruc		=	dw_source_17_02.GetitemString(ll_fila,'DocumentoFiscal')
	ls_establec	=	dw_source_17_02.GetitemString(ll_fila,'Codigo')
	
	INSERT INTO RTPS_AR17_TES
	(	TIPODOC, NUMDOC, RUCEMPDESTACO, CODESTABLECIMIENTO, PERIODO,
		COMPANIASOCIO, TIPOINGRESO, 	INDERROR, UltimoUsuario, UltimaFechaModIf	) 
	VALUES
	(	:ls_TipoDoc,:ls_NumDoc, :ls_ruc, :ls_establec,  :iv$_periodo,
		:ls_Company, 'A', 'N',:str_global.gv_userid, :ldt_hoy	)	USING SQLCA;

	If sqlca.sqlcode < 0 then
		ls_Message = sqlca.sqlerrtext
		rollback;
		f_msg(ls_Message)
		return -1
	end If
	uo_progress.uf_Set_Position( ll_fila / ll_RowCount * 100 )
Next
COMMIT;

RETURN 0
end function

public function integer wf_procesa_ar16 ();long w%_fila,w%_rowcount
string W$_COMPANY,los_CodiPeri
string w$_tipodoc,w$_numdoc,w$_tipodias, w$_razonsocial, w_remvaca
datetime lodt_FechInic, lodt_FechFin,lodt_FecFinPer,lodt_FecIniPer
Date  w_inicio,w_fin
integer lv_mes, lv_anio
 
los_CodiPeri =iv$_periodo+mid(iv$_periodo,5,2)
lodt_FecIniPer=DateTime(Date('01/'+mid(iv$_periodo,5,2)+'/'+mid(iv$_periodo,1,4)))
w_inicio=Date(lodt_FecIniPer)

lv_mes = Month(w_inicio)
lv_anio = Year(w_inicio)
//rango inicial:
w_inicio = Date(lv_anio, lv_mes, 1)

//rango final:

IF lv_mes < 12 THEN
	w_fin = RelativeDate( Date(lv_anio, lv_mes+ 1, 1),  - 1)
ELSE
	w_fin = RelativeDate( Date(lv_anio + 1, 1, 1),  - 1)
END IF

lodt_FecFinPer=DateTime(w_fin)


los_CodiPeri =iv$_periodo+mid(iv$_periodo,5,2)
w$_company =left (iv$_CompaniaSocio,8) 
dw_source_16.SetTransObject(SQLCA)
w_remvaca = f_sql_read_parametrosmast_$('PR','999999','COINREMVAC')
dw_source_16.retrieve(w$_company,los_CodiPeri, 0)
w%_rowcount=dw_source_16.rowcount()

DELETE FROM RTPS_AR16_NOT 
WHERE PERIODO = :iv$_periodo
	AND COMPANIASOCIO =:W$_COMPANY
	AND TIPOINGRESO='A'
USING SQLCA;

if sqlca.sqlcode < 0 then
	string w$_msg
	w$_msg = sqlca.sqlerrtext
	rollback;
	f_msg(w$_msg)
	return -1
end if

COMMIT;
uo_progress.uf_Set_Position(0)
uo_progress.uf_Check(FALSE)	
datetime w%_hoy
w%_hoy = f_today()



For w%_fila=1 to w%_rowcount 
	w$_tipodoc=f_nonulo_str(wf_tipodocumento(dw_source_16.GetitemString(w%_fila,'tipodocumento')))
	w$_numdoc=f_nonulo_str(dw_source_16.GetitemString(w%_fila,'documento'))
	w$_tipodias=dw_source_16.GetitemString(w%_fila,'tipodia')
	lodt_FechInic=dw_source_16.GetitemDateTime(w%_fila,'fechainicio')
	lodt_FechFin=dw_source_16.GetitemDateTime(w%_fila,'fechafin')
	
	if lodt_FechInic<=lodt_FecFinPer then
	
			if lodt_FechInic<=lodt_FecIniPer then
				lodt_FechInic=lodt_FecIniPer 
			end if
			
			if lodt_FechFin>=lodt_FecFinPer then
				lodt_FechFin=lodt_FecFinPer
			end if

			INSERT INTO RTPS_AR16_NOT 
			(
				TIPODOC,
				NUMDOC,
				TIPODIAS ,
				FECHAINICIO,
				FECHAFIN,
				PERIODO,
				COMPANIASOCIO, 
				TIPOINGRESO,
				INDERROR,
				UltimoUsuario,
				UltimaFechaModif
			) 
			VALUES
			(
				:w$_tipodoc,:w$_numdoc,:w$_tipodias, :lodt_FechInic, :lodt_FechFin,
				:iv$_periodo,:w$_company,'A','N',
				:str_global.gv_userid,:w%_hoy)
			USING SQLCA;
			
			if sqlca.sqlcode < 0 then
				w$_msg = sqlca.sqlerrtext
				rollback;
				f_msg(w$_msg)
				return -1
			end if
	end if
			uo_progress.uf_Set_Position( w%_fila / w%_rowcount * 100 )
		Next 	
	
	
COMMIT;


RETURN 0
end function

public function integer wf_procesa_ar15 ();/*
------------------------------------------------------------------------------------------------------
Objeto					: wf_procesa_ar15
Objetivo					: Procesa la información del archivo 15
Autor						: 
Fecha						: 
Nro. RQ					: 
Parámetros Entrada	: Ninguno
Parámetros Salida		: Ninguno
Observación				: Ninguno
------------------------------------------------------------------------------------------------------
Modificaciones
Nro. RQ		Fecha			Usuario			Descripción
------------------------------------------------------------------------------------------------------
RQ 00047		20/08/2012	JCOAGUILAP		Actualiza el tipo de archivo
------------------------------------------------------------------------------------------------------
*/
long w%_fila,w%_rowcount, lol_CodiPersona
string W$_COMPANY,w$_periodo, w$_citt, ls_IndAltaBaja
string w$_tipodoc,w$_numdoc,w$_tipodias, w$_razonsocial
datetime w$_fechainicio, w$_fechafin,w%_periodo,w%_finperiodo
Date  w_inicio,w_fin
integer lv_mes, lv_anio
string w$_msg
datetime w%_hoy
String		los_periAnterior
Integer li_dias
Boolean	lb_SavePago

dw_filtro.accepttext( )
 
w$_periodo =iv$_periodo+mid(iv$_periodo,5,2)
w%_periodo=DateTime(Date('01/'+mid(iv$_periodo,5,2)+'/'+mid(iv$_periodo,1,4)))
w_inicio=Date(w%_periodo)

ls_IndAltaBaja = dw_filtro.object.ind_altabaja[1]

lv_mes = Month(w_inicio)
lv_anio = Year(w_inicio)
//rango inicial:
w_inicio = Date(lv_anio, lv_mes, 1)

//rango final:
IF lv_mes < 12 THEN
	w_fin = RelativeDate( Date(lv_anio, lv_mes+ 1, 1),  - 1)
ELSE
	w_fin = RelativeDate( Date(lv_anio + 1, 1, 1),  - 1)
END IF

w%_finperiodo=DateTime(w_fin)

los_periAnterior=String(Long(iv$_periodo)-1)
if Mid(los_periAnterior,5,2) ='00' 	then 
	los_periAnterior=String(Long(iv$_periodo)-89)
end if
w$_periodo =iv$_periodo+mid(iv$_periodo,5,2)
w$_company =left (iv$_CompaniaSocio,8) 
dw_source_15.SetTransObject(SQLCA)
//dw_source_15.retrieve(w$_company, iv$_periodo) // RQ 00047
dw_source_15.retrieve(w$_company, w$_periodo) // RQ 00047
w%_rowcount=dw_source_15.rowcount()

DELETE FROM RTPS_AR16_NOT // RQ 00047
WHERE PERIODO = :iv$_periodo
	AND COMPANIASOCIO =:W$_COMPANY
	AND TIPOINGRESO='A'
USING SQLCA;

if sqlca.sqlcode < 0 then
	w$_msg = sqlca.sqlerrtext
	rollback;
	f_msg(w$_msg)
	return -1
end if


COMMIT;
uo_progress.uf_Set_Position(0)
uo_progress.uf_Check(FALSE)	

w%_hoy = f_today()

For w%_fila=1 to w%_rowcount 
	w$_tipodoc=Right('00'+f_nonulo_str(wf_tipodocumento(dw_source_15.GetitemString(w%_fila,'tipodocumento'))), 2) // RQ 00047
	w$_numdoc=f_nonull_left(dw_source_15.GetitemString(w%_fila,'documento'), 15)
	w$_tipodias=f_nonull_left(dw_source_15.GetitemString(w%_fila,'tipodia'), 2)	
	w$_fechainicio=dw_source_15.GetitemDateTime(w%_fila,'fechainicio')
	w$_fechafin=dw_source_15.GetitemDateTime(w%_fila,'fechafin') // RQ 00047
	li_dias = dw_source_15.GetItemNumber(w%_fila,'dias') // RQ 00047
	lol_CodiPersona	=dw_source_15.getItemNumber(w%_fila,"empleado")
		
	//Solo para las altas verifica que tenga pago en el periodo para registrarlo en el T-registro
	lb_SavePago = True
	If ls_IndAltaBaja = '1' Then
		If f_verifica_pago_boleta(lol_CodiPersona, w$_periodo, '%' ) > 0 Then
			lb_SavePago=True
		Else
			lb_SavePago=False
		End If
	End If	
	
	If lb_SavePago Then
		if w$_fechainicio<=w%_finperiodo then
			// Ya no habrá regularizaciones de subsidio - RQ 00047
				
			INSERT INTO RTPS_AR16_NOT 
				(
					TIPODOC,
					NUMDOC,
					TIPODIAS ,
					FECHAINICIO,
					FECHAFIN,
					PERIODO,
					COMPANIASOCIO, 
					TIPOINGRESO,
					INDERROR,
					UltimoUsuario,
					UltimaFechaModif,
				NUMERODIAS // RQ 00047
			) 
			VALUES
			(:w$_tipodoc,:w$_numdoc,:w$_tipodias, :w$_fechainicio, :w$_fechafin, // RQ 00047
				:iv$_periodo,:w$_company,'A','N',
				:str_global.gv_userid,:w%_hoy,
				:li_dias) // RQ 00047
			USING SQLCA;
				
			if sqlca.sqlcode < 0 then
				w$_msg = sqlca.sqlerrtext
				rollback;
				f_msg(w$_msg)
				return -1
			end if
	
		end if	
	End If
		  
	uo_progress.uf_Set_Position( w%_fila / w%_rowcount * 100 )
Next 	
	
COMMIT;


RETURN 0
end function

public function integer wf_procesa_ar2_edd ();long w%_fila,w%_rowcount 
string W$_COMPANY
string w$_RUCEMPRESADESTACO,w$_RAZONSOCIAL, w$_CODIGOACTIVIDAD
STRING w$_DENOMINACION, w$_INDCENTRORIESGO, w$_TASA

w$_company =left (iv$_CompaniaSocio,8) 
	
//edd	
dw_source_02_edd.SetTransObject(SQLCA)
dw_source_02_edd.retrieve()
w%_rowcount=dw_source_02_edd.rowcount()

DELETE FROM RTPS_AR2_EDD
WHERE PERIODO = :iv$_periodo
AND COMPANIASOCIO =:W$_COMPANY
AND TIPOINGRESO='A'
USING SQLCA;

if sqlca.sqlcode < 0 then
	string w$_msg
	w$_msg = sqlca.sqlerrtext
	rollback;
	f_msg(w$_msg)
	return -1
end if

COMMIT;

datetime w%_hoy
w%_hoy = f_today()

For w%_fila=1 to w%_rowcount 
	w$_RUCEMPRESADESTACO=f_nonulo_str(dw_source_02_edd.GetitemString(w%_fila,'rucempresa'))
	w$_RAZONSOCIAL=f_nonulo_str(dw_source_02_edd.GetitemString(w%_fila,'razonsocial'))
	w$_CODIGOACTIVIDAD=f_nonulo_str(dw_source_02_edd.Getitemstring(w%_fila,'codigoactividad'))

	INSERT INTO RTPS_AR2_EDD
		(RUCEMPRESADESTACO,
		RAZONSOCIAL,
		CODIGOACTIVIDAD,
		PERIODO,	
		COMPANIASOCIO ,	
		TIPOINGRESO,	
		INDERROR ,
		UltimoUsuario ,
		UltimaFechaModif)
	VALUES
	(:w$_RUCEMPRESADESTACO,:w$_RAZONSOCIAL,:w$_CODIGOACTIVIDAD,
	:iv$_periodo,:w$_company,'A','N',
	:str_global.gv_userid,:w%_hoy)
	USING SQLCA;
	
	if sqlca.sqlcode < 0 then
		w$_msg = sqlca.sqlerrtext
		rollback;
		f_msg(w$_msg)
		return -1
	end if

Next 	

COMMIT;

RETURN 0
end function

public function integer wf_procesa_ar2_sdd ();long w%_fila,w%_rowcount 
string W$_COMPANY
string w$_RUCEMPRESADESTACO,w$_RAZONSOCIAL, w$_CODIGOACTIVIDAD
STRING w$_DENOMINACION, w$_INDCENTRORIESGO
decimal w$_TASA

w$_company =left (iv$_CompaniaSocio,8) 
	
//sdd	
dw_source_02_sdd.SetTransObject(SQLCA)
dw_source_02_sdd.retrieve()
w%_rowcount=dw_source_02_sdd.rowcount()

DELETE FROM RTPS_AR2_SDD
WHERE PERIODO = :iv$_periodo
AND COMPANIASOCIO =:W$_COMPANY
AND TIPOINGRESO='A'
USING SQLCA;

if sqlca.sqlcode < 0 then
	string w$_msg
	w$_msg = sqlca.sqlerrtext
	rollback;
	f_msg(w$_msg)
	return -1
end if

COMMIT;

datetime w%_hoy
w%_hoy = f_today()
For w%_fila=1 to w%_rowcount 
	w$_RUCEMPRESADESTACO=f_nonulo_str(dw_source_02_sdd.GetitemString(w%_fila,1))
	w$_DENOMINACION=f_nonulo_str(dw_source_02_sdd.GetitemString(w%_fila,2))
	w$_INDCENTRORIESGO=f_nonulo_str(dw_source_02_sdd.GetitemString(w%_fila,3))
	w$_TASA=dw_source_02_sdd.GetitemNumber(w%_fila,4)

	INSERT INTO RTPS_AR2_SDD
		(RUCEMPRESADESTACO,
		DENOMESTABLECIMIENTO,
		INDCENTRORIESGO,
		TASA,
		PERIODO,	
		COMPANIASOCIO ,	
		TIPOINGRESO,	
		INDERROR ,
		UltimoUsuario ,
		UltimaFechaModif)
	VALUES
	(:w$_RUCEMPRESADESTACO,:w$_DENOMINACION,:w$_INDCENTRORIESGO,:w$_TASA,
	:iv$_periodo,:w$_company,'A','N',
	:str_global.gv_userid,:w%_hoy)
	USING SQLCA;
	
	if sqlca.sqlcode < 0 then
		w$_msg = sqlca.sqlerrtext
		rollback;
		f_msg(w$_msg)
		return -1
	end if
	
Next 	

if sqlca.sqlcode < 0 then
	messagebox('Error',sqlca.sqlerrtext)
	rollback;
else	
	COMMIT;
end if

RETURN 0
end function

public function integer wf_procesa_ar19 ();/*
------------------------------------------------------------------------------------------------------
Objeto					: wf_procesa_ar19
Objetivo					: Procesa la información del archivo 19
Autor						: 
Fecha						: 
Nro. RQ					: 
Parámetros Entrada	: Ninguno
Parámetros Salida		: Ninguno
Observación				: Ninguno
------------------------------------------------------------------------------------------------------
Modificaciones
Nro. RQ		Fecha			Usuario			Descripción
------------------------------------------------------------------------------------------------------
RQ 00047		20/08/2012	JCOAGUILAP		Actualiza el tipo de archivo
------------------------------------------------------------------------------------------------------
*/
long w%_fila,w%_rowcount
string W$_COMPANY,w$_periodo
string w$_tipodoc,w$_numdoc,w$_codigoconcepto
double w%_montodev, w%_montopag
 
w$_periodo =iv$_periodo+mid(iv$_periodo,5,2)
w$_company =left (iv$_CompaniaSocio,8) 
dw_source_19.SetTransObject(SQLCA)
dw_source_19.retrieve(w$_company,w$_periodo,'%%', '%%%')
w%_rowcount=dw_source_19.rowcount()

DELETE FROM RTPS_AR19_PEN
WHERE PERIODO = :iv$_periodo
AND COMPANIASOCIO =:W$_COMPANY
AND TIPOINGRESO='A'
USING SQLCA;

if sqlca.sqlcode < 0 then
	string w$_msg
	w$_msg = sqlca.sqlerrtext
	rollback;
	f_msg(w$_msg)
	return -1
end if

COMMIT;

uo_progress.uf_Set_Position(0)
uo_progress.uf_Check(FALSE)					

datetime w%_hoy
w%_hoy = f_today()

For w%_fila=1 to w%_rowcount 

	w$_tipodoc=Right('00'+f_nonull_left(wf_tipodocumento(dw_source_19.GetitemString(w%_fila,'TipoDocumento')), 2), 2) 
	w$_numdoc=f_nonull_left(dw_source_19.GetitemString(w%_fila,'Documento'), 15)
	w$_codigoconcepto=f_nonull_left(dw_source_19.GetitemString(w%_fila,'codcon'), 4)
	w%_montopag=dw_source_19.GetitemDecimal(w%_fila,'monto')
	w%_montodev=dw_source_19.GetitemDecimal(w%_fila,'monto')
	
	CHOOSE CASE w$_codigoconcepto
		CASE '0604','0610'
			//..........
		CASE ELSE
			INSERT INTO RTPS_AR19_PEN
			(	TIPODOC,		NUMDOC,
				CODCON,		MONTODEV,
				MONTOPAG,		PERIODO,
				COMPANIASOCIO, TIPOINGRESO,
				INDERROR,		UltimoUsuario,
				UltimaFechaModif
			) 
			VALUES
			(	:w$_tipodoc,:w$_numdoc,
				:w$_codigoconcepto,:w%_montodev,
				:w%_montopag,:iv$_periodo,
				:w$_company,'A',
				'N',:str_global.gv_userid,
				:w%_hoy
			)
			USING SQLCA;
				
			if sqlca.sqlcode < 0 then
				w$_msg = sqlca.sqlerrtext
				rollback;
				f_msg(w$_msg)
				return -1
			end if
	
	END CHOOSE

	

	uo_progress.uf_Set_Position( w%_fila / w%_rowcount * 100 )

Next 	
	
COMMIT;

uo_progress.uf_Set_Position(100)
uo_progress.uf_Check(TRUE)

RETURN 0
end function

public function string wf_essaludperiodo (long ai_empleado, string as_periodo);integer w%_total 
string w$_flag

SELECT count(*) into :w%_total FROM PR_PLANILLAEMPLEADOCONCEPTO
WHERE EMPLEADO =abs(:ai_empleado)
AND concepto='5500' 
AND PERIODO=:as_periodo AND monto>0;

if w%_total >0 then 		
	w$_flag='1'
else
	w$_flag='0'
end if 

return w$_flag


end function

public function integer wf_procesa_ar20 ();/*
------------------------------------------------------------------------------------------------------
Objeto					: wf_procesa_ar20
Objetivo					: Procesa la información del archivo 20
Autor						: 
Fecha						: 
Nro. RQ					: 
Parámetros Entrada	: Ninguno
Parámetros Salida		: Ninguno
Observación				: Ninguno
------------------------------------------------------------------------------------------------------
Modificaciones
Nro. RQ		Fecha			Usuario			Descripción
------------------------------------------------------------------------------------------------------
RQ 00047		20/08/2012	JCOAGUILAP		Actualiza el tipo de archivo
------------------------------------------------------------------------------------------------------
*/
long w%_fila,w%_rowcount, w%uap
string ls_CodiCia,w$_periodo, ls_periodo, ls_IndLogistica
string w$_tipodoc,w$_numdoc,w$_codigoconcepto,w$_tipocomprobante,w$_serie,w$_numero,w$_indicador,w$_tipoplanilla,w$_tipoproceso
string w$_moneda
double w%_tipocambio,w%_nuevotipocambio
double w%_montodev, w%_montopag,w%_montoimpuesto, ldb_MntRegPen
datetime w%_fechaemision, w%_fechapago
datetime w%_hoy
string w$_msg
String ls_domiciliado, ls_ruc, ls_serie,ls_IndRetRegPen // RQ 00047

dw_filtro.accepttext( )

ls_IndLogistica = dw_filtro.object.ind_logistica[1]

ls_periodo =iv$_periodo+mid(iv$_periodo,5,2)
ls_CodiCia =left (iv$_CompaniaSocio,8) 

IF ls_IndLogistica = '1' THEN
	dw_source_20.dataOBject="dw_pe_procesa_ar20_4ta_log"
	dw_source_20.SetTransObject(SQLCA)
	dw_source_20.retrieve(Left(ls_CodiCia,6),Left(ls_periodo,6))
ELSE
	dw_source_20.dataOBject="dw_pe_procesa_ar20_4ta"
	dw_source_20.SetTransObject(SQLCA)
	dw_source_20.retrieve(ls_CodiCia,ls_periodo)
END IF

w%_rowcount=dw_source_20.rowcount()

DELETE FROM RTPS_AR20_4TA 
WHERE PERIODO = :iv$_periodo
AND COMPANIASOCIO =:ls_CodiCia
AND TIPOINGRESO='A'
USING SQLCA;

if sqlca.sqlcode < 0 then
	w$_msg = sqlca.sqlerrtext
	rollback;
	f_msg(w$_msg)
	return -1
end if

COMMIT;

uo_progress.uf_Set_Position(0)
uo_progress.uf_Check(FALSE)					

w%_hoy = f_today()

For w%_fila=1 to w%_rowcount
	ls_domiciliado = f_nonull_left(dw_source_20.GetitemString(w%_fila,'flagdomiciliado'), 1)
	ls_ruc = f_nonull_left(dw_source_20.GetitemString(w%_fila,'documentofiscal'), 11)
	If ls_domiciliado = '1' Then
		w$_tipodoc = '06' // Tipo de documento RUC
		w$_numdoc = ls_ruc
	Else
		w$_tipodoc = Right('00'+f_nonull_left(wf_tipodocumento(dw_source_20.GetitemString(w%_fila,'tipodocumento')), 2), 2)
		w$_numdoc = f_nonull_left(dw_source_20.GetitemString(w%_fila,'documento'), 15)	
	End If	
	w$_tipocomprobante=f_nonull_left(dw_source_20.GetitemString(w%_fila,'tipocomprobante'), 1)
		
	IF UPPER(MID(dw_source_20.GetitemString(w%_fila,'nroserie'), 1,1)) = 'E' THEN
		w$_serie=Right('0000'+f_nonull_left(dw_source_20.GetitemString(w%_fila,'nroserie'), 4), 4)
	ELSE
		w$_serie=Right('000'+f_nonull_left(dw_source_20.GetitemString(w%_fila,'nroserie'), 3), 3)
	END IF
	w$_numero=Right('00000000'+f_nonull_left(dw_source_20.GetitemString(w%_fila,'nrorecibo'), 8), 8)
	w$_tipoplanilla=f_nonulo_str(dw_source_20.GetitemString(w%_fila,'tipoplanilla'))
	w$_tipoproceso=f_nonulo_str(dw_source_20.GetitemString(w%_fila,'tipoproceso'))
     w%_fechaemision=dw_source_20.GetitemDateTime(w%_fila,'fechaemision')
     w%_fechapago=dw_source_20.GetitemDateTime(w%_fila,'fechapago')  		
	w$_indicador=f_nonull_left(dw_source_20.GetitemString(w%_fila,'retencion'), 1) // RQ 00047
	w%_montopag=dw_source_20.GetitemDecimal(w%_fila,'pago') 
	
	ls_IndRetRegPen=f_nonull_left(dw_source_20.GetitemString(w%_fila,'IndRetRegPen'), 1) 
	ldb_MntRegPen=dw_source_20.GetitemDecimal(w%_fila,'ImporteRegPen') 
	
	IF ls_IndRetRegPen = '2' AND ldb_MntRegPen <= 0 THEN
		ls_IndRetRegPen='3'
	END IF
			
	IF Date(w%_fechapago)  < Date(w%_fechaemision) THEN
		w%_fechapago = w%_fechaemision
	END IF
		
	 
	INSERT INTO RTPS_AR20_4TA
	(	TIPODOC,		NUMDOC,TIPOCOMPROBANTE,
		SERIECOMPROBANTE, NUMEROCOMPROBANTE,
		MONTO, 	FECHAEMISION, FECHAPAGO,INDRETENCION,
		PERIODO,
		COMPANIASOCIO, 		TIPOINGRESO,
		INDERROR,		UltimoUsuario,
		UltimaFechaModif,TIPOPLANILLA,TIPOPROCESO,
		IndRetRegPen, MontoRegPen			 
   ) 
	VALUES
	(	:w$_tipodoc,:w$_numdoc,:w$_tipocomprobante,
		:w$_serie,:w$_numero,:w%_montopag,:w%_fechaemision,
		:w%_fechapago,:w$_indicador,	
		:iv$_periodo,:ls_CodiCia,'A',
		'N',:str_global.gv_userid,
		:w%_hoy,:w$_tipoplanilla,:w$_tipoproceso,
		:ls_IndRetRegPen, :ldb_MntRegPen)
	USING SQLCA;
	
	if sqlca.sqlcode < 0 then
		w$_msg = sqlca.sqlerrtext
		rollback;
		f_msg(w$_msg)
		return -1
	end if
	
	COMMIT;
	uo_progress.uf_Set_Position( w%_fila / w%_rowcount * 100 )
Next 	

uo_progress.uf_Set_Position(100)
uo_progress.uf_Check(TRUE)

RETURN 0
end function

public function datetime wf_fechaliquidacion (integer ai_empleado);datetime w%_fechaliquidacion
string w$_flag


//inicializacion de variable
setnull(w%_fechaliquidacion)
SELECT fechaliquidacion into :w%_fechaliquidacion FROM empleadomast
WHERE EMPLEADO=:ai_empleado*-1;


return w%_fechaliquidacion		
end function

public function datetime wf_fechaingresoperiodo (long ai_empleado, string as_periodo, datetime as_fechacese, string as_estado);integer w%_total 
string w$_flag
datetime w%_fecha
//julio 2008 se añade rutina para los cesados en cuanto al inicio de periodo
if as_estado='0' then 
  SELECT max(fechaingresoboleta) 
  INTO :w%_fecha 
  FROM PR_PLANILLAEMPLEADO
  WHERE EMPLEADO=abs(:ai_empleado) 
  AND PERIODO=:as_periodo;
else 
  SELECT max(fechaingresoboleta) 
  INTO :w%_fecha 
  FROM PR_PLANILLAEMPLEADO
  WHERE EMPLEADO=abs(:ai_empleado) 
  AND PERIODO=:as_periodo 
  AND fechageneracion<:as_fechacese;
end if
return w%_fecha
end function

public function integer wf_procesa_ar18 ();/*
----------------------------------------------------------------------------------------------------------------------------------------------------------
Objeto            	: wf_procesa_ar18()
Objetivo      			: Genera la data para el archivo REM
Autor             	: PYOVERA
Fecha						: 13/01/2012
Nro. RQ					: ###
Parámetros Entrada	: Ninguno
Parámetros Salida		:  1  ==> Función culminó satisfactóriamente
                       -1  ==> Función No culminó satisfactóriamente
Observación   			: Ninguna
----------------------------------------------------------------------------------------------------------------------------------------------------------
Modificaciones
Nro. RQ		Fecha       Usuario        Descripción
----------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------
*/
Long 		lol_Fila, lol_Filas, lol_existe, ll_ExisPagoAfp
String		los_CodiCia, los_CodiPeriodo, los_TipoDocu, los_NumeDocu, los_CodiConcepto, los_CodiCategoria, &
			los_CodiSistPens, los_Message, los_MontoDeven, los_MontoPagado, los_CodiConcAdicional, &
			los_MntEpsProporcional, los_CodiAfilEps, ls_PeriAntPost
Double 	lodb_MontoDevengado, lodb_MontoPagado,lodb_MntEps,lodb_MntEpsProporcional, lodb_MntoRefMinimo, lodb_RemMinVit
DateTime lodt_FechaDia
Boolean  lob_IncluirConcepto = True, lb_SavePago

los_CodiPeriodo 	= iv$_periodo+mid(iv$_periodo,5,2)
los_CodiCia 			= left (iv$_CompaniaSocio,8)
ls_PeriAntPost 		= is_PeriAntePost + mid(is_PeriAntePost,5,2)

dw_source_18.SetTransObject(SQLCA)
dw_source_18.retrieve(los_CodiCia,los_CodiPeriodo,is_PeriAntePost, is_IndiPeriodo,is_ft_PlaniProc,is_ft_PlaniProcAP,is_ft_FlagIncluir)

lol_Filas		=dw_source_18.rowcount()

DELETE FROM RTPS_AR18_REM
WHERE PERIODO = :iv$_periodo
AND COMPANIASOCIO =:los_CodiCia
AND TIPOINGRESO='A'
USING SQLCA;

if sqlca.sqlcode < 0 then	
	los_Message = sqlca.sqlerrtext
	Rollback;
	f_msg(los_Message)
	Return -1
end if

COMMIT;

lodb_RemMinVit = f_get_valor_global('REMMIN', iv$_periodo)

uo_progress.uf_Set_Position(0)
uo_progress.uf_Check(FALSE)					

lodt_FechaDia = f_today()

For lol_Fila=1 to lol_Filas 
	lob_IncluirConcepto = True
	los_TipoDocu			=Right('00'+f_nonull_left(wf_tipodocumento(dw_source_18.GetitemString(lol_Fila,'TipoDocumento')), 2), 2)
	los_NumeDocu			=f_nonull_left(dw_source_18.GetitemString(lol_Fila,'Documento'), 15)
	los_CodiConcepto		=f_nonull_left(dw_source_18.GetitemString(lol_Fila,'Concepto'), 4)
	lodb_MontoDevengado=dw_source_18.GetitemDecimal(lol_Fila,'montodevengado')
	lodb_MontoPagado	=dw_source_18.GetitemDecimal(lol_Fila,'montopagado')
	los_MontoDeven		=dw_source_18.GetitemString(lol_Fila,'MntoCadena')
	los_CodiCategoria 		=dw_source_18.GetitemString(lol_Fila,'categoriatrabajador')
	
	los_MontoPagado = los_MontoDeven

	if IsNull(lodb_MontoDevengado) Then lodb_MontoDevengado = 0.00
	if IsNull(lodb_MontoPagado) Then lodb_MontoPagado = 0.00
	
	SetNull(los_CodiSistPens)
	//Buscamos si el trabajador está afiliado al S.P.P
	SELECT E.TipoPension INTO	   	:los_CodiSistPens
	FROM PersonaMast P, EmpleadoMast E
	WHERE P.Persona = E.Empleado
	AND P.Documento =  :los_NumeDocu
	AND E.Empleado > 0
	AND E.Estado = 'A' AND E.EstadoEmpleado<>'2'  USING SQLCA;
	
	IF SQLCA.SQLCODE < 0 THEN
		SetNull(los_CodiSistPens)
	END IF
	
	IF IsNull(los_CodiSistPens) OR TRIM(los_CodiSistPens)= '' THEN
		SELECT TOP 1 E.TipoPension INTO	   	:los_CodiSistPens
		FROM PersonaMast P, EmpleadoMast E
		WHERE P.Persona = E.Empleado
		AND P.Documento =  :los_NumeDocu
		AND E.Empleado > 0
		AND E.FechaIngreso IN (SELECT MAX(E.FechaIngreso)
										FROM PersonaMast P, EmpleadoMast E
										WHERE P.Persona = E.Empleado
										AND P.Documento =  :los_NumeDocu
										AND E.Empleado > 0)  USING SQLCA;
		if sqlca.sqlcode < 0 then	
			los_Message = sqlca.sqlerrtext
			los_Message = los_Message + '  ' +los_NumeDocu
			f_msg(los_Message + '   Error al obtener Reg.Pensionario')	
			Return -1
		end if
	END IF
	
	Choose Case los_CodiSistPens
		Case 'PRI' 
			//Si el trabajador está en el S.P.P, el concepto  0601,0606,0608 y 0609 se registra
			if los_CodiConcepto = '0601' OR los_CodiConcepto='0606' OR los_CodiConcepto='0608' OR los_CodiConcepto='0609' then
				//Consultamos si a pesar de estar en la maestra en AFP, se le paga por AFP o S.P.P
				SELECT COUNT(1) INTO :ll_ExisPagoAfp
				FROM PersonaMast P, PR_PlanillaEmpleadoConcepto	E
				WHERE P.Persona = E.Empleado
				AND E.Periodo= :los_CodiPeriodo
				AND P.Documento =  :los_NumeDocu
				AND E.Concepto='5260'  USING SQLCA;
				if sqlca.sqlcode < 0 then	
					ll_ExisPagoAfp=0
					los_Message = sqlca.sqlerrtext
					los_Message = los_Message + '  ' +los_NumeDocu
					f_msg(los_Message + '   Error al obtener Pago por AFP ' + los_NumeDocu)	
					Return -1
				end if
				lob_IncluirConcepto = False
				If ll_ExisPagoAfp > 0 then
					lob_IncluirConcepto = True
				End If
			end if
			//No se registra el codigo 0613
			if los_CodiConcepto = '0613' then
				lob_IncluirConcepto = False
			end if
		Case else
			lob_IncluirConcepto = True	
			//Si el trabajador está en el Sist. pensiones 20530, el concepto  0613 se registra
			if los_CodiSistPens <> 'DLR' and los_CodiConcepto = '0613' then
				lob_IncluirConcepto = False
			end if
			if los_CodiConcepto = '0601' OR los_CodiConcepto='0606' OR los_CodiConcepto='0608' OR los_CodiConcepto='0609' then
				lob_IncluirConcepto = False
				
				SELECT COUNT(1) INTO :ll_ExisPagoAfp
				FROM PersonaMast P, PR_PlanillaEmpleadoConcepto	E
				WHERE P.Persona = E.Empleado
				AND E.Periodo= :los_CodiPeriodo
				AND P.Documento =  :los_NumeDocu
				AND E.Concepto='5260'  USING SQLCA;
				
				If ll_ExisPagoAfp > 0 then
					lob_IncluirConcepto = True
				End If								
			end if					
	End Choose

	//Solo para las altas verifica que tenga pago en el periodo para registrarlo en el T-registro
	lb_SavePago = True
	If f_verifica_pago_boleta_docu(los_CodiPeriodo, '%' , los_NumeDocu) > 0 Then
		lb_SavePago=True
	Else
		lb_SavePago=False
	End If
	
	If lb_SavePago Then

		IF lob_IncluirConcepto = True THEN	
			Choose Case los_CodiConcepto
				Case '0604', '0607', '0804','0809' 
					//..				
				Case Else
					INSERT INTO RTPS_AR18_REM
					(	TIPODOC,				NUMDOC,				CODCON,		
						MONTODEV,				MONTOPAG,				PERIODO,
						COMPANIASOCIO, 	TIPOINGRESO,			INDERROR,		
						UltimoUsuario,			UltimaFechaModif,		MontoDeven,
						MontoPagado
					) 
					VALUES
					(	:los_TipoDocu,				:los_NumeDocu,		:los_CodiConcepto,
						:lodb_MontoDevengado,	:lodb_MontoPagado,	:iv$_periodo,
						:los_CodiCia,				'A',						'N',
						:str_global.gv_userid,		:lodt_FechaDia,			:los_MontoDeven,
						:los_MontoPagado
					)
					USING SQLCA;
		
					if sqlca.sqlcode < 0 then
						los_Message = sqlca.sqlerrtext
						rollback;
						f_msg(los_Message)
						Return -1
					end if
			End Choose		
		END IF
	End If
	uo_progress.uf_Set_Position( lol_Fila / lol_Filas * 100 )

Next 	

DELETE FROM RTPS_AR18_REM
WHERE PERIODO = :iv$_periodo
AND COMPANIASOCIO =:los_CodiCia
AND TIPOINGRESO='A' AND LEN(LTRIM(RTRIM(CODCON))) = 0
USING SQLCA;

COMMIT;

uo_progress.uf_Set_Position(100)
uo_progress.uf_Check(TRUE)

Return 0
end function

public function boolean wf_indiultimomov (string ags_periodo, long agl_codiempleado, date agd_fecingreso);/*
----------------------------------------------------------------------------------------------------------------------------------------------------------
Objeto                 	: wf_indiultimomov()
Objetivo      			: Identifica si el registro que se esta leyendó corresponde a la Boleta Con los Datos Mas recientes del Trabajdor en el Periodo
Autor                   	: PYOVERA
Fecha					: 16/01/2012
Nro. RQ				: ###
Parámetros Entrada	: Ninguno
Parámetros Salida		:  TRUE   ==> Mas reciente
                                   FALSE  ==> No es la mas reciente en el periodo
Observación   		: Ninguna
----------------------------------------------------------------------------------------------------------------------------------------------------------
Modificaciones
Nro. RQ					Fecha               Usuario                                                   Descripción
----------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------
*/
Boolean			lob_UltimoMovimiento
DateTime		lodt_FecIngUltMov
String				los_Message

SELECT 	MAX(A.FechaIngresoBoleta)
INTO      :lodt_FecIngUltMov
FROM 	PR_PlanillaEmpleado A 
WHERE 	A.periodo = :ags_periodo
AND 		A.Empleado =:agl_CodiEmpleado 
AND 		A.TipoProceso NOT IN ('C10','C11','C12','C13','C14','C15','C16','C17','C18','C19','C20','CDI','CO0','CO1','CO2','CO3','CO4','CO5','CO6','CT1','CT2','CT3','CT4','CT5','CT6','CT7',
											'CT8','CT9','CTS','CTZ','MDI','MO0','MO1','MO2','MRE','OT1','OT2','P10','P11','P12','P13','P14','P15','P16','P17','P18','P19','P20','PC1','PR0','RD1','RDI','RE0',
											'RE1','REM','RM1','RP1','RP2','RP3','RP4','RP5','RP6','RP7','RP8','RP9','RTL','SJ1','SJ2','SJ3','SJ4','SJ5','SJ6','SP0','SP1','SP2','SP3')
Using Sqlca;
if sqlca.sqlcode < 0 then	
	los_Message = sqlca.sqlerrtext
	f_msg(los_Message)
	lob_UltimoMovimiento = FALSE	
end if

IF DATE(lodt_FecIngUltMov)  =  agd_FecIngreso THEN
	lob_UltimoMovimiento = TRUE
ELSE
	lob_UltimoMovimiento = FALSE	
END IF

Return lob_UltimoMovimiento
end function

public function double wf_verificaaniosesvida (long agl_empleado, string ags_empleado, datetime agdt_fechanacimiento, datetime agdt_fechafinperiodo);/*
----------------------------------------------------------------------------------------------------------------------------------------------------------
Objeto                 	: wf_verificaaniosesvida()
Objetivo      			: Devuelve el numero de años cumplidos en el periodo trabajado
Autor                   	: PYOVERA
Fecha					: 13/01/2012
Nro. RQ				: ###
Parámetros Entrada	: Ninguno
Parámetros Salida		: Ninguno
Observación   		: El PDT valida que solo podran afiliarse a Essalud Vida a los trabajdores entre los 15 y 80 años
----------------------------------------------------------------------------------------------------------------------------------------------------------
Modificaciones
Nro. RQ					Fecha               Usuario                                                   Descripción
----------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------
*/

Integer	loi_dias
Double	lodb_AniosPeriodo

loi_dias= Daysafter(Date(agdt_fechanacimiento),Date(agdt_fechafinperiodo) )

if loi_dias < 365 then
	lodb_AniosPeriodo=0.00
else
	lodb_AniosPeriodo= loi_dias/365
end if


Return lodb_AniosPeriodo
end function

public function string wf_regimen_pensionario (string ags_codipension, string ags_codiafp, datetime agdt_feciniregpens, long agl_empleado, string ags_periodo);String 	los_retorno, los_Periodo, los_PeriRegPens
Double	lodb_jubilado
Boolean	lob_SinRegimen=False

los_Periodo=Mid(ags_periodo,1,6)
los_PeriRegPens=String(Date(agdt_feciniregpens),'YYYYMM')

SELECT A.Valor INTO :lodb_jubilado
FROM PR_ConceptoPersonalEmpleado A
INNER JOIN PR_ConceptoPersonal  B
		ON (A.Concepto = B.Concepto)
WHERE A.Empleado = Abs(:agl_empleado)
AND A.Concepto = 'JUBI' USING SQLCA;

if SQLCA.sqlcode < 0 then	
	lodb_jubilado=0
end if

if IsNull(lodb_jubilado) Then lodb_jubilado=0

IF lodb_jubilado=0 THEN

	SELECT MA_MiscelaneosDetalle.ValorCodigo1  
	INTO :los_retorno
	FROM MA_MiscelaneosDetalle  
	WHERE ( MA_MiscelaneosDetalle.AplicacionCodigo = 'PR' ) AND  
	( MA_MiscelaneosDetalle.CodigoTabla = 'REGPENSI' ) AND  
	( MA_MiscelaneosDetalle.Compania = '999999' ) AND  
	( MA_MiscelaneosDetalle.CodigoElemento = :ags_CodiPension ) ;
	
	if los_retorno='1' then // S.P.P		
		//verificamos si se pago en el periodo informado al S.P.P
		if f_ConceptoPagadoPeriodo(agl_empleado,ags_periodo,'5260') = '1' then
			SELECT codigoRTPS 
			INTO :los_retorno  
			FROM HR_AFP  
			WHERE CodigoAfp= :ags_CodiAfp;
		else
			//no se pago al S.P.P, se pago al S.N.P(cambio reciente de reg. pensionario) ??
			if f_ConceptoPagadoPeriodo(agl_empleado,ags_periodo,'5030') = '1' then
				los_retorno = '2'
			else
				//validamos si la fecha de inscripicon al actual regimen pensionario esta dentro del periodo informado
				if  los_Periodo >= los_PeriRegPens then
					SELECT codigoRTPS 
					INTO :los_retorno  
					FROM HR_AFP  
					WHERE CodigoAfp= :ags_CodiAfp;
				end if
			end if
		end if			
	end if
	if los_retorno='2' then // S.N.P		
			//verificamos si se pago en el periodo informado al S.N.P
			if f_ConceptoPagadoPeriodo(agl_empleado,ags_periodo,'5030') = '0' then
				//no se pago al S.N.P, (se cambio al S.P.P), se pagó al S.P.P ??
				if f_ConceptoPagadoPeriodo(agl_empleado,ags_periodo,'5260') = '1' then
					SELECT codigoRTPS 
					INTO :los_retorno
					FROM HR_AFP  
					WHERE CodigoAfp= :ags_CodiAfp;
				end if
			else
				if  los_Periodo >= los_PeriRegPens then
					los_retorno='2'
				end if				
			end if			
	end if	
ELSE
	//Esta jubilado por tanto ya no aporta a la AFP
	los_retorno = '99'
END IF

Return right ('0' + trim (los_retorno),2)


end function

public subroutine wf_depurapensionista (string ags_periodo, string ags_dato);/*
------------------------------------------------------------------------------------------------------
Objeto					: wf_procesa_ar14
Objetivo					: Depura la información de los pensionistas
Autor						: 
Fecha						: 
Nro. RQ					: 
Parámetros Entrada	: Periodo, Dato
Parámetros Salida		: Ninguno
Observación				: Ninguno
------------------------------------------------------------------------------------------------------
Modificaciones
Nro. RQ		Fecha			Usuario			Descripción
------------------------------------------------------------------------------------------------------
RQ 00047		08/08/2012	JCOAGUILAP		Actualiza el tipo de archivo
------------------------------------------------------------------------------------------------------
*/
String		los_NumeroDocum
Long		lol_fila
DateTime	lodt_FecInicio
DataStore lods_1


lods_1 = Create DataStore
lods_1.dataobject = 'ds_pe_penscondospens'
lods_1.settransobject( sqlca )

//De los pensionistas que reciebn 2 pensiones, los datos en el archivo primaran los del pensionista como jubilacion, mas no como viudez
long lol_reg
Choose Case ags_dato
	Case 'PEN' // RQ 00047
		lods_1.retrieve( ags_periodo, ags_dato )
		for lol_fila=1 to lods_1.rowcount( )
	
			los_NumeroDocum = lods_1.object.numerodoc[lol_fila]
			
			SELECT B.FechaInicioPension 
			INTO		:lodt_FecInicio
			FROM PersonaMast A, EmpleadoMast B
			WHERE A.Persona=B.Empleado
			AND B.TipoPlanilla = 'PE'
			AND B.tipopensionista = 'T'
			AND A.Documento = :los_NumeroDocum Using Sqlca;
			
			DELETE FROM RTPS_AR6_T02
			WHERE PERIODO = :ags_periodo
			AND NUMERODOC = :los_NumeroDocum
			AND FECHAREGPENSION <> :lodt_FecInicio Using Sqlca;
			
			COMMIT USING SQLCA;
				
		next
	Case 'PER' // RQ 00047
		lol_reg =lods_1.retrieve( ags_periodo, ags_dato )
		for lol_fila=1 to lods_1.rowcount( )
	
			los_NumeroDocum = lods_1.object.numerodoc[lol_fila]
			
			SELECT B.FechaIngreso 
			INTO		:lodt_FecInicio
			FROM PersonaMast A, EmpleadoMast B
			WHERE A.Persona=B.Empleado
			AND B.TipoPlanilla = 'PE'
			AND B.tipopensionista = 'T'
			AND A.Documento = :los_NumeroDocum Using Sqlca;
			
			SELECT COUNT(1)
			INTO :lol_reg
			FROM RTPS_AR11_P00
			WHERE PERIODO = :ags_periodo
			AND NUMDOC = :los_NumeroDocum
			AND FECHAINICIO <> :lodt_FecInicio Using Sqlca;
			
			DELETE FROM RTPS_AR11_P00
			WHERE PERIODO = :ags_periodo
			AND NUMDOC = :los_NumeroDocum
			AND FECHAINICIO <> :lodt_FecInicio Using Sqlca;
			
			if sqlca.sqlcode < 0 then
				messagebox('Error BD', sqlca.sqlerrtext)
			end if
			
			COMMIT USING SQLCA;
				
		next
Case 'IDE' 
		lol_reg =lods_1.retrieve( ags_periodo, ags_dato )
		for lol_fila=1 to lods_1.rowcount( )
	
			los_NumeroDocum = lods_1.object.numerodoc[lol_fila]
			
			SELECT B.FechaIngreso 
			INTO		:lodt_FecInicio
			FROM PersonaMast A, EmpleadoMast B
			WHERE A.Persona=B.Empleado
			AND B.TipoPlanilla = 'PE'
			AND B.tipopensionista = 'T'
			AND A.Documento = :los_NumeroDocum Using Sqlca;

			SELECT COUNT(1)
			INTO :lol_reg
			FROM RTPS_AR11_P00
			WHERE PERIODO = :ags_periodo
			AND NUMDOC = :los_NumeroDocum
			AND FECHAINICIO <> :lodt_FecInicio Using Sqlca;
			
			DELETE FROM RTPS_AR4_T00
			WHERE PERIODO = :ags_periodo
			AND NUMERODOC = :los_NumeroDocum
			AND FECHAINICIO <> :lodt_FecInicio Using Sqlca;
	
			
			if sqlca.sqlcode < 0 then
				messagebox('Error BD', sqlca.sqlerrtext)
			end if
			
			COMMIT USING SQLCA;
				
		next			
End Choose


end subroutine

public function string wf_estadoempleado (long agl_empleado, string ags_estadoempleado, string ags_periodo, datetime agdt_fechacese, datetime agdt_fechaliqui, datetime agdt_iniperiodo, datetime agdt_finperiodo);String		los_EstadoEmpleado, los_EstadoEmpleadoPeriodo
 Boolean  lob_ExisteLiquidacion, lob_existepago
 
//Si la fecha es nula, busco si se le hizo una liquidacion en el mes
 IF  IsNull(agdt_fechaliqui)  THEN
	//Busco si se le pago liquidacion o devengado(si fue CAS) en el periodo
	if f_verifica_pago_boleta(agl_empleado,ags_periodo,'LI') > 0 or f_verifica_pago_boleta(agl_empleado,ags_periodo,'DV') > 0 or &
	   f_verifica_pago_boleta(agl_empleado,ags_periodo,'FA') > 0 or f_verifica_pago_boleta(agl_empleado,ags_periodo,'F1') > 0 or f_verifica_pago_boleta(agl_empleado,ags_periodo,'RT') > 0 then
		lob_ExisteLiquidacion=True
	else
		lob_ExisteLiquidacion=False
	end if
 ELSE
	 //Verifico si la fecha de liquidacion esta en el periodo informado
	 if Date(agdt_fechaliqui) >= Date(agdt_iniperiodo) and Date(agdt_fechaliqui) <= Date(agdt_finperiodo)  then
		//Busco si se le pago liquidacion en el periodo
		if f_verifica_pago_boleta(agl_empleado,ags_periodo,'LI') > 0 or f_verifica_pago_boleta(agl_empleado,ags_periodo,'DV') > 0 or &
	       f_verifica_pago_boleta(agl_empleado,ags_periodo,'FA') > 0 or f_verifica_pago_boleta(agl_empleado,ags_periodo,'F1') > 0 or f_verifica_pago_boleta(agl_empleado,ags_periodo,'RT') > 0 then
			lob_ExisteLiquidacion=True
		else
			lob_ExisteLiquidacion=False
		end if
	else // Si la fecha de liquidacion fue antes o despues del periodo informado
		 if f_verifica_pago_boleta(agl_empleado,ags_periodo,'LI') > 0 or f_verifica_pago_boleta(agl_empleado,ags_periodo,'DV') > 0 or &
	   f_verifica_pago_boleta(agl_empleado,ags_periodo,'FA') > 0 or f_verifica_pago_boleta(agl_empleado,ags_periodo,'F1') > 0 or f_verifica_pago_boleta(agl_empleado,ags_periodo,'RT') > 0 then
			lob_ExisteLiquidacion=True
		else
			lob_ExisteLiquidacion=False
		end if	
	end if
END IF

//Busco si se le pago en el periodo
if f_verifica_pago_boleta(agl_empleado,ags_periodo,'%') > 0 then
	lob_existepago=True
else
	lob_existepago=False
end if

//compara estado actual con el de la boleta del periodo, prevalece el de la boleta
los_EstadoEmpleadoPeriodo = f_estadoempleadoactualboleta(ags_periodo ,agl_empleado,ags_estadoempleado)

//si tiene pago y liquidacion en el mes y el estado actual y el estado de la ultima boleta es activo, entonces prima EL PAGO ACTUAL
if lob_existepago=True and lob_ExisteLiquidacion=True and ags_estadoempleado='0' and los_EstadoEmpleadoPeriodo='0' then
	 lob_existepago=True
	 lob_ExisteLiquidacion=False
end if
//si tiene pago y liquidacion en el mes y el estado actual y el estado de la ultima boleta es activo, entonces prima LA LIQUIDACION
 if lob_existepago=True and lob_ExisteLiquidacion=True and ags_estadoempleado='2' and los_EstadoEmpleadoPeriodo='2' then
	 lob_existepago=False
	 lob_ExisteLiquidacion=True
end if
//
if los_EstadoEmpleadoPeriodo = '0' or los_EstadoEmpleadoPeriodo = '1' then
	 lob_ExisteLiquidacion=False
end if

 Choose Case los_EstadoEmpleadoPeriodo
	Case '0','1','2'
		if IsNull(agdt_fechacese) then
			if lob_ExisteLiquidacion=True then
				if is_TipoEmpleado = 'PE' then
					los_EstadoEmpleado=ags_estadoempleado
				else
					los_EstadoEmpleado='4'
				end if
			else
				los_EstadoEmpleado='0'
			end if
		else
			//verifco si el cese se hizo dentro del periodo informado
			 if Date(agdt_fechacese) >= Date(agdt_iniperiodo) and Date(agdt_fechacese) <= Date(agdt_finperiodo)  then
				if lob_ExisteLiquidacion=True then
					if is_TipoEmpleado = 'PE' then
						los_EstadoEmpleado=ags_estadoempleado
					else
						los_EstadoEmpleado='4'
					end if
				else
					los_EstadoEmpleado='2'
				end if
			 else
				if lob_ExisteLiquidacion=True then
					if is_TipoEmpleado = 'PE' then
						los_EstadoEmpleado=ags_estadoempleado
					else
						los_EstadoEmpleado='4'
					end if
				else
					if Date(agdt_fechacese) > Date(agdt_finperiodo)  then
						los_EstadoEmpleado='0'
					else
						los_EstadoEmpleado='2'
					end if
				end if
			 end if			
		end if				
	Case '3'
		if IsNull(agdt_fechacese) then
			if lob_ExisteLiquidacion=True then
				los_EstadoEmpleado='4'
			else// verifico si se le pago en el periodo, eso significa que el estado 3 fue despues o trabajo unos ida y despues tomo la licencia
				if lob_existepago=True then
					los_EstadoEmpleado='0'
				else
					los_EstadoEmpleado='3'
				end if				
			end if
		else
			//verifco si el cese se hizo dentro del periodo informado
			 if Date(agdt_fechacese) >= Date(agdt_iniperiodo) and Date(agdt_fechacese) <= Date(agdt_finperiodo)  then
				if lob_ExisteLiquidacion=True then
					los_EstadoEmpleado='4'
				else
					los_EstadoEmpleado='2'
				end if
			 else
				if lob_ExisteLiquidacion=True then
					los_EstadoEmpleado='4'
				else
					if lob_existepago=True then
						los_EstadoEmpleado='0'
					else
						los_EstadoEmpleado='3'
					end if	
				end if
			 end if			
		end if	
	Case Else
		los_EstadoEmpleado='4'
End Choose
 
 
 Return los_EstadoEmpleado
end function

public function datetime wf_fechacese (long agl_empleado, datetime agdt_fechaceseactual, datetime agdt_fechainiperi, datetime agdt_fechafinperi);//nuevo
Datetime		lodt_fechaCese, lodt_fechaCesado
String 		los_flag

//inicializacion de variable
SetNull(lodt_fechaCese)
//Obtengo la fecha de cese del negativo, cesado
SELECT Max(FechaCese) into :lodt_fechaCesado FROM empleadomast
WHERE EMPLEADO=:agl_empleado*-1;

If isnull(agdt_fechaceseactual) then
	if  Date(lodt_fechaCesado) >= Date( agdt_fechainiperi) and Date(lodt_fechaCesado) <=  Date(agdt_fechafinperi) then
		lodt_fechaCese=lodt_fechaCesado
	else
		SetNull(lodt_fechaCese)
	end if	
else
	if Date(agdt_fechaceseactual) = Date(lodt_fechaCesado) then
		if  Date(lodt_fechaCesado) >= Date( agdt_fechainiperi) and Date(lodt_fechaCesado) <=  Date(agdt_fechafinperi) then
			lodt_fechaCese=lodt_fechaCesado
		else
			SetNull(lodt_fechaCese)
		end if	
	else
		if Date(agdt_fechaceseactual) > Date(lodt_fechaCesado) then
			if  Date(agdt_fechaceseactual) >= Date( agdt_fechainiperi) and Date(agdt_fechaceseactual) <=  Date(agdt_fechafinperi) then
				lodt_fechaCese=agdt_fechaceseactual
			else
				SetNull(lodt_fechaCese)
			end if	
		else
			if  Date(lodt_fechaCesado) >= Date( agdt_fechainiperi) and Date(lodt_fechaCesado) <=  Date(agdt_fechafinperi) then
				lodt_fechaCese=lodt_fechaCesado
			else
				SetNull(lodt_fechaCese)
			end if	
		end if
	end if
end if


if IsNull(lodt_fechaCese) then	
	lodt_fechaCese =  Datetime(Date(f_datosboletaperiodo( iv$_periodo+mid(iv$_periodo,5,2),  agl_empleado, String(Date(lodt_fechaCese),'dd/mm/yyyy'),'FechaCese')))
	if String(Date(lodt_fechaCese))='01/01/1900' then
		SetNull(lodt_fechaCese)
	end if
end if

Return lodt_fechaCese
end function

public function integer wf_cargafiltros ();String			los_Nulo

dw_filtro.accepttext( )
isdw_ft.accepttext( )
isdw_fp.accepttext( )
isdw_f4t.accepttext( )

SetNull(los_Nulo)

is_IndiPeriodo=dw_filtro.object.indperiantpost[1]
is_PeriAntePost=dw_filtro.object.periantpost[1]

IF (IsNull(is_IndiPeriodo) OR TRIM(is_IndiPeriodo) ='')  THEN
	is_IndiPeriodo='1'
END IF

IF (IsNull(is_PeriAntePost) OR TRIM(is_PeriAntePost) ='') AND  is_IndiPeriodo='1'  THEN
	is_IndiPeriodo='1'	
	is_PeriAntePost = los_Nulo
	is_ft_PlaniProcAP=los_Nulo	
ELSE
	IF (IsNull(is_PeriAntePost) OR TRIM(is_PeriAntePost) ='') AND  is_IndiPeriodo<>'1'  THEN
		MessageBox('Aviso','Ingrese el Periodo Anterior/Posterior...')
		dw_filtro.setfocus( )
		dw_filtro.setcolumn( 'periantpost')
		Return 0
	ELSE
		IF (IsNull(is_PeriAntePost)=False OR TRIM(is_PeriAntePost) <>'') AND  is_IndiPeriodo='1'  THEN
			MessageBox('Aviso','Seleccione si se hace referencia al periodo Anterior o Posterior...')
			dw_filtro.setfocus( )
			dw_filtro.setcolumn( 'indperiantpost')
			Return 0
		END IF
	END IF
	IF is_IndiPeriodo='0' AND iv$_periodo <= is_PeriAntePost THEN
		MessageBox('Aviso','El periodo anterior ingresado es mayor o igual que el Periodo declarado, Verifique...')
		dw_filtro.setfocus( )
		dw_filtro.setcolumn( 'periantpost')
		Return 0
	END IF
	IF is_IndiPeriodo='2' AND iv$_periodo >= is_PeriAntePost THEN
		MessageBox('Aviso','El periodo posterior ingresado es menor o igual que el Periodo declarado, Verifique...')
		dw_filtro.setfocus( )
		dw_filtro.setcolumn( 'periantpost')
		Return 0
	END IF
END IF

//dw_ft
IF isdw_ft.object.allplanproc[1] = '1' THEN
	is_ft_PlaniProc=los_Nulo
	is_ft_FlagIncluir = '0'
ELSE
	is_ft_PlaniProc=isdw_ft.object.planproc[1]
	is_ft_FlagIncluir=isdw_ft.object.incluirplanilla[1]	
	
	IF IsNull(is_ft_PlaniProc) OR Trim(is_ft_PlaniProc)='' THEN
		MessageBox('Aviso','Debe seleccionar la Planilla-Proceso del Periodo Declarado...')
		isdw_ft.setfocus( )
		isdw_ft.setcolumn('planproc')
		Return 0
	END IF
	
END IF
IF isdw_ft.object.allplanproc_ap[1] = '1' THEN
	is_ft_PlaniProcAP=los_Nulo
ELSE
	is_ft_PlaniProcAP=isdw_ft.object.planproc_ap[1]
	
	IF IsNull(is_ft_PlaniProcAP) OR Trim(is_ft_PlaniProcAP)='' THEN
		MessageBox('Aviso','Debe seleccionar la Planilla-Proceso del Periodo Anterior/Posterior...')
		isdw_ft.setfocus( )
		isdw_ft.setcolumn('planproc_ap')
		Return 0
	END IF
END IF

IF is_IndiPeriodo<>'1'  AND (IsNull(is_ft_PlaniProcAP) OR Trim(is_ft_PlaniProcAP)='' ) THEN
	is_IndiPeriodo='1'
END IF

IF IsNull(is_ft_PlaniProc) = False OR Trim(is_ft_PlaniProc)<>'' THEN
	IF is_ft_FlagIncluir = '0' OR IsNull(is_ft_FlagIncluir) OR Trim(is_ft_FlagIncluir)=''  THEN
		MessageBox('Aviso','Se debe seleccionar si la Planilla-Proceso se incluirá o no según sea el caso, Verifique...')
		isdw_ft.setfocus( )
		isdw_ft.setcolumn('incluirplanilla')
		Return 0
	END IF
END IF

//dw_fp
IF isdw_fp.object.allplanproc[1] = '1' THEN
	is_fp_PlaniProc=los_Nulo
	is_fp_FlagIncluir = '0'
ELSE
	is_fp_PlaniProc=isdw_fp.object.planproc[1]
	is_fp_FlagIncluir=isdw_fp.object.incluirplanilla[1]	
END IF
IF isdw_fp.object.allplanproc_ap[1] = '1' THEN
	is_fp_PlaniProcAP=los_Nulo
ELSE
	is_fp_PlaniProcAP=isdw_fp.object.planproc_ap[1]
END IF

//dw_f4t
IF isdw_f4t.object.allplanproc[1] = '1' THEN
	is_f4t_PlaniProc=los_Nulo
	is_f4t_FlagIncluir = '0'
ELSE
	is_f4t_PlaniProc=isdw_f4t.object.planproc[1]
	is_f4t_FlagIncluir=isdw_f4t.object.incluirplanilla[1]	
END IF
IF isdw_f4t.object.allplanproc_ap[1] = '1' THEN
	is_f4t_PlaniProcAP=los_Nulo
ELSE
	is_f4t_PlaniProcAP=isdw_f4t.object.planproc_ap[1]
END IF


Return 1
end function

public function string wf_paisemisor (readonly string as_pais);/*
------------------------------------------------------------------------------------------------------
Objeto					: wf_paisemisor
Objetivo					: Devuelve el codigo RTPS del pais emisor
Autor						: Jancarlo Coaguila P.
Fecha						: 12/07/2012
Nro. RQ					: 00047
Parámetros Entrada	: Codigo Pais
Parámetros Salida		: Codigo RTPS
Observación				: Ninguno
------------------------------------------------------------------------------------------------------
Modificaciones
Nro. RQ		Fecha			Usuario			Descripción
------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------
*/
String ls_paisemisor

SELECT CodigoEmisorRTPS
  INTO :ls_paisemisor
  FROM dbo.Pais
 WHERE Pais = :as_pais;

// Devuelve por defecto PERU si no ubica el codigo
If IsNull(ls_paisemisor) Or Trim(ls_paisemisor) = '' Then
	ls_paisemisor = '604'
End If

Return ls_paisemisor
end function

public function integer wf_procesa_ar13 (string as_estado);/*
------------------------------------------------------------------------------------------------------
Objeto					: wf_procesa_ar13
Objetivo					: Procesa la información del archivo 13
Autor						: 
Fecha						: 
Nro. RQ					: 
Parámetros Entrada	: as_estado --> Estado: A=Altas, B=Bajas
Parámetros Salida		: Ninguno
Observación				: Ninguno
------------------------------------------------------------------------------------------------------
Modificaciones
Nro. RQ		Fecha			Usuario			Descripción
------------------------------------------------------------------------------------------------------
RQ 00047		14/08/2012	JCOAGUILAP		Actualiza el la funcionalidad para emitir los DDHH
------------------------------------------------------------------------------------------------------
*/
long w%_fila,w%_rowcount
string W$_COMPANY,w$_periodo

// RQ 00047 Inicio
Integer  li_Edad
String   ls_TipoDocumento, ls_Documento, ls_TipoDocumentoIdentidad, ls_DocumentoIdentidad, ls_PaisEmisorDocumento, &
			ls_ApellidoPaterno, ls_ApellidoMaterno, ls_Nombres, ls_Sexo, &
			ls_TipoDependiente, ls_TipoDocAcreditaVinculo, ls_DocumentoAcreditaVinculo, ls_MesConcepcion, ls_TipoVia1, &
			ls_NombreVia1, ls_Numero1, ls_Departamento1, ls_Interior1, ls_Manzana1, &
			ls_Lote1, ls_Kilometro1, ls_Block1, ls_Etapa1, ls_TipoZona1, &
			ls_NombreZona1, ls_Referencia1, ls_Ubigeo1, ls_TipoVia2, ls_NombreVia2, &
			ls_Numero2, ls_Departamento2, ls_Interior2, ls_Manzana2, ls_Lote2, &
			ls_Kilometro2, ls_Block2, ls_Etapa2, ls_TipoZona2, ls_NombreZona2, &
			ls_Referencia2, ls_Ubigeo2, ls_AsignacionEsSalud, ls_CodigoCiudadTelefono, ls_Telefono, &
			ls_CorreoElectronico, ls_MotivoBaja
DateTime ldt_FechaNacimiento, ldt_FechaBaja

w$_periodo =iv$_periodo+mid(iv$_periodo,5,2)
w$_company =left (iv$_CompaniaSocio,8) 
dw_source_13.SetTransObject(SQLCA)
dw_source_13.retrieve(w$_company,w$_periodo, as_estado)
w%_rowcount=dw_source_13.rowcount()

// Borra los registros según el tipo (Altas o Bajas).
DELETE FROM RTPS_AR13_DER
 WHERE PERIODO = :iv$_periodo
	AND COMPANIASOCIO = :W$_COMPANY
	AND TIPOINGRESO = 'A'
	AND ESTADO = :as_estado
 USING SQLCA;

if sqlca.sqlcode < 0 then
	string w$_msg
	w$_msg = sqlca.sqlerrtext
	rollback;
	f_msg(w$_msg)
	return -1
end if

COMMIT;

uo_progress.uf_Set_Position(0)
uo_progress.uf_Check(FALSE)			

datetime w%_hoy
w%_hoy = f_today()

For w%_fila=1 to w%_rowcount 
	li_Edad = dw_source_13.GetItemNumber(w%_fila, 'Edad')
	ls_TipoDocumento = Right('00'+f_nonull_left(wf_tipodocumento(dw_source_13.GetitemString(w%_fila,'TipoDocumento')), 2), 2)
	ls_Documento = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'Documento'), 15)
	ls_TipoDocumentoIdentidad = Right('00'+f_nonull_left(wf_tipodocumento(dw_source_13.GetItemString(w%_fila, 'TipoDocumentoIdentidad')), 2), 2)
	ls_DocumentoIdentidad = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'DocumentoIdentidad'), 15)
	ls_PaisEmisorDocumento = f_nonull_left(wf_paisemisor(dw_source_13.GetItemString(w%_fila, 'PaisEmisorDocumento')), 3)
	ldt_FechaNacimiento = dw_source_13.GetItemDateTime(w%_fila, 'FechaNacimiento')
	ls_ApellidoPaterno = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'ApellidoPaterno'), 40)
	ls_ApellidoMaterno = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'ApellidoMaterno'), 40)
	ls_Nombres = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'Nombres'), 40)
	ls_Sexo = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'Sexo'), 1)
	If ls_Sexo = 'F' Then ls_Sexo = '2' Else ls_Sexo = '1' // Por defecto masculino
	ls_TipoDependiente = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'TipoDependiente'), 2)
	If ls_TipoDependiente = 'H' Then
		If li_Edad < 18 Then
			ls_TipoDependiente = '05' // Si es hijo menor de edad
		Else
			ls_TipoDependiente = '06' // Si es hijo mayor de edad incapacitado permanentemente
		End If
	Else
		ls_TipoDependiente = Right('00'+f_nonull_left(wf_tipodependiente(ls_TipoDependiente), 2), 2)
	End If
	ls_TipoDocAcreditaVinculo = f_nonull_left(f_miscelaneacodigo1('SH', 'ACRVINCULO', dw_source_13.GetItemString(w%_fila, 'TipoDocAcreditaVinculo')), 2)
	ls_DocumentoAcreditaVinculo = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'DocumentoAcreditaVinculo'), 20)
	ls_MesConcepcion = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'MesConcepcion'), 6)
	ls_MesConcepcion = Right(ls_MesConcepcion, 2) + Left(ls_MesConcepcion, 4) // Invierte de YYYYMM a MMYYYY
	ls_TipoVia1 = f_nonull_left(wf_tipovia(dw_source_13.GetItemString(w%_fila, 'TipoVia1')), 2)
	ls_NombreVia1 = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'NombreVia1'), 20)
	ls_Numero1 = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'Numero1'), 4)
	ls_Departamento1 = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'Departamento1'), 4)
	ls_Interior1 = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'Interior1'), 4)
	ls_Manzana1 = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'Manzana1'), 4)
	ls_Lote1 = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'Lote1'), 4)
	ls_Kilometro1 = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'Kilometro1'), 4)
	ls_Block1 = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'Block1'), 4)
	ls_Etapa1 = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'Etapa1'), 4)
	ls_TipoZona1 = f_nonull_left(wf_tipozona(dw_source_13.GetItemString(w%_fila, 'TipoZona1')), 2)
	ls_NombreZona1 = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'NombreZona1'), 20)
	ls_Referencia1 = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'Referencia1'), 40)
	ls_Ubigeo1 = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'Ubigeo1'), 6)
	ls_TipoVia2 = f_nonull_left(wf_tipovia(dw_source_13.GetItemString(w%_fila, 'TipoVia2')), 2)
	ls_NombreVia2 = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'NombreVia2'), 20)
	ls_Numero2 = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'Numero2'), 4)
	ls_Departamento2 = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'Departamento2'), 4)
	ls_Interior2 = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'Interior2'), 4)
	ls_Manzana2 = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'Manzana2'), 4)
	ls_Lote2 = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'Lote2'), 4)
	ls_Kilometro2 = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'Kilometro2'), 4)
	ls_Block2 = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'Block2'), 4)
	ls_Etapa2 = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'Etapa2'), 4)
	ls_TipoZona2 = f_nonull_left(wf_tipozona(dw_source_13.GetItemString(w%_fila, 'TipoZona2')), 2)
	ls_NombreZona2 = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'NombreZona2'), 20)
	ls_Referencia2 = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'Referencia2'), 40)
	ls_Ubigeo2 = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'Ubigeo2'), 6)
	ls_AsignacionEsSalud = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'AsignacionEsSalud'), 1)
	ls_CodigoCiudadTelefono = f_nonull_left(f_miscelaneacodigo1('SH', 'CODTELFLDN', dw_source_13.GetItemString(w%_fila, 'CodigoCiudadTelefono')), 2)
	ls_Telefono = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'Telefono'), 10)
	ls_CorreoElectronico = f_nonull_left(dw_source_13.GetItemString(w%_fila, 'CorreoElectronico'), 50)
	ldt_FechaBaja = dw_source_13.GetItemDateTime(w%_fila, 'FechaBaja')
	ls_MotivoBaja = Right('00'+f_nonull_left(f_miscelaneacodigo1('HR', 'DEPEMOBA', dw_source_13.GetItemString(w%_fila, 'MotivoBaja')), 2), 2)

	If ls_TipoDependiente <> '' And ls_TipoDocumentoIdentidad  <> '' Then
		// Registra la información sólo si tiene vinculo familiar y tipo de documento de identidad
		INSERT INTO dbo.RTPS_AR13_DER
		( TIPODOC,           NUMDOC,           TIPODOCDER,       NUMDOCDER,     PAISEMISORDOC,
		  FECHANAC,          APEPATDER,        APEMATDER,        NOMBRESDER,    SEXO,
		  VINCULO,           TIPODOCVIN,       NUMCARTA,         MESCONCEPCION, DERTIPOVIA,
		  DERNOMBREVIA,      DERNUMEROVIA,     DOMDEPARTAMENTO,  DERINTERIOR,   DOMMANZANA,
		  DOMLOTE,           DOMKILOMETRO,     DOMBLOCK,         DOMETAPA,      DERTIPOZONA,    
		  DERNOMZONA,        DERREFERENCIA,    DERUBIGEO,        DOMTIPOVIA2,   DOMNOMBREVIA2,  
		  DOMNUMEROVIA2,     DOMDEPARTAMENTO2, DOMINTERIOR2,     DOMMANZANA2,   DOMLOTE2,       
		  DOMKILOMETRO2,     DOMBLOCK2,        DOMETAPA2,        DOMTIPOZONA2,  DOMNOMZONA2,    
		  DOMREFERENCIA2,    DOMUBIGEO2,       ASIGNACIONESSALUD,CODIGOLDN,     TELEFONO,       
		  CORREOELECTRONICO, FECHABAJADER,     TIPOBAJA,         ESTADO,        PERIODO,        
		  COMPANIASOCIO,     TIPOINGRESO,      INDERROR,         UltimoUsuario, UltimaFechaModif )
		VALUES
		( :ls_TipoDocumento, :ls_Documento, :ls_TipoDocumentoIdentidad, :ls_DocumentoIdentidad, :ls_PaisEmisorDocumento,
		  :ldt_FechaNacimiento, :ls_ApellidoPaterno, :ls_ApellidoMaterno, :ls_Nombres, :ls_Sexo,
		  :ls_TipoDependiente, :ls_TipoDocAcreditaVinculo, :ls_DocumentoAcreditaVinculo, :ls_MesConcepcion, :ls_TipoVia1,
		  :ls_NombreVia1, :ls_Numero1, :ls_Departamento1, :ls_Interior1, :ls_Manzana1,
		  :ls_Lote1, :ls_Kilometro1, :ls_Block1, :ls_Etapa1, :ls_TipoZona1,
		  :ls_NombreZona1, :ls_Referencia1, :ls_Ubigeo1, :ls_TipoVia2, :ls_NombreVia2,
		  :ls_Numero2, :ls_Departamento2, :ls_Interior2, :ls_Manzana2, :ls_Lote2,
		  :ls_Kilometro2, :ls_Block2, :ls_Etapa2, :ls_TipoZona2, :ls_NombreZona2,
		  :ls_Referencia2, :ls_Ubigeo2, :ls_AsignacionEsSalud, :ls_CodigoCiudadTelefono, :ls_Telefono,
		  :ls_CorreoElectronico, :ldt_FechaBaja, :ls_MotivoBaja, :as_estado, :iv$_periodo,
		  :w$_company, 'A', 'N', :str_global.gv_userid, :w%_hoy)
		USING SQLCA;
	
		if sqlca.sqlcode < 0 then
			w$_msg = sqlca.sqlerrtext
			rollback;
			f_msg(w$_msg)
			return -1
		end if
	END IF
	uo_progress.uf_Set_Position( w%_fila / w%_rowcount * 100 )
Next
// RQ 00047 Fin

COMMIT;

uo_progress.uf_Set_Position(100)
uo_progress.uf_Check(TRUE)

RETURN 0
end function

public subroutine closewindow ();


end subroutine

public function string fw_sindicalizado (string as_periodo, long al_codigoempleado);String		ls_IndiSindicalizado
Integer 	li_existe

/*SELECT COUNT(1) INTO :li_existe
FROM PR_PlanillaEmpleadoConcepto A
WHERE A.Periodo = :as_periodo
AND A.Empleado = :al_codigoempleado
AND A.Concepto = '4456'
AND A.Monto > 0 USING SQLCA;*/

SELECT COUNT(1) INTO :li_existe
FROM EmpleadoMast A
WHERE A.Empleado = :al_codigoempleado
AND A.FlagSindicalizado = '1'
USING SQLCA;

IF li_existe > 0 THEN
	ls_IndiSindicalizado = '1'
ELSE
	ls_IndiSindicalizado = '0'
END IF

Return ls_IndiSindicalizado


end function

public function string fw_situacionempleado (string as_estadoempleado);String		ls_Situacion

CHOOSE CASE as_estadoempleado
	CASE '0','1' //1	ACTIVO O SUBSIDIADO (1)
		ls_Situacion = '1'
	CASE '2' //0	BAJA (1)
		ls_Situacion = '0'
	CASE '3' //3	SUSPENSIÓN PERFECTA DE LABORES (3)
		ls_Situacion = '3'
	CASE '4' //2	SIN VÍNCULO LABORAL CON CONCEPTOS PENDIENTE DE LIQUIDAR  (2)
		ls_Situacion = '2'
END CHOOSE

Return ls_Situacion

end function

public function string fw_categoriaocupacional (string as_codigocargo);String 	ls_CategoriaOcupacional

SELECT codigoRTPS 
INTO     :ls_CategoriaOcupacional
FROM HR_CargosMast 
WHERE Cargo = :as_CodigoCargo Using Sqlca;


RETURN ls_CategoriaOcupacional;
end function

public function string fw_regimenpensionarioalta (long al_empleado, string as_tiporegpen, string as_codiafp);String		ls_RegimenPensionario
Double	lodb_jubilado


SELECT A.Valor INTO :lodb_jubilado
FROM PR_ConceptoPersonalEmpleado A
INNER JOIN PR_ConceptoPersonal  B
		ON (A.Concepto = B.Concepto)
WHERE A.Empleado = Abs(:al_empleado)
AND A.Concepto = 'JUBI' USING SQLCA;

if SQLCA.sqlcode < 0 then	
	lodb_jubilado=0
end if

if IsNull(lodb_jubilado) Then lodb_jubilado=0

IF lodb_jubilado=0 THEN
	CHOOSE CASE as_TipoRegPen
		CASE 'SNP'
			ls_RegimenPensionario='02'
		CASE 'DLR'
			ls_RegimenPensionario='03'
		CASE 'PRI'
			
			SELECT codigoRTPS 
			INTO :ls_RegimenPensionario  
			FROM HR_AFP  
			WHERE CodigoAfp= :as_CodiAfp;
			
		CASE ELSE
			ls_RegimenPensionario=''
	END CHOOSE
	
ELSE
	//Esta jubilado por tanto ya no aporta a la AFP
	ls_RegimenPensionario = '99'
END IF

Return right ('0' + trim (ls_RegimenPensionario),2)




Return ls_RegimenPensionario
end function

public function integer fw_verifica_existe_sunat (string as_numedocumento, string as_indiniactual);/*
------------------------------------------------------------------------------------------------------
Objeto					: fw_verifica_existe_sunat
Objetivo					: Verifica si ya esta registrado en el T-registro en la Data Cargada Julio 2011
Autor						: 
Fecha						: 
Nro. RQ					: 
Parámetros Entrada	: as_NumeroDocumento
Parámetros Salida		: Ninguno
Observación				: Ninguno
------------------------------------------------------------------------------------------------------
Modificaciones
Nro. RQ		Fecha			Usuario			Descripción
------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------
*/
Integer	li_Existe=0

SELECT COUNT(1)
INTO	:li_Existe
FROM IDE_SUNAT A
WHERE Rtrim(Ltrim(A.Documento)) = Rtrim(Ltrim(:as_NumeDocumento)) 
AND A.TipoListadoTreg='1'   USing Sqlca;

IF SQLCA.SQLCODE < 0 THEN
	li_Existe = 0
END IF

//IF as_IndIniActual = '0' THEN li_Existe= 0

Return li_Existe
end function

public function double fw_rembasicainicial (string as_gradosalario, string as_tipoplanilla, long al_codiopersona);String		ls_GradoSalarioMinimo, los_CodiPeriodo
Long 		ll_pos, ll_Existe
Integer	li_DiasTrab
Double    ldb_SalarioMinimo, ldb_TotIngresos

los_CodiPeriodo 		= iv$_periodo+mid(iv$_periodo,5,2)

Choose Case as_tipoplanilla
	Case 'EM','CO','PA','CA'
		ll_pos = Pos( as_GradoSalario, 'M' )

		IF ll_pos > 0 THEN
			ls_GradoSalarioMinimo = as_GradoSalario
		ELSE
			ls_GradoSalarioMinimo = Trim(as_GradoSalario) + 'M'
		END IF
		
		SELECT H.SalarioMinimo
		INTO  :ldb_SalarioMinimo
		FROM HR_GradoSalarioMast H
		WHERE H.GradoSalario = :ls_GradoSalarioMinimo Using Sqlca;
	Case 'E2'
		SELECT COUNT(1) INTO :ll_Existe
		FROM PR_PlanillaEmpleado A
		WHERE A.Periodo = :los_CodiPeriodo AND A.TipoPlanilla= :as_tipoplanilla
		AND A.TipoProceso IN ( 'NO0','A20', 'AD1') AND A.Empleado = :al_codiopersona; 
		
		IF ll_Existe > 0 THEN			
			SELECT TOP 1 A.TotalIngresos, A.DiasTrabajados
			INTO :ldb_TotIngresos, :li_DiasTrab
			FROM PR_PlanillaEmpleado A
			WHERE A.Periodo = :los_CodiPeriodo AND A.TipoPlanilla= :as_tipoplanilla
			AND A.TipoProceso IN ( 'NO0','A20', 'AD1') AND A.Empleado = :al_codiopersona; 
			IF li_DiasTrab < 30 THEN
				
				SELECT TOP 1  A.TotalIngresos
				INTO :ldb_TotIngresos
				FROM PR_PlanillaEmpleado A
				WHERE A.TipoPlanilla= :as_tipoplanilla
				AND A.TipoProceso IN ( 'NO0','A20', 'AD1') 
				AND A.Empleado = :al_codiopersona
				AND A.Periodo IN ( SELECT TOP 1 MAX(A.Periodo)
										FROM PR_PlanillaEmpleado A
										WHERE A.TipoPlanilla= :as_tipoplanilla
										AND A.TipoProceso IN ( 'NO0','A20', 'AD1') AND A.Empleado = :al_codiopersona
										and A.DiasTrabajados >= 30
										);
										
			END IF
		ELSE
			SELECT TOP 1  A.TotalIngresos
			INTO :ldb_TotIngresos
			FROM PR_PlanillaEmpleado A
			WHERE A.TipoPlanilla= :as_tipoplanilla
			AND A.TipoProceso IN ( 'NO0','A20', 'AD1') 
			AND A.Empleado = :al_codiopersona
			AND A.Periodo IN ( SELECT TOP 1 MAX(A.Periodo)
									FROM PR_PlanillaEmpleado A
									WHERE A.TipoPlanilla= :as_tipoplanilla
									AND A.TipoProceso IN ( 'NO0','A20', 'AD1') AND A.Empleado = :al_codiopersona
									and A.DiasTrabajados >= 30
									);
		END IF				
	
End Choose

Return ldb_SalarioMinimo
end function

public function integer wf_procesa_ar26 ();/*
----------------------------------------------------------------------------------------------------------------------------------------------------------
Objeto            	: wf_procesa_ar26()
Objetivo      			: Genera la data para el archivo TOC
Autor             	: PYOVERA
Fecha						: 15/02/2013
Nro. RQ					: 00047
Parámetros Entrada	: Ninguno
Parámetros Salida		:  1  ==> Función culminó satisfactóriamente
                       -1  ==> Función No culminó satisfactóriamente
Observación   			: Ninguna
----------------------------------------------------------------------------------------------------------------------------------------------------------
Modificaciones
Nro. RQ		Fecha       Usuario        Descripción
----------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------
*/
String			los_CodiCia,los_CodiPeriodo,ls_IndAltaBaja,ls_IndIniActual,ls_CasoModifica,ls_IndUniPer, los_CodiPeriodoanterior, los_Message, &
				ls_TipoDocu, ls_NumeDocu,ls_AporteAsegPens,ls_AporteEsalVida,ls_FonDerSoc,ls_Domiciliado
DateTime 	lodt_FecIniPeriodo,lodt_FecFinPeriodo,lodt_FecDelDia
Date			lod_FecIniPeriodo,lod_FecFinPeriodo
Long			lol_MesInicio,lol_Anio, lol_fila,lol_filas

dw_filtro.accepttext( )

los_CodiCia 				=Left (iv$_CompaniaSocio,8)
los_CodiPeriodo 		= iv$_periodo+mid(iv$_periodo,5,2)
ls_IndAltaBaja 			= dw_filtro.object.ind_altabaja[1]
ls_IndIniActual 			= dw_filtro.object.ind_iniactual[1]
ls_CasoModifica  		= dw_filtro.object.casomodyf[1]
ls_IndUniPer 			= dw_filtro.object.ind_unicoper[1]
lodt_FecIniPeriodo		= DateTime(Date('01/'+mid(iv$_periodo,5,2)+'/'+mid(iv$_periodo,1,4)))
lodt_FecDelDia 			= f_today()
lod_FecIniPeriodo		= Date(lodt_FecIniPeriodo)
lol_MesInicio 			= Month(lod_FecIniPeriodo)
lol_Anio 					= Year(lod_FecIniPeriodo)

//rango inicial:
lod_FecIniPeriodo 		= Date(lol_Anio, lol_MesInicio, 1)
//rango final:
IF lol_MesInicio < 12 THEN
	lod_FecFinPeriodo = RelativeDate( Date(lol_Anio, lol_MesInicio+ 1, 1),  - 1)
ELSE 
	lod_FecFinPeriodo = RelativeDate( Date(lol_Anio + 1, 1, 1),  - 1)
END IF
lodt_FecFinPeriodo	= DateTime(lod_FecFinPeriodo)

los_CodiPeriodoanterior		=String(Long(iv$_periodo)-1)
IF Mid(los_CodiPeriodoanterior,5,2) ='00' 	THEN 
	los_CodiPeriodoanterior	=String(Long(iv$_periodo)-89)
END IF
los_CodiPeriodoanterior		=los_CodiPeriodoanterior+mid(los_CodiPeriodoanterior,5,2)

IF ls_IndUniPer = '1' Then //Solo el periodo actual
	los_CodiPeriodoanterior = los_CodiPeriodo
END IF

dw_source_26.SetTransObject(SQLCA)
dw_source_26.retrieve(los_CodiCia,los_CodiPeriodo,is_PeriAntePost, is_IndiPeriodo,is_ft_PlaniProc,is_ft_PlaniProcAP,is_ft_FlagIncluir)
lol_filas=dw_source_26.rowcount()

DELETE FROM RTPS_AR26_TOC
WHERE PERIODO = :iv$_periodo
AND COMPANIASOCIO =:los_CodiCia
AND TIPOINGRESO='A'USING SQLCA;
IF sqlca.sqlcode < 0 THEN
	los_Message = sqlca.sqlerrtext
	Rollback;
	f_msg(los_Message)
	Return -1
END IF
COMMIT;
	
uo_progress.uf_Set_Position(0)
uo_progress.uf_Check(FALSE)	

FOR lol_fila=1 TO lol_filas
	ls_TipoDocu			= Right('00'+ f_nonull_left(wf_tipodocumento(dw_source_26.object.tipodocumento[lol_fila]), 2), 2)
	ls_NumeDocu		= f_nonull_left(dw_source_26.object.documento[lol_fila], 15)
	ls_AporteAsegPens= f_nonull_left(dw_source_26.object.IndAporteAsegPens[lol_fila], 1)
	ls_AporteEsalVida	= f_nonull_left(dw_source_26.object.IndAporteEsalVida[lol_fila], 1)
	ls_FonDerSoc		= f_nonull_left(dw_source_26.object.IndFonDerSoc[lol_fila], 1)
	ls_Domiciliado		= f_nonull_left(dw_source_26.object.Domiciliado[lol_fila], 1)
	
	INSERT INTO RTPS_AR26_TOC
			(
				TIPODOC,					NUMERODOC,		INDASEGPENS,			INDSEGVIDA,				INDFONDERSOCART,
				FLAGDOMICILIADO,		PERIODO,			COMPANIASOCIO,		TIPOINGRESO,				INDERROR,		
				ULTIMOUSUARIO,		ULTIMAFECHAMODIF
			)
			VALUES
			(	:ls_TipoDocu,		:ls_NumeDocu,			:ls_AporteAsegPens,	:ls_AporteEsalVida,		:ls_FonDerSoc,
				:ls_Domiciliado,	:iv$_periodo,				:los_CodiCia,			'A',							'N',						
				:str_global.gv_userid,	:lodt_FecDelDia
			) USING SQLCA;		
			IF sqlca.sqlcode < 0 THEN
				los_Message = sqlca.sqlerrtext
				Rollback;
				f_msg(los_Message)
				Return -1
			END IF

	uo_progress.uf_Set_Position( lol_fila / lol_filas * 100 )
	
NEXT	

COMMIT;

uo_progress.uf_Set_Position(100)
uo_progress.uf_Check(TRUE)

Return 0
end function

public function string fw_bajaempleado (long agl_empleado, string ags_numedocu, string ags_periodo, datetime agdt_fechacese, datetime agdt_iniperiodo, datetime agdt_finperiodo);String 	ls_EstadoEmpleado
Long		ll_Existe, ll_ExisteDoc, ll_ExisteErr
DateTime ldt_FechaIngreso

// 1. Busco si el empleado esta activo
// 1.1 Busqueda con Codigo 
SELECT COUNT(1) INTO :ll_Existe FROM EmpleadoMast E
WHERE E.Estado = 'A' AND E.EstadoEmpleado <> '2'  AND E.Empleado = :agl_empleado Using Sqlca;

IF Sqlca.Sqlcode < 0 THEN
	ll_Existe = 0
END IF
//1.2 Busqueda Con Docuemnto si no hay activo con codigo. Esto por que hay trabajadores con dos codigos, uno de ellos  esta cesado y
// el otro es con ingreso posterior y esta activo
/*IF ll_Existe = 0 THEN
	SELECT COUNT(1) INTO :ll_ExisteDoc FROM EmpleadoMast M, PersonaMast P
	WHERE M.Empleado = P.Persona AND M.EstadoEmpleado <> '2' AND M.Estado = 'A'
	AND M.FechaIngreso IS NOT NULL  AND P.Documento = :ags_NumeDocu Using Sqlca;
		
	IF Sqlca.Sqlcode < 0 THEN
		ll_ExisteDoc = 0
	END IF
	IF ll_ExisteDoc > 0 THEN
		RETURN 'NO'
	END IF		
END IF*/

// 2. Obtengo su fecha de ingreso
SELECT E.FechaIngreso INTO :ldt_FechaIngreso FROM EmpleadoMast E
WHERE E.Estado = 'A' AND E.EstadoEmpleado <> '2'  AND E.Empleado = :agl_empleado Using Sqlca;

IF Sqlca.Sqlcode < 0 THEN
	SetNull(ldt_FechaIngreso)
END IF

// 4. Si esta activo,  verifico si  EL CESE es menor al ingreso
IF ll_Existe > 0 THEN	
	IF Date(agdt_fechacese) < Date(ldt_FechaIngreso) THEN
		ls_EstadoEmpleado = '2' // es un baja
	ELSE
		ls_EstadoEmpleado = 'NO' // No incluir probablemnet es un registro errado
	END IF
ELSE
	//Verifico si esta dentro de la muestra erronea(Data por corregir, Situacion: Activo o Sub. , Estado: Inactivo)
	SELECT COUNT(1) INTO :ll_ExisteErr FROM EmpleadoMast E
	WHERE E.Estado <> 'A' AND E.EstadoEmpleado <> '2'  AND E.Empleado = :agl_empleado Using Sqlca;
	
	IF Sqlca.Sqlcode < 0 THEN
		ll_ExisteErr = 0
	END IF
	IF ll_ExisteErr > 0 THEN
		ls_EstadoEmpleado = 'NO' // No incluir probablemnet es un registro errado
	ELSE
		 ls_EstadoEmpleado = '2'	
	END IF	
END IF

IF ls_EstadoEmpleado = '2' THEN
	//Verifico si tiene pago sin vínculo laboral
	if f_verifica_pago_boleta(agl_empleado,ags_periodo,'LI') > 0 or f_verifica_pago_boleta(agl_empleado,ags_periodo,'DV') > 0 or &
	   f_verifica_pago_boleta(agl_empleado,ags_periodo,'FA') > 0 or f_verifica_pago_boleta(agl_empleado,ags_periodo,'F1') > 0 or &
	   f_verifica_pago_boleta(agl_empleado,ags_periodo,'RT') > 0 or f_verifica_pago_boleta(agl_empleado,ags_periodo,'DF') > 0 then
		ls_EstadoEmpleado = '4'		
	end if	
END IF

Return ls_EstadoEmpleado
end function

public function integer wf_procesa_ar27 ();/*
----------------------------------------------------------------------------------------------------------------------------------------------------------
Objeto            	: wf_procesa_ar27()
Objetivo      			: Genera la data para el archivo POC
Autor             	: PYOVERA
Fecha						: 15/02/2013
Nro. RQ					: 00047
Parámetros Entrada	: Ninguno
Parámetros Salida		:  1  ==> Función culminó satisfactóriamente
                       -1  ==> Función No culminó satisfactóriamente
Observación   			: Ninguna
----------------------------------------------------------------------------------------------------------------------------------------------------------
Modificaciones
Nro. RQ		Fecha       Usuario        Descripción
----------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------
*/
String			los_CodiCia,los_CodiPeriodo,ls_IndAltaBaja,ls_IndIniActual,ls_CasoModifica,ls_IndUniPer, los_CodiPeriodoanterior, los_Message, &
				ls_TipoDocu, ls_NumeDocu,ls_AporteAsegPens,ls_AporteEsalVida,ls_FonDerSoc,ls_Domiciliado
DateTime 	lodt_FecIniPeriodo,lodt_FecFinPeriodo,lodt_FecDelDia
Date			lod_FecIniPeriodo,lod_FecFinPeriodo
Long			lol_MesInicio,lol_Anio, lol_fila,lol_filas, ll_empleado

dw_filtro.accepttext( )

los_CodiCia 				=Left (iv$_CompaniaSocio,8)
los_CodiPeriodo 		= iv$_periodo+mid(iv$_periodo,5,2)
ls_IndAltaBaja 			= dw_filtro.object.ind_altabaja[1]
ls_IndIniActual 			= dw_filtro.object.ind_iniactual[1]
ls_CasoModifica  		= dw_filtro.object.casomodyf[1]
ls_IndUniPer 			= dw_filtro.object.ind_unicoper[1]
lodt_FecIniPeriodo		= DateTime(Date('01/'+mid(iv$_periodo,5,2)+'/'+mid(iv$_periodo,1,4)))
lodt_FecDelDia 			= f_today()
lod_FecIniPeriodo		= Date(lodt_FecIniPeriodo)
lol_MesInicio 			= Month(lod_FecIniPeriodo)
lol_Anio 					= Year(lod_FecIniPeriodo)

//rango inicial:
lod_FecIniPeriodo 		= Date(lol_Anio, lol_MesInicio, 1)
//rango final:
IF lol_MesInicio < 12 THEN
	lod_FecFinPeriodo = RelativeDate( Date(lol_Anio, lol_MesInicio+ 1, 1),  - 1)
ELSE 
	lod_FecFinPeriodo = RelativeDate( Date(lol_Anio + 1, 1, 1),  - 1)
END IF
lodt_FecFinPeriodo	= DateTime(lod_FecFinPeriodo)

los_CodiPeriodoanterior		=String(Long(iv$_periodo)-1)
IF Mid(los_CodiPeriodoanterior,5,2) ='00' 	THEN 
	los_CodiPeriodoanterior	=String(Long(iv$_periodo)-89)
END IF
los_CodiPeriodoanterior		=los_CodiPeriodoanterior+mid(los_CodiPeriodoanterior,5,2)

IF ls_IndUniPer = '1' Then //Solo el periodo actual
	los_CodiPeriodoanterior = los_CodiPeriodo
END IF

dw_source_27.SetTransObject(SQLCA)
dw_source_27.retrieve(los_CodiCia,los_CodiPeriodo,'%%', '%%%')

lol_filas=dw_source_27.rowcount()

DELETE FROM RTPS_AR27_POC
WHERE PERIODO = :iv$_periodo
AND COMPANIASOCIO =:los_CodiCia
AND TIPOINGRESO='A'USING SQLCA;
IF sqlca.sqlcode < 0 THEN
	los_Message = sqlca.sqlerrtext
	Rollback;
	f_msg(los_Message)
	Return -1
END IF
COMMIT;
	
uo_progress.uf_Set_Position(0)
uo_progress.uf_Check(FALSE)	

FOR lol_fila=1 TO lol_filas
	ls_TipoDocu			= Right('00'+ f_nonull_left(wf_tipodocumento(dw_source_27.object.tipodocumento[lol_fila]), 2), 2)
	ls_NumeDocu		= f_nonull_left(dw_source_27.object.documento[lol_fila], 15)
	ls_AporteEsalVida	= f_nonull_left(dw_source_27.object.IndEssVida[lol_fila], 1)
	
	INSERT INTO RTPS_AR27_POC
			(
				TIPODOC,				NUMERODOC,		INDSEGVIDA,				PERIODO,			COMPANIASOCIO,		
				TIPOINGRESO,			INDERROR,			ULTIMOUSUARIO,			ULTIMAFECHAMODIF
			)
			VALUES
			(	:ls_TipoDocu,			:ls_NumeDocu,		:ls_AporteEsalVida,		:iv$_periodo,		:los_CodiCia,			
				'A',						'N',					:str_global.gv_userid,		:lodt_FecDelDia
			) USING SQLCA;		
			IF sqlca.sqlcode < 0 THEN
				los_Message = sqlca.sqlerrtext
				Rollback;
				f_msg(los_Message)
				Return -1
			END IF

	uo_progress.uf_Set_Position( lol_fila / lol_filas * 100 )
	
NEXT	

COMMIT;

uo_progress.uf_Set_Position(100)
uo_progress.uf_Check(TRUE)

Return 0
end function

public function integer fw_verificaestadopensionista (long al_codiempleado);/*
------------------------------------------------------------------------------------------------------
Objeto					: fw_verificaestadopensionista
Objetivo					: Verifica si el empleado es solo pensionista y que si tiene estadoempleado 3 (Sin Remuneracion con Vinculo Laboral)
							  no se cargue para el T-registro, pues esta con pension suspendida (Baja en el T-registro)
Autor						: Pascual Yovera Y.
Fecha						: 
Nro. RQ					: 
Parámetros Entrada	: 
Parámetros Salida		: Ninguno
Observación				: Ninguno
------------------------------------------------------------------------------------------------------
Modificaciones
Nro. RQ		Fecha			Usuario			Descripción
------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------
*/
String		ls_TipoPlanilla, ls_EstadoEmpl
Long		ll_Existe
Integer	li_retorna

SELECT E.TipoPlanilla, E.EstadoEmpleado, COUNT(1)
INTO	:ls_TipoPlanilla, :ls_EstadoEmpl, :ll_Existe
FROM EmpleadoMast E
WHERE E.Empleado= :al_CodiEmpleado
GROUP BY E.TipoPlanilla, E.EstadoEmpleado Using Sqlca;

IF ll_Existe = 1 THEN
	IF ls_TipoPlanilla='PE' THEN
		IF ls_EstadoEmpl='3' THEN
			li_retorna=1
		ELSE
			li_retorna=0
		END IF
	ELSE
		li_retorna=0
	END IF
ELSE
	li_retorna=0
END IF


Return li_retorna
end function

public subroutine fw_actualizadatos ();/*
------------------------------------------------------------------------------------------------------
Objeto					: fw_actualizadatos
Objetivo					: Actualizar datos, antes de iniciar el procesamiento de datos
Autor						: 
Fecha						: 
Nro. RQ					: 
Parámetros Entrada	: Ninguno
Parámetros Salida		: Ninguno
Observación				: Ninguno
------------------------------------------------------------------------------------------------------
Modificaciones
Nro. RQ		Fecha			Usuario			Descripción
------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------
*/
String				los_IndUniPer,los_CodiPeriodo,los_PeriAntPost
Long       		ll_items
str_param 		ls_str_param

los_IndUniPer 		= dw_filtro.object.ind_unicoper[1]
los_CodiPeriodo 	= iv$_periodo+mid(iv$_periodo,5,2)
los_PeriAntPost 	= is_PeriAntePost + mid(is_PeriAntePost,5,2)

IF los_IndUniPer = '1' Then //Solo el periodo actual
	los_PeriAntPost = los_CodiPeriodo
END IF


ls_str_param.s_action = 'new'
ls_str_param.s_win_title = 'Actualizar Data T-registro'
ls_str_param.parm[1] = los_CodiPeriodo
ls_str_param.parm[2] = los_PeriAntPost

IF f_confirmar_2opc("Confirmar","Desea actualizar los datos para el T-registro?","&Si","&No",2) = 2 THEN	Return

Openwithparm(w_pe_response_actualizadatos, ls_str_param)
end subroutine

public function integer wf_procesa_ar29 ();/*
----------------------------------------------------------------------------------------------------------------------------------------------------------
Objeto            	: wf_procesa_ar29()
Objetivo      			: Genera la data para el archivo EDU
Autor             	: PYOVERA
Fecha						: 11/07/2014
Nro. RQ					: 00047
Parámetros Entrada	: Ninguno
Parámetros Salida		:  1  ==> Función culminó satisfactóriamente
                       -1  ==> Función No culminó satisfactóriamente
Observación   			: Ninguna
----------------------------------------------------------------------------------------------------------------------------------------------------------
ModIficaciones
Nro. RQ		Fecha       Usuario        Descripción
----------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------
*/
String			los_CodiCia,los_CodiPeriodo,ls_IndAltaBaja,ls_IndIniActual,ls_CasoModIfica,ls_IndUniPer, los_CodiPeriodoanterior, los_Message, &
				ls_TipoDocu, ls_NumeDocu
				
String			ls_PaisEmisor,ls_ForSupCompleta,ls_IndEduComplPer,ls_CodInstEduca,ls_CodCarrera,ls_AnioEgreso	, ls_TipoPlanilla,ls_TipoContrato,&
				ls_IndFuente,ls_RegistroAnt,ls_RegistroActual 

DateTime 	lodt_FecIniPeriodo,lodt_FecFinPeriodo,lodt_FecDelDia
Date			lod_FecIniPeriodo,lod_FecFinPeriodo
Long			lol_MesInicio,lol_Anio, lol_fila,lol_filas, ll_CodiPersona,ll_VerIfica,lol_ConPago
Boolean		lb_InsertaRegistro,lb_Igual_SituEducativa

dw_filtro.accepttext( )

los_CodiCia 				=Left (iv$_CompaniaSocio,8)
los_CodiPeriodo 		= iv$_periodo+mid(iv$_periodo,5,2)
ls_IndAltaBaja 			= dw_filtro.object.ind_altabaja[1]
ls_IndIniActual 			= dw_filtro.object.ind_iniactual[1]
ls_CasoModIfica  		= dw_filtro.object.casomodyf[1]
ls_IndUniPer 			= dw_filtro.object.ind_unicoper[1]
lodt_FecIniPeriodo		= DateTime(Date('01/'+mid(iv$_periodo,5,2)+'/'+mid(iv$_periodo,1,4)))
lodt_FecDelDia 			= f_today()
lod_FecIniPeriodo		= Date(lodt_FecIniPeriodo)
lol_MesInicio 			= Month(lod_FecIniPeriodo)
lol_Anio 					= Year(lod_FecIniPeriodo)
ls_IndFuente			= dw_filtro.object.ind_origen[1]

//rango inicial:
lod_FecIniPeriodo 		= Date(lol_Anio, lol_MesInicio, 1)
//rango final:
If lol_MesInicio < 12 Then
	lod_FecFinPeriodo = RelativeDate( Date(lol_Anio, lol_MesInicio+ 1, 1),  - 1)
Else 
	lod_FecFinPeriodo = RelativeDate( Date(lol_Anio + 1, 1, 1),  - 1)
End If
lodt_FecFinPeriodo	= DateTime(lod_FecFinPeriodo)

los_CodiPeriodoanterior		=String(Long(iv$_periodo)-1)
If Mid(los_CodiPeriodoanterior,5,2) ='00' 	Then 
	los_CodiPeriodoanterior	=String(Long(iv$_periodo)-89)
End If
los_CodiPeriodoanterior		=los_CodiPeriodoanterior+mid(los_CodiPeriodoanterior,5,2)

If ls_IndUniPer = '1' Then //Solo el periodo actual
	los_CodiPeriodoanterior = los_CodiPeriodo
End If

dw_source_29.SetTransObject(SQLCA)
dw_source_29.retrieve(los_CodiCia,los_CodiPeriodo,los_CodiPeriodoanterior, ls_IndAltaBaja, ls_IndIniActual)
lol_filas=dw_source_29.rowcount()

DELETE FROM RTPS_AR29_EDU
WHERE PERIODO = :iv$_periodo
AND COMPANIASOCIO =:los_CodiCia
AND TIPOINGRESO='A'USING SQLCA;
If sqlca.sqlcode < 0 Then
	los_Message = sqlca.sqlerrtext
	Rollback;
	f_msg(los_Message)
	Return -1
End If
COMMIT;
	
uo_progress.uf_Set_Position(0)
uo_progress.uf_Check(FALSE)	

FOR lol_fila=1 TO lol_filas
	ls_TipoDocu				= Right('00'+ f_nonull_left(wf_tipodocumento(dw_source_29.object.tipodocumento[lol_fila]), 2), 2)
	ls_NumeDocu			= f_nonull_left(dw_source_29.object.documento[lol_fila], 15)
	ls_PaisEmisor     		= f_nonull_left(wf_paisemisor(dw_source_29.getItemString(lol_fila,'paisemisordocumento')), 3)
	ls_ForSupCompleta	= f_nonull_left(dw_source_29.object.situacioneducativa[lol_fila], 2)
	ls_IndEduComplPer	= f_nonull_left(dw_source_29.object.indeducompleta[lol_fila], 1)
	ls_CodInstEduca		= TRIM(f_nonull_left(dw_source_29.object.codinsteducat[lol_fila], 9))		
	ls_CodCarrera			= TRIM(f_nonull_left(dw_source_29.object.codcarrera[lol_fila], 6))
	ls_AnioEgreso			= f_nonull_left(dw_source_29.object.anioegreso[lol_fila], 4)
	ls_TipoPLanilla			= f_nonull_left(dw_source_29.object.tipoplanilla[lol_fila], 2)
	ls_TipoContrato		= f_nonull_left(dw_source_29.object.tipocontrato[lol_fila], 2)
	ll_CodiPersona			=	dw_source_29.getItemNumber(lol_fila,'empleado')	
		
	//Nivel Educativo
	If ls_TipoPlanilla = 'CO' Then
		If TRIM(ls_ForSupCompleta)='' Then
			ls_ForSupCompleta='13'
		End If
	Else
		If TRIM(ls_ForSupCompleta)='' Then 
			SELECT 	ISNULL(max(codigortps),'') 
			INTO		:ls_ForSupCompleta 
			FROM		hr_empleadoinstruccion H,hr_gradoinstruccion G
			WHERE	H.empleado=:ll_CodiPersona AND H.nivelacademico=G.gradoinstruccion Using Sqlca;			
			If sqlca.sqlcode < 0 Then
				ls_ForSupCompleta=''
			End If			
		End If	
		If TRIM(ls_ForSupCompleta)='' Then
			ls_ForSupCompleta='12'
		End If
	End If
	//Asiganmos valores segun la data cargada
	If ls_ForSupCompleta='11' OR ls_ForSupCompleta='13' Then
		If ls_CodCarrera='999999' Then
			If Mid(ls_CodInstEduca,1,1)='1' Then ls_CodInstEduca ='199999999'
			If Mid(ls_CodInstEduca,1,1)='2' Then ls_CodInstEduca ='299999999'
		End If
		If ls_CodInstEduca ='199999999' Then ls_CodCarrera = '999999'
		If ls_CodInstEduca ='299999999' Then ls_CodCarrera = '999999'
	End If
	
	//Solo aplica para ALTAS
	
	//Validamos que este cargado en T00 del periodo
	ll_VerIfica		= 0
	lol_ConPago		= 1
	
	If ls_IndAltaBaja = '1'  Then
		SELECT	COUNT(1)	INTO :ll_VerIfica
		FROM		RTPS_AR4_T00	WITH(NoLock)
		WHERE	Periodo=	:iv$_periodo AND	TIPODOC	=:ls_TipoDocu AND NumeroDoc=	:ls_NumeDocu	Using SQLCA;
		
		If sqlca.sqlcode < 0 Then
			ll_VerIfica=0
		End If
		//Solo si se indica que se incluya a las altas procesadas en la Planila del Mes	
		If ls_IndFuente = 'S' Then				
			lol_ConPago = f_verIfica_pago_boleta(ll_CodiPersona, los_CodiPeriodo, '%' )
		End If
	Else
		ll_VerIfica = fw_verIfica_existe_sunat( ls_NumeDocu, ls_IndIniActual )
	End If
	
	lb_Igual_SituEducativa=True
	ls_RegistroActual=ls_TipoDocu+ls_NumeDocu+ls_PaisEmisor+ls_ForSupCompleta+ls_IndEduComplPer+ls_CodInstEduca+ls_CodCarrera
	If lol_fila > 1 Then
		If ls_RegistroAnt = ls_RegistroActual Then
			//Grado de educacion igual
			lb_Igual_SituEducativa = False
		End If 
	End If
	ls_RegistroAnt=ls_RegistroActual 

	If lol_ConPago > 0 Then
		lb_InsertaRegistro = True
	Else
		lb_InsertaRegistro = False
	End If
	
	If lb_Igual_SituEducativa Then	
	If ll_VerIfica > 0  Then
		If	lb_InsertaRegistro Then	
				
				INSERT INTO RTPS_AR29_EDU
						(
							TIPODOC,					NUMERODOC,			PAISEMISORDOC,			FORMACSUPCOMP,				INDEDUCOMPLPERU,
							CODINSTEDUCATIVA,		CODCARRERA,			ANIOEGRESO,				PERIODO,							COMPANIASOCIO,		
							TIPOINGRESO, 				INDERROR,				ULTIMOUSUARIO,			ULTIMAFECHAMODIf
						)
						VALUES
						(	:ls_TipoDocu,				:ls_NumeDocu,			:ls_PaisEmisor,				:ls_ForSupCompleta,				:ls_IndEduComplPer,
							:ls_CodInstEduca,			:ls_CodCarrera,		:ls_AnioEgreso,				:iv$_periodo,						:los_CodiCia,				
							'A',							'N',						:str_global.gv_userid,		:lodt_FecDelDia
						) USING SQLCA;		
						If sqlca.sqlcode < 0 Then
							los_Message = sqlca.sqlerrtext
							Rollback;
							f_msg(los_Message)
							Return -1
						End If
		End If
	End If
	End If

	uo_progress.uf_Set_Position( lol_fila / lol_filas * 100 )
	
NEXT	

COMMIT;

uo_progress.uf_Set_Position(100)
uo_progress.uf_Check(TRUE)

Return 0
end function

public function string fw_estado_pago_pendiente (string ags_documento, datetime agdt_iniperiodo, datetime agdt_finperiodo, string ags_caso);DateTime	ldt_FechaCese
Long			ll_ExisteDoc, ll_ExisteLiq
String			ls_Periodo8


ls_Periodo8 = iv$_periodo+mid(iv$_periodo,5,2)
ll_ExisteDoc = 0
ll_ExisteLiq = 0

//1. Verifico si esta activo.
SELECT COUNT(1) INTO :ll_ExisteDoc FROM EmpleadoMast M, PersonaMast P
WHERE M.Empleado = P.Persona AND M.EstadoEmpleado <> '2' AND M.Estado = 'A'
AND M.FechaIngreso IS NOT NULL  AND P.Documento = :ags_Documento Using Sqlca;
	
IF Sqlca.Sqlcode < 0 THEN
	ll_ExisteDoc = 0
END IF
//2. SI esta activo, Retorno 'NO', para que no se cambie su estado
if ags_caso<>'99' then	
	IF ll_ExisteDoc > 0 THEN
		RETURN 'NO'
	END IF
else
	//esta activo y con fecha de ingreso desde el periodo o mayor y por tanto no se debe incluir *
	//esta activo y con fecha de ingreso desde el periodo  no se debe incluir
	SELECT COUNT(1) INTO :ll_ExisteDoc FROM EmpleadoMast M, PersonaMast P
	WHERE M.Empleado = P.Persona AND M.EstadoEmpleado <> '2' AND M.Estado = 'A'
	AND M.FechaIngreso IS NOT NULL  AND P.Documento = :ags_Documento
	AND SUBSTRING(CONVERT(VARCHAR(6), M.FechaIngreso, 112),1,6)+SUBSTRING(CONVERT(VARCHAR(6), M.FechaIngreso, 112),5,2) = :ls_Periodo8 Using Sqlca;
	
	IF ll_ExisteDoc > 0 THEN
		//VERIFICO SI EN EL PERIODO SOLO EXISTE EL PAGO POR LIQUIDACION. SI ES ASI SE DEBE INCLUIR		
		SELECT COUNT(1) INTO :ll_ExisteLiq FROM PERSONAMAST P, PR_PlanillaEmpleado E
		WHERE P.Persona=E.Empleado AND E.Periodo= :ls_Periodo8
		AND E.TipoProceso NOT IN (SELECT X.TipoProceso FROM PR_TipoProceso X WHERE X.CodiAgrupador IN ('PFMES','PADIC'))
		AND P.Documento= :ags_Documento Using Sqlca;
		
		If ll_ExisteLiq > 0 Then
			RETURN '4'
		Else
			RETURN 'NO'
		End If
	END IF	
end if
//4. Obtengo su cese y verifico que si esta dentro del periodo no cambie su estado.
SELECT MAX(M.FechaCese) INTO :ldt_FechaCese
FROM EmpleadoMast M, PersonaMast P
WHERE M.Empleado = P.Persona AND M.EstadoEmpleado = '2' 
AND M.FechaIngreso IS NOT NULL  AND P.Documento = :ags_Documento Using Sqlca;
	
IF Sqlca.Sqlcode < 0 THEN
	SetNull(ldt_FechaCese)
END IF

//5. Verifico si la fecha de cese esta en el periodo, entonces no es un pago pendiente por liquidar
IF Date(ldt_FechaCese) >= Date(agdt_iniperiodo) AND Date(ldt_FechaCese) <= Date(agdt_finperiodo)  THEN
	RETURN 'NO'
ELSE
	RETURN '4'
END IF

Return ''
end function

public function integer wf_procesa_ar30 ();/*
----------------------------------------------------------------------------------------------------------------------------------------------------------
Objeto            			: wf_procesa_ar30()
Objetivo      				: Genera la data para el archivo CTA
Autor             			: PYOVERA/ACOAGUILA
Fecha						: 06/02/2018
Nro. RQ					: 
Parámetros Entrada	: Ninguno
Parámetros Salida		:  1  ==> Función culminó satisfactóriamente
                       -1  ==> Función No culminó satisfactóriamente
Observación   			: Ninguna
----------------------------------------------------------------------------------------------------------------------------------------------------------
Modificaciones
Nro. RQ		Fecha       Usuario        Descripción
----------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------
*/
String			los_CodiCia,los_CodiPeriodo,ls_IndAltaBaja,ls_IndIniActual,ls_IndUniPer, los_CodiPeriodoanterior, los_Message, &
				ls_TipoDocu, ls_NumeDocu, ls_PeriAntPost				
String			ls_PaisEmisor, ls_Banco, ls_CuentaSueldo, ls_TipoPlanilla,ls_TipoContrato,ls_IndFuente,ls_bancoTmp, ls_CuentaSueldoTmp
Long			lol_fila,lol_filas, ll_CodiPersona,ll_Verifica,lol_ConPago
Boolean		lb_InsertaRegistro
DateTime	lodt_FecDelDia, lodt_FecIngreso

dw_filtro.accepttext( )

los_CodiCia 				=Left (iv$_CompaniaSocio,8)
los_CodiPeriodo 		= iv$_periodo+mid(iv$_periodo,5,2)
ls_IndAltaBaja 			= dw_filtro.object.ind_altabaja[1]
ls_IndIniActual 			= dw_filtro.object.ind_iniactual[1]
ls_IndUniPer 			= dw_filtro.object.ind_unicoper[1]
ls_IndFuente			= dw_filtro.object.ind_origen[1]

lodt_FecDelDia 			= f_today()

ls_PeriAntPost 		= is_PeriAntePost + mid(is_PeriAntePost,5,2)

IF IsNUll(ls_PeriAntPost) OR TRIM(ls_PeriAntPost)='' THEN
	los_CodiPeriodoanterior=String(Long(iv$_periodo)-1)
	if Mid(los_CodiPeriodoanterior,5,2) ='00' 	then 
		los_CodiPeriodoanterior=String(Long(iv$_periodo)-89)
	end if
	los_CodiPeriodoanterior		=los_CodiPeriodoanterior+mid(los_CodiPeriodoanterior,5,2)
ELSE
	los_CodiPeriodoanterior = ls_PeriAntPost
END IF

IF ls_IndUniPer = '1' Then //Solo el periodo actual
	los_CodiPeriodoanterior = los_CodiPeriodo
END IF

dw_source_30.SetTransObject(SQLCA)
dw_source_30.retrieve(los_CodiCia,los_CodiPeriodo,los_CodiPeriodoanterior, ls_IndAltaBaja, ls_IndIniActual)
lol_filas=dw_source_30.rowcount()

DELETE FROM RTPS_AR30_CTA
WHERE PERIODO = :iv$_periodo
AND TIPOINGRESO='A'USING SQLCA;
IF sqlca.sqlcode < 0 THEN
	los_Message = sqlca.sqlerrtext
	Rollback;
	f_msg(los_Message)
	Return -1
END IF
COMMIT;
	
uo_progress.uf_Set_Position(0)
uo_progress.uf_Check(FALSE)	

FOR lol_fila=1 TO lol_filas
	ls_TipoDocu				= Right('00'+ f_nonull_left(wf_tipodocumento(dw_source_30.object.tipodocumento[lol_fila]), 2), 2)
	ls_NumeDocu			= f_nonull_left(dw_source_30.object.documento[lol_fila], 15)
	ls_PaisEmisor     		= f_nonull_left(wf_paisemisor(dw_source_30.getItemString(lol_fila,'paisemisordocumento')), 3)
	
	ls_banco					= f_nonull_left(dw_source_30.object.banco[lol_fila], 3)
	ls_CuentaSueldo		= f_nonull_left(dw_source_30.object.cuenta[lol_fila], 20)
	ls_TipoPLanilla			= f_nonull_left(dw_source_30.object.tipoplanilla[lol_fila], 2)
	ls_TipoContrato		= f_nonull_left(dw_source_30.object.tipocontrato[lol_fila], 2)	
	lodt_FecIngreso		= dw_source_30.getItemDateTime(lol_fila,'fechaingreso')	
	ll_CodiPersona			= dw_source_30.getItemNumber(lol_fila,'empleado')	
	
	//Si no tiene cuenta sacamos la ultima cuenta que se proceso un pago	
	If (IsNUll(ls_banco) Or TRIM(ls_banco)='') Or  (IsNUll(ls_CuentaSueldo) Or TRIM(ls_CuentaSueldo)='') Then
	
		SELECT TOP 1 RTRIM(C.CodigoSunat),RTRIM(P.Cuenta)
		INTO :ls_bancoTmp, :ls_CuentaSueldoTmp
		FROM PR_PlanillaEmpleado P
		INNER JOIN Banco C ON (P.Banco=C.Banco) 
		WHERE P.Empleado=:ll_CodiPersona
		ORDER BY P.Periodo DESC Using SQLCA;
		
		If sqlca.sqlcode < 0 Then
			SetNull(ls_bancoTmp)
			SetNull(ls_CuentaSueldoTmp)
		End If
		
		ls_banco 			=ls_bancoTmp
		ls_CuentaSueldo	=ls_CuentaSueldoTmp
		
	End If

	//Solo aplica para ALTAS
	
	//Validamos que este cargado en T00 del periodo
	ll_VerIfica		= 0
	lol_ConPago		= 1
	
	If ls_IndAltaBaja = '1'  Then
		SELECT	COUNT(1)	INTO :ll_VerIfica
		FROM		RTPS_AR4_T00	WITH(NoLock)
		WHERE	Periodo=	:iv$_periodo AND	TIPODOC	=:ls_TipoDocu AND NumeroDoc=	:ls_NumeDocu	Using SQLCA;
		
		If sqlca.sqlcode < 0 Then
			ll_VerIfica=0
		End If
		//Solo si se indica que se incluya a las altas procesadas en la Planila del Mes	
		If ls_IndFuente = 'S' Then				
			lol_ConPago = f_verIfica_pago_boleta(ll_CodiPersona, los_CodiPeriodo, '%' )
		End If
	Else
		ll_VerIfica = fw_verIfica_existe_sunat( ls_NumeDocu, ls_IndIniActual )
	End If

	If lol_ConPago > 0 Then
		lb_InsertaRegistro = True
	Else
		lb_InsertaRegistro = False
	End If
			
	If ll_Verifica > 0 Then
		IF	lb_InsertaRegistro THEN							
				
				INSERT INTO RTPS_AR30_CTA
						(
							TIPODOC,					NUMERODOC,			PAISEMISORDOC,			CODEMPLEADO,				FECHAINGRESO,
							CODENTIDADFINANC,		NROCUENTA,			PERIODO,				     TIPOINGRESO,					INDERROR,				
							ULTIMOUSUARIO,			ULTIMAFECHAMODIF
						)
						VALUES
						(	:ls_TipoDocu,				:ls_NumeDocu,			:ls_PaisEmisor,				:ll_CodiPersona,				:lodt_FecIngreso,
							:ls_banco,					:ls_CuentaSueldo,		:iv$_periodo,				'A',								'N',						
							:str_global.gv_userid,		:lodt_FecDelDia
						) USING SQLCA;		
						IF sqlca.sqlcode < 0 THEN
							los_Message = sqlca.sqlerrtext
							Rollback;
							f_msg(los_Message)
							Return -1
						END IF
		End If
	End If

	uo_progress.uf_Set_Position( lol_fila / lol_filas * 100 )
	
NEXT	

COMMIT;

uo_progress.uf_Set_Position(100)
uo_progress.uf_Check(TRUE)

Return 0
end function

public function integer wf_procesa_ar31 ();
String		los_CodiCia, los_Message, ls_IndAltaBaja
Long 		lol_fila,lol_filas

dw_filtro.accepttext( )

los_CodiCia 				=Left (iv$_CompaniaSocio,8)
ls_IndAltaBaja 			= dw_filtro.object.ind_altabaja[1]

SELECT COUNT(*) INTO :lol_filas FROM RTPS_AR5_T01
WHERE PERIODO = :iv$_periodo
AND COMPANIASOCIO =:los_CodiCia
USING SQLCA;

If sqlca.sqlcode < 0 Then
	los_Message = sqlca.sqlerrtext
	Rollback;
	f_msg(los_Message)
	Return -1
End If
COMMIT;


If lol_filas = 0 Then
	los_Message = "Primero debe generar el archivo .tra para el periodo seleccionado"
	f_msg(los_Message)
	Return -1
End If

uo_progress.uf_Set_Position(0)
uo_progress.uf_Check(FALSE)	

DECLARE Sp_Pe_procesar_aos PROCEDURE FOR Dbo.Sp_Pe_procesar_aos  
					@s_periodo 		= :iv$_periodo,  &
					@s_compania  		= :los_CodiCia, &
					@s_indAltaBaja		= :ls_IndAltaBaja;				
		EXECUTE Sp_Pe_procesar_aos ;
		
		
		if sqlca.SQLCode < 0 then
			los_Message = sqlca.sqlerrtext
			Rollback;
			f_msg(los_Message)
			Return -1
		//Else
			//f_mensaje_temporal('Proceso Completado...', 1)
		end if
		
		COMMIT;

uo_progress.uf_Set_Position(100)
uo_progress.uf_Check(TRUE)

Return 0
end function

public function integer wf_procesa_ar5_sindicalizado ();String		los_CodiCia, los_Message
Long 		lol_fila,lol_filas

dw_filtro.accepttext( )
los_CodiCia 				=Left (iv$_CompaniaSocio,8)

uo_progress.uf_Set_Position(0)
uo_progress.uf_Check(FALSE)	

DECLARE Sp_Pe_Procesar_Tra_Sindicalizado_modificacion PROCEDURE FOR Dbo.Sp_Pe_Procesar_Tra_Sindicalizado_modificacion  
					@s_periodo 					= :iv$_periodo,  &
					@s_compania  			= :los_CodiCia;				
		EXECUTE Sp_Pe_Procesar_Tra_Sindicalizado_modificacion ;
		
		
		if sqlca.SQLCode < 0 then
			los_Message = sqlca.sqlerrtext
			Rollback;
			f_msg(los_Message)
			Return -1
		end if
		
		COMMIT;

uo_progress.uf_Set_Position(100)
uo_progress.uf_Check(TRUE)

return 0;
end function

on w_pe_procesa_rtps.create
int iCurrent
call super::create
this.dw_source_30=create dw_source_30
this.dw_source_27=create dw_source_27
this.dw_source_26=create dw_source_26
this.cb_idesunat=create cb_idesunat
this.dw_source_17_02=create dw_source_17_02
this.dw_rtps_uap=create dw_rtps_uap
this.dw_source_20=create dw_source_20
this.dw_source_19=create dw_source_19
this.dw_source_02_sdd=create dw_source_02_sdd
this.dw_source_02_edd=create dw_source_02_edd
this.dw_source_13=create dw_source_13
this.dw_source_15=create dw_source_15
this.dw_source_16=create dw_source_16
this.dw_source_17=create dw_source_17
this.dw_source_21=create dw_source_21
this.dw_source_14=create dw_source_14
this.dw_source_18=create dw_source_18
this.dw_diskette=create dw_diskette
this.dw_reporte=create dw_reporte
this.cb_cerrar=create cb_cerrar
this.dw_source_04=create dw_source_04
this.dw_source_ddhh=create dw_source_ddhh
this.cb_procesar=create cb_procesar
this.sle_tcambiopago=create sle_tcambiopago
this.sle_tcambioant=create sle_tcambioant
this.st_tcambioant=create st_tcambioant
this.st_tcambiopago=create st_tcambiopago
this.cb_tcambio=create cb_tcambio
this.dw_tipoproceso=create dw_tipoproceso
this.cbx_patronales=create cbx_patronales
this.cbx_deducciones=create cbx_deducciones
this.st_1=create st_1
this.uo_progress=create uo_progress
this.gb_2=create gb_2
this.rb_soles=create rb_soles
this.rb_dolares=create rb_dolares
this.cbx_afectoaies=create cbx_afectoaies
this.dw_source_01=create dw_source_01
this.dw_source_02=create dw_source_02
this.dw_source_05=create dw_source_05
this.dw_source_06=create dw_source_06
this.dw_source_07=create dw_source_07
this.dw_source_08=create dw_source_08
this.dw_source_09=create dw_source_09
this.dw_source_10=create dw_source_10
this.dw_source_11=create dw_source_11
this.dw_source_12=create dw_source_12
this.dw_source=create dw_source
this.dw_source04_dir=create dw_source04_dir
this.cbx_todos=create cbx_todos
this.dw_planproc_p=create dw_planproc_p
this.dw_planproc_t=create dw_planproc_t
this.tab_1=create tab_1
this.dw_filtro=create dw_filtro
this.dw_planproc_p_ap=create dw_planproc_p_ap
this.dw_planproc_4ta_ap=create dw_planproc_4ta_ap
this.dw_planproc_4t=create dw_planproc_4t
this.dw_planproc_t_ap=create dw_planproc_t_ap
this.dw_idesunat=create dw_idesunat
this.st_2=create st_2
this.dw_source_29=create dw_source_29
iCurrent=UpperBound(this.Control)
this.Control[iCurrent+1]=this.dw_source_30
this.Control[iCurrent+2]=this.dw_source_27
this.Control[iCurrent+3]=this.dw_source_26
this.Control[iCurrent+4]=this.cb_idesunat
this.Control[iCurrent+5]=this.dw_source_17_02
this.Control[iCurrent+6]=this.dw_rtps_uap
this.Control[iCurrent+7]=this.dw_source_20
this.Control[iCurrent+8]=this.dw_source_19
this.Control[iCurrent+9]=this.dw_source_02_sdd
this.Control[iCurrent+10]=this.dw_source_02_edd
this.Control[iCurrent+11]=this.dw_source_13
this.Control[iCurrent+12]=this.dw_source_15
this.Control[iCurrent+13]=this.dw_source_16
this.Control[iCurrent+14]=this.dw_source_17
this.Control[iCurrent+15]=this.dw_source_21
this.Control[iCurrent+16]=this.dw_source_14
this.Control[iCurrent+17]=this.dw_source_18
this.Control[iCurrent+18]=this.dw_diskette
this.Control[iCurrent+19]=this.dw_reporte
this.Control[iCurrent+20]=this.cb_cerrar
this.Control[iCurrent+21]=this.dw_source_04
this.Control[iCurrent+22]=this.dw_source_ddhh
this.Control[iCurrent+23]=this.cb_procesar
this.Control[iCurrent+24]=this.sle_tcambiopago
this.Control[iCurrent+25]=this.sle_tcambioant
this.Control[iCurrent+26]=this.st_tcambioant
this.Control[iCurrent+27]=this.st_tcambiopago
this.Control[iCurrent+28]=this.cb_tcambio
this.Control[iCurrent+29]=this.dw_tipoproceso
this.Control[iCurrent+30]=this.cbx_patronales
this.Control[iCurrent+31]=this.cbx_deducciones
this.Control[iCurrent+32]=this.st_1
this.Control[iCurrent+33]=this.uo_progress
this.Control[iCurrent+34]=this.gb_2
this.Control[iCurrent+35]=this.rb_soles
this.Control[iCurrent+36]=this.rb_dolares
this.Control[iCurrent+37]=this.cbx_afectoaies
this.Control[iCurrent+38]=this.dw_source_01
this.Control[iCurrent+39]=this.dw_source_02
this.Control[iCurrent+40]=this.dw_source_05
this.Control[iCurrent+41]=this.dw_source_06
this.Control[iCurrent+42]=this.dw_source_07
this.Control[iCurrent+43]=this.dw_source_08
this.Control[iCurrent+44]=this.dw_source_09
this.Control[iCurrent+45]=this.dw_source_10
this.Control[iCurrent+46]=this.dw_source_11
this.Control[iCurrent+47]=this.dw_source_12
this.Control[iCurrent+48]=this.dw_source
this.Control[iCurrent+49]=this.dw_source04_dir
this.Control[iCurrent+50]=this.cbx_todos
this.Control[iCurrent+51]=this.dw_planproc_p
this.Control[iCurrent+52]=this.dw_planproc_t
this.Control[iCurrent+53]=this.tab_1
this.Control[iCurrent+54]=this.dw_filtro
this.Control[iCurrent+55]=this.dw_planproc_p_ap
this.Control[iCurrent+56]=this.dw_planproc_4ta_ap
this.Control[iCurrent+57]=this.dw_planproc_4t
this.Control[iCurrent+58]=this.dw_planproc_t_ap
this.Control[iCurrent+59]=this.dw_idesunat
this.Control[iCurrent+60]=this.st_2
this.Control[iCurrent+61]=this.dw_source_29
end on

on w_pe_procesa_rtps.destroy
call super::destroy
destroy(this.dw_source_30)
destroy(this.dw_source_27)
destroy(this.dw_source_26)
destroy(this.cb_idesunat)
destroy(this.dw_source_17_02)
destroy(this.dw_rtps_uap)
destroy(this.dw_source_20)
destroy(this.dw_source_19)
destroy(this.dw_source_02_sdd)
destroy(this.dw_source_02_edd)
destroy(this.dw_source_13)
destroy(this.dw_source_15)
destroy(this.dw_source_16)
destroy(this.dw_source_17)
destroy(this.dw_source_21)
destroy(this.dw_source_14)
destroy(this.dw_source_18)
destroy(this.dw_diskette)
destroy(this.dw_reporte)
destroy(this.cb_cerrar)
destroy(this.dw_source_04)
destroy(this.dw_source_ddhh)
destroy(this.cb_procesar)
destroy(this.sle_tcambiopago)
destroy(this.sle_tcambioant)
destroy(this.st_tcambioant)
destroy(this.st_tcambiopago)
destroy(this.cb_tcambio)
destroy(this.dw_tipoproceso)
destroy(this.cbx_patronales)
destroy(this.cbx_deducciones)
destroy(this.st_1)
destroy(this.uo_progress)
destroy(this.gb_2)
destroy(this.rb_soles)
destroy(this.rb_dolares)
destroy(this.cbx_afectoaies)
destroy(this.dw_source_01)
destroy(this.dw_source_02)
destroy(this.dw_source_05)
destroy(this.dw_source_06)
destroy(this.dw_source_07)
destroy(this.dw_source_08)
destroy(this.dw_source_09)
destroy(this.dw_source_10)
destroy(this.dw_source_11)
destroy(this.dw_source_12)
destroy(this.dw_source)
destroy(this.dw_source04_dir)
destroy(this.cbx_todos)
destroy(this.dw_planproc_p)
destroy(this.dw_planproc_t)
destroy(this.tab_1)
destroy(this.dw_filtro)
destroy(this.dw_planproc_p_ap)
destroy(this.dw_planproc_4ta_ap)
destroy(this.dw_planproc_4t)
destroy(this.dw_planproc_t_ap)
destroy(this.dw_idesunat)
destroy(this.st_2)
destroy(this.dw_source_29)
end on

event objectstartevent;call super::objectstartevent;/*
------------------------------------------------------------------------------------------------------
Evento					: objectstartevent
Objetivo					: Centraliza los eventos de los controles de la ventana
Autor						: 
Fecha						: 
Nro. RQ					: 
Parámetros Entrada	: Ninguno
Parámetros Salida		: Ninguno
Observación				: Ninguno
------------------------------------------------------------------------------------------------------
Modificaciones
Nro. RQ		Fecha			Usuario			Descripción
------------------------------------------------------------------------------------------------------
RQ 00047		12/07/2012	JCOAGUILAP		Filtra por la versión de los archivos
------------------------------------------------------------------------------------------------------
*/
long w%_empleado, w%_filadesde, w%_filahasta, w%_filahasta2
long w%_indice 
long w%_resultado
String los_IncluirPlani, los_IncluirProc,los_AllPlani, los_AllProc

is_PeriCont = f_sql_get_periodocontable( "PR" )
		
Choose Case eventname
	Case "opened"		
		f_centrarventana(this)
		x=0
		y=0 
		dw_source.SetTransObject(SQLCA)
		datawindowchild dwc_compania
		dw_filtro.SetTransObject(SQLCA)		
		dw_filtro.getchild('companiasocio', dwc_compania)
		dw_filtro.InsertRow(0)
		dw_filtro.SetItem( 1, "CompaniaSocio", str_global.gv_companyowner )
		uo_progress.uf_Set_Position(0)

		dw_tipoproceso.Modify ("Perfil.Visible = '0'")
		dw_tipoproceso.Modify ("t_Perfil.Visible = '0'")

		dw_filtro.Modify ("t_tipoproceso.Visible = '0'")
		dw_filtro.Modify ("tipoproceso.Visible = '0'")		
		dw_tipoproceso.SetTransObject(SQLCA)
		dw_tipoproceso.Retrieve('00001') // RQ 00047
		dw_source_17_02.SetTransObject(SQLCA)		//Agregado por RLRL
				
		is_PerConAnt=String(Long(is_PeriCont)-1)
		if Mid(is_PerConAnt,5,2) ='00' 	then 
			is_PerConAnt=String(Long(is_PeriCont)-89)
		end if
		
		dw_filtro.object.periodo[1] = is_PerConAnt	
	
		tab_1.tabpage_1.dw_ft.object.allplanproc[1] = '1'
		tab_1.tabpage_1.dw_ft.object.allplanproc_ap[1] = '1'
		tab_1.tabpage_2.dw_fp.object.allplanproc[1] = '1'
		tab_1.tabpage_2.dw_fp.object.allplanproc_ap[1] = '1'
		tab_1.tabpage_3.dw_f4t.object.allplanproc[1] = '1'
		tab_1.tabpage_3.dw_f4t.object.allplanproc_ap[1] = '1'
				
	Case "cb_procesar_clicked"	

		dw_filtro.accepttext()
		iv$_CompaniaSocio = dw_filtro.GetItemString (1, "CompaniaSocio" )
		iv$_AllCompaniaSocio = "N"
		iv$_Periodo = dw_filtro.GetItemString (1, "Periodo")
		if len(iv$_Periodo ) = 0 or isnull(iv$_Periodo ) then
			messagebox("Error","Debe ingresar el periodo a procesar",StopSign!)
			return
		end if 
				
		is_ft_FlagIncluir='0'
		is_fp_FlagIncluir='0'
		is_f4t_FlagIncluir='0'
		
		if wf_CargaFiltros() = 0 Then Return
//		fw_ActualizaDatos()
		
		uo_progress.uf_Set_Position(0)
		uo_progress.uf_Check(FALSE)	

		SELECT DocumentoFiscal
		INTO	:iv$_documentofiscal
		FROM	CompaniaMast 
		WHERE CompaniaCodigo = substring ( :iv$_CompaniaSocio , 1 , 6 ) ;
		
		iv%_pidioarchivo = 0

		long w%_fila, w%_filas

		// Armar el arreglo de Tipo de Proceso para RTPS
		dw_tipoproceso.AcceptText()
		w%_filas = dw_tipoproceso.RowCount()
		w%_fila = dw_tipoproceso.find ("Seleccion = 'S'",1,w%_filas) 
		w%_indice = 0

		do while w%_fila > 0
			w%_indice++
			iv$_TipoProceso[w%_indice] = dw_tipoproceso.GetItemString (w%_fila, "TipoFile")
			
			w%_resultado= wf_procesa_file(dw_tipoproceso.GetItemString (w%_fila, "TipoFile"),dw_tipoproceso.GetItemString (w%_fila, "Descripcion"),dw_tipoproceso.GetItemString (w%_fila, "NombreFile"))
        
		   If w%_resultado=0 then
				
				dw_tipoproceso.SetItem(w%_fila,"Error","N")
			else
				dw_tipoproceso.SetItem(w%_fila,"Error","S")
			End if 	

			if w%_fila +1 > w%_filas then 
				exit
			end if
									 
			w%_fila = dw_tipoproceso.find ("Seleccion = 'S'",w%_fila + 1,w%_filas)
		loop 

		if dw_tipoproceso.find ("Error = 'S'",1,w%_filas) <= 0  then
			Messagebox("Proceso RTPS", "Se procesaron los archivos")
		end if

		uo_progress.uf_Set_Position(100)
		uo_progress.uf_Check(TRUE)


	Case "cb_cerrar_clicked"
		Close (this)
		
End Choose
end event

type dw_source_30 from datawindow within w_pe_procesa_rtps
integer x = 5609
integer y = 444
integer width = 238
integer height = 72
integer taborder = 230
boolean bringtotop = true
string dataobject = "dw_pe_procesa_ar30_cta"
end type

type dw_source_27 from datawindow within w_pe_procesa_rtps
integer x = 5125
integer y = 444
integer width = 238
integer height = 72
integer taborder = 110
boolean bringtotop = true
string dataobject = "dw_pe_procesa_ar27_poc"
end type

type dw_source_26 from datawindow within w_pe_procesa_rtps
integer x = 4882
integer y = 444
integer width = 238
integer height = 72
integer taborder = 180
boolean bringtotop = true
string dataobject = "dw_pe_procesa_ar26_toc"
end type

type cb_idesunat from commandbutton within w_pe_procesa_rtps
string tag = "Importar Data Sunat"
integer x = 3456
integer y = 56
integer width = 480
integer height = 96
integer taborder = 80
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Importar Data Sunat"
end type

event clicked;String                    ls_Nulo
Long                      ll_items

str_param 				ls_str_param

ls_str_param.s_action = 'new'
ls_str_param.s_win_title = 'Importar Data T-registro'
f_insert_log_auditoria('N3','','','','IM','',this,Parent.Classname())
Openwithparm(w_pe_importa_data_tregistro, ls_str_param)




end event

type dw_source_17_02 from datawindow within w_pe_procesa_rtps
string tag = "dw_pe_procesa_ar17_tes"
integer x = 4882
integer y = 364
integer width = 238
integer height = 72
integer taborder = 170
boolean bringtotop = true
string dataobject = "dw_rtps_procesa_ar1702"
end type

type dw_rtps_uap from datawindow within w_pe_procesa_rtps
integer x = 5861
integer y = 116
integer width = 471
integer height = 76
integer taborder = 110
string title = "none"
string dataobject = "dw_rtps_procesa_ar20_uap"
boolean livescroll = true
end type

type dw_source_20 from datawindow within w_pe_procesa_rtps
integer x = 5609
integer y = 364
integer width = 238
integer height = 72
integer taborder = 100
boolean bringtotop = true
string dataobject = "dw_pe_procesa_ar20_4ta"
boolean livescroll = true
end type

type dw_source_19 from datawindow within w_pe_procesa_rtps
integer x = 5367
integer y = 364
integer width = 238
integer height = 72
integer taborder = 110
boolean bringtotop = true
string dataobject = "dw_pe_procesa_ar19_pen"
boolean livescroll = true
end type

type dw_source_02_sdd from datawindow within w_pe_procesa_rtps
integer x = 5367
integer y = 40
integer width = 238
integer height = 72
integer taborder = 170
boolean bringtotop = true
string dataobject = "dw_rtps_procesa_ar2_sdd"
boolean livescroll = true
end type

type dw_source_02_edd from datawindow within w_pe_procesa_rtps
integer x = 5125
integer y = 40
integer width = 238
integer height = 72
integer taborder = 140
boolean bringtotop = true
string dataobject = "dw_rtps_procesa_ar2_edd"
boolean livescroll = true
end type

type dw_source_13 from datawindow within w_pe_procesa_rtps
integer x = 4882
integer y = 284
integer width = 238
integer height = 72
integer taborder = 160
boolean bringtotop = true
string dataobject = "dw_rtps_procesa_ar13"
end type

type dw_source_15 from datawindow within w_pe_procesa_rtps
integer x = 5367
integer y = 284
integer width = 238
integer height = 72
integer taborder = 50
boolean bringtotop = true
string dataobject = "dw_pe_procesa_ar15_snl"
boolean livescroll = true
end type

type dw_source_16 from datawindow within w_pe_procesa_rtps
integer x = 5614
integer y = 284
integer width = 238
integer height = 72
integer taborder = 190
boolean bringtotop = true
string dataobject = "dw_rtps_procesa_ar16"
boolean livescroll = true
end type

type dw_source_17 from datawindow within w_pe_procesa_rtps
integer x = 4640
integer y = 364
integer width = 238
integer height = 72
integer taborder = 160
boolean bringtotop = true
string dataobject = "dw_pe_procesa_ar17_tes"
end type

type dw_source_21 from datawindow within w_pe_procesa_rtps
integer x = 4640
integer y = 444
integer width = 238
integer height = 72
integer taborder = 100
boolean bringtotop = true
string dataobject = "dw_rtps_procesa_ar21"
end type

type dw_source_14 from datawindow within w_pe_procesa_rtps
integer x = 5125
integer y = 284
integer width = 238
integer height = 72
integer taborder = 100
boolean bringtotop = true
string dataobject = "dw_pe_procesa_ar14_jor"
boolean livescroll = true
end type

type dw_source_18 from datawindow within w_pe_procesa_rtps
integer x = 5125
integer y = 364
integer width = 238
integer height = 72
integer taborder = 250
boolean bringtotop = true
string dataobject = "dw_pe_procesa_ar18_rem"
end type

type dw_diskette from u_dw within w_pe_procesa_rtps
integer x = 5234
integer y = 852
integer width = 265
integer height = 100
integer taborder = 40
string dataobject = "dw_pr_planilla_diskette_ipss"
end type

type dw_reporte from u_dw within w_pe_procesa_rtps
integer x = 5243
integer y = 972
integer width = 251
integer height = 104
integer taborder = 170
string dataobject = "dw_pr_planilla_diskette_ipss_reporte"
end type

type cb_cerrar from u_cb within w_pe_procesa_rtps
integer x = 3406
integer y = 2456
integer height = 84
integer taborder = 50
boolean bringtotop = true
integer weight = 400
string text = "&Cerrar"
end type

type dw_source_04 from datawindow within w_pe_procesa_rtps
integer x = 4640
integer y = 124
integer width = 238
integer height = 72
integer taborder = 180
boolean bringtotop = true
string dataobject = "dw_pe_procesa_ar4_ide"
end type

type dw_source_ddhh from datawindow within w_pe_procesa_rtps
integer x = 4882
integer y = 124
integer width = 238
integer height = 72
integer taborder = 240
boolean bringtotop = true
string dataobject = "dw_rtps_procesa_ar4"
boolean livescroll = true
end type

type cb_procesar from u_cb within w_pe_procesa_rtps
integer x = 2834
integer y = 2456
integer height = 84
integer taborder = 160
boolean bringtotop = true
integer weight = 400
string text = "&Procesar"
boolean default = true
end type

type sle_tcambiopago from singlelineedit within w_pe_procesa_rtps
integer x = 6167
integer y = 1896
integer width = 215
integer height = 72
integer taborder = 220
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long backcolor = 16777215
string text = "3.34"
boolean autohscroll = false
borderstyle borderstyle = stylelowered!
end type

type sle_tcambioant from singlelineedit within w_pe_procesa_rtps
integer x = 5637
integer y = 1896
integer width = 210
integer height = 72
integer taborder = 230
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long backcolor = 16777215
string text = "3.318"
boolean autohscroll = false
borderstyle borderstyle = stylelowered!
end type

type st_tcambioant from statictext within w_pe_procesa_rtps
boolean visible = false
integer x = 1152
integer y = 1316
integer width = 297
integer height = 60
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long backcolor = 12632256
boolean enabled = false
string text = "T.C Anterior"
boolean focusrectangle = false
end type

type st_tcambiopago from statictext within w_pe_procesa_rtps
integer x = 5883
integer y = 1908
integer width = 261
integer height = 60
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long backcolor = 12632256
boolean enabled = false
string text = "T.C Nuevo"
boolean focusrectangle = false
end type

type cb_tcambio from u_cb within w_pe_procesa_rtps
boolean visible = false
integer x = 768
integer y = 1304
integer height = 84
integer taborder = 30
boolean bringtotop = true
integer weight = 400
string text = "Obtener T.C."
end type

event clicked;call super::clicked;double w#_tipocambio
iv$_Periodo = Left (dw_filtro.GetItemString (1, "Periodo"),6)
SELECT TipoCambio INTO :w#_tipocambio FROM PR_PlanillaEmpleado WHERE Substring (Periodo,1,6) = :iv$_periodo;

sle_tcambioant.Text = string (string (w#_tipocambio))
end event

type dw_tipoproceso from datawindow within w_pe_procesa_rtps
integer x = 23
integer y = 748
integer width = 4224
integer height = 1680
integer taborder = 20
boolean bringtotop = true
string dataobject = "dw_pr_gen_files_tipoproceso"
richtexttoolbaractivation richtexttoolbaractivation = richtexttoolbaractivationalways!
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

type cbx_patronales from checkbox within w_pe_procesa_rtps
integer x = 5349
integer y = 1996
integer width = 311
integer height = 76
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long textcolor = 33554432
long backcolor = 67108864
string text = "Patronales"
boolean checked = true
boolean lefttext = true
end type

type cbx_deducciones from checkbox within w_pe_procesa_rtps
integer x = 5774
integer y = 1996
integer width = 357
integer height = 76
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long textcolor = 33554432
long backcolor = 67108864
string text = "Deducciones"
boolean checked = true
boolean lefttext = true
end type

type st_1 from statictext within w_pe_procesa_rtps
integer x = 41
integer y = 2448
integer width = 928
integer height = 116
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long backcolor = 12632256
boolean enabled = false
boolean focusrectangle = false
end type

type uo_progress from u_progress_bar within w_pe_procesa_rtps
event destroy ( )
integer x = 997
integer y = 2464
integer width = 1198
integer taborder = 190
boolean border = false
end type

on uo_progress.destroy
call u_progress_bar::destroy
end on

type gb_2 from groupbox within w_pe_procesa_rtps
integer x = 64
integer y = 2736
integer width = 2258
integer height = 264
integer taborder = 210
integer textsize = -9
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long backcolor = 12632256
string text = "Moneda"
end type

type rb_soles from radiobutton within w_pe_procesa_rtps
integer x = 133
integer y = 2816
integer width = 247
integer height = 76
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long backcolor = 12632256
string text = "Soles"
boolean checked = true
boolean lefttext = true
end type

event clicked;st_tcambioant.Visible = FALSE
st_tcambiopago.Visible = FALSE

sle_tcambioant.Visible = FALSE
sle_tcambiopago.Visible = FALSE

cb_tcambio.Visible = FALSE

cbx_deducciones.visible = false
cbx_patronales.visible = false

//sle_tcambioant.Text = "0"
//sle_tcambiopago.Text = "0"
end event

type rb_dolares from radiobutton within w_pe_procesa_rtps
integer x = 393
integer y = 2816
integer width = 247
integer height = 76
boolean bringtotop = true
integer textsize = -9
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long backcolor = 12632256
string text = "Dólares"
boolean lefttext = true
end type

event clicked;st_tcambioant.Visible = TRUE
st_tcambiopago.Visible = TRUE

sle_tcambioant.Visible = TRUE
sle_tcambiopago.Visible = TRUE

cb_tcambio.Visible = TRUE

cbx_deducciones.visible = true
cbx_patronales.visible = true

sle_tcambioant.Text = "0"
sle_tcambiopago.Text = "0"

end event

type cbx_afectoaies from checkbox within w_pe_procesa_rtps
integer x = 59
integer y = 2612
integer width = 421
integer height = 76
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long backcolor = 12632256
string text = "Afecto a IES"
boolean lefttext = true
end type

type dw_source_01 from datawindow within w_pe_procesa_rtps
integer x = 4640
integer y = 40
integer width = 238
integer height = 72
integer taborder = 250
boolean bringtotop = true
string dataobject = "dw_rtps_procesa_ar1"
boolean livescroll = true
end type

type dw_source_02 from datawindow within w_pe_procesa_rtps
integer x = 4882
integer y = 40
integer width = 238
integer height = 72
integer taborder = 70
boolean bringtotop = true
string dataobject = "dw_rtps_procesa_ar2"
boolean livescroll = true
end type

type dw_source_05 from datawindow within w_pe_procesa_rtps
integer x = 5367
integer y = 124
integer width = 238
integer height = 72
integer taborder = 80
boolean bringtotop = true
string dataobject = "dw_pe_procesa_ar5_tra"
end type

type dw_source_06 from datawindow within w_pe_procesa_rtps
integer x = 5614
integer y = 124
integer width = 238
integer height = 72
integer taborder = 90
boolean bringtotop = true
string dataobject = "dw_pe_procesa_ar6_pen"
boolean livescroll = true
end type

type dw_source_07 from datawindow within w_pe_procesa_rtps
integer x = 4640
integer y = 204
integer width = 238
integer height = 72
integer taborder = 100
boolean bringtotop = true
string dataobject = "dw_pe_procesa_ar7_ps4"
boolean livescroll = true
end type

type dw_source_08 from datawindow within w_pe_procesa_rtps
integer x = 4882
integer y = 204
integer width = 238
integer height = 72
integer taborder = 110
boolean bringtotop = true
string dataobject = "dw_rtps_procesa_ar8"
boolean livescroll = true
end type

type dw_source_09 from datawindow within w_pe_procesa_rtps
integer x = 5125
integer y = 204
integer width = 238
integer height = 72
integer taborder = 120
boolean bringtotop = true
string dataobject = "dw_rtps_procesa_ar9"
boolean livescroll = true
end type

type dw_source_10 from datawindow within w_pe_procesa_rtps
integer x = 5367
integer y = 204
integer width = 238
integer height = 72
integer taborder = 130
boolean bringtotop = true
string dataobject = "dw_rtps_procesa_ar10"
boolean livescroll = true
end type

type dw_source_11 from datawindow within w_pe_procesa_rtps
integer x = 5614
integer y = 204
integer width = 238
integer height = 72
integer taborder = 140
boolean bringtotop = true
string dataobject = "dw_pe_procesa_ar11_per"
boolean livescroll = true
end type

type dw_source_12 from datawindow within w_pe_procesa_rtps
integer x = 4640
integer y = 284
integer width = 238
integer height = 72
integer taborder = 150
boolean bringtotop = true
string dataobject = "dw_rtps_procesa_ar12"
boolean livescroll = true
end type

type dw_source from datawindow within w_pe_procesa_rtps
integer x = 5865
integer y = 36
integer width = 334
integer height = 72
integer taborder = 200
boolean bringtotop = true
boolean livescroll = true
end type

type dw_source04_dir from datawindow within w_pe_procesa_rtps
integer x = 5125
integer y = 124
integer width = 238
integer height = 72
integer taborder = 60
boolean bringtotop = true
string dataobject = "dw_pe_procesa_ar4_ide_dir"
boolean livescroll = true
end type

type cbx_todos from checkbox within w_pe_procesa_rtps
integer x = 2743
integer y = 60
integer width = 640
integer height = 76
boolean bringtotop = true
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "MS Sans Serif"
long textcolor = 33554432
long backcolor = 12632256
string text = "Marcar/Desmarcar Todos"
end type

event clicked;long w%_fila, w%_filas

w%_filas = dw_tipoproceso.RowCount()

	
if cbx_todos.checked =true then

	For w%_fila=1 to w%_filas 
		
		dw_tipoproceso.SetItem(w%_fila,"Seleccion","S")
	Next 	
	
else
	For w%_fila=1 to w%_filas 
		
		dw_tipoproceso.SetItem(w%_fila,"Seleccion","N")
	Next 	


end if	


end event

type dw_planproc_p from u_dw within w_pe_procesa_rtps
integer x = 5111
integer y = 740
integer width = 1659
integer height = 952
integer taborder = 180
string dataobject = "dw_list_tipos_planillas_select_fppp"
boolean hscrollbar = true
boolean vscrollbar = true
borderstyle borderstyle = stylelowered!
end type

event buttonclicked;call super::buttonclicked;String		los_FlagIncl, los_FlagInclProc, los_TipoPlan, los_TipoProc, los_CadePlanProc
Long		lol_fila

Choose Case dwo.name
	Case 'b_aceptar'
		For lol_fila = 1 To This.rowcount( )
			los_FlagIncl 			= This.object.flg_incluido[lol_fila]
			los_FlagInclProc 	= This.object.flg_incluidoproc[lol_fila]
			
			If los_FlagIncl = '1' AND los_FlagInclProc = '1' Then
				los_TipoPlan = This.object.tipoplanilla[lol_fila]
				los_TipoProc = This.object.tipoproceso[lol_fila]				
				los_CadePlanProc = los_CadePlanProc + los_TipoPlan + los_TipoProc								
			End If
		Next
		This.Visible = False
		tab_1.tabpage_2.dw_fp.object.planproc[1] = los_CadePlanProc
	Case 'b_cancel'
		This.Visible = False
	Case 	Else
		This.Visible = False
End Choose
end event

event constructor;call super::constructor;This.settransobject( sqlca )
end event

type dw_planproc_t from u_dw within w_pe_procesa_rtps
integer x = 5111
integer y = 740
integer width = 1659
integer height = 952
integer taborder = 40
string dataobject = "dw_list_tipos_planillas_select_fppt"
boolean hscrollbar = true
boolean vscrollbar = true
borderstyle borderstyle = stylelowered!
end type

event constructor;call super::constructor;This.settransobject( sqlca )
end event

event buttonclicked;call super::buttonclicked;String		los_FlagIncl, los_FlagInclProc, los_TipoPlan, los_TipoProc, los_CadePlanProc
Long		lol_fila

Choose Case dwo.name
	Case 'b_aceptar'
		For lol_fila = 1 To This.rowcount( )
			los_FlagIncl 			= This.object.flg_incluido[lol_fila]
			los_FlagInclProc 	= This.object.flg_incluidoproc[lol_fila]
			
			If los_FlagIncl = '1' AND los_FlagInclProc = '1' Then
				los_TipoPlan = This.object.tipoplanilla[lol_fila]
				los_TipoProc = This.object.tipoproceso[lol_fila]				
				los_CadePlanProc = los_CadePlanProc + los_TipoPlan + los_TipoProc								
			End If
		Next
		This.Visible = False
		tab_1.tabpage_1.dw_ft.object.planproc[1] = los_CadePlanProc
	Case 'b_cancel'
		This.Visible = False
	Case 	Else
		This.Visible = False
End Choose
end event

type tab_1 from tab within w_pe_procesa_rtps
integer x = 4338
integer y = 560
integer width = 2606
integer height = 460
integer taborder = 200
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 12632256
boolean raggedright = true
boolean focusonbuttondown = true
integer selectedtab = 1
tabpage_1 tabpage_1
tabpage_2 tabpage_2
tabpage_3 tabpage_3
end type

on tab_1.create
this.tabpage_1=create tabpage_1
this.tabpage_2=create tabpage_2
this.tabpage_3=create tabpage_3
this.Control[]={this.tabpage_1,&
this.tabpage_2,&
this.tabpage_3}
end on

on tab_1.destroy
destroy(this.tabpage_1)
destroy(this.tabpage_2)
destroy(this.tabpage_3)
end on

type tabpage_1 from userobject within tab_1
integer x = 18
integer y = 104
integer width = 2569
integer height = 340
long backcolor = 12632256
string text = "Trabajadores"
long tabtextcolor = 33554432
long tabbackcolor = 12632256
long picturemaskcolor = 536870912
dw_ft dw_ft
end type

on tabpage_1.create
this.dw_ft=create dw_ft
this.Control[]={this.dw_ft}
end on

on tabpage_1.destroy
destroy(this.dw_ft)
end on

type dw_ft from datawindow within tabpage_1
integer y = 16
integer width = 2542
integer height = 320
integer taborder = 80
string title = "none"
string dataobject = "dw_rtps_filtro_ftra"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;
This.settransobject( sqlca )
This.insertrow( 0 )

isdw_ft = This
end event

event clicked;String		los_Periodo, los_PeriAntPos, los_TipoPlan

This.accepttext( )
dw_filtro.accepttext( )

los_Periodo = Mid(dw_filtro.object.periodo[1],1,6) + Mid(dw_filtro.object.periodo[1],5,2)
los_PeriAntPos = Mid(dw_filtro.object.periantpost[1],1,6) + Mid(dw_filtro.object.periantpost[1],5,2)

Choose Case dwo.name
	Case 'planproc'				
		if tab_1.tabpage_1.dw_ft.object.allplanproc[1] = '1' Then Return 
		dw_planproc_t.retrieve(los_Periodo)		
		dw_planproc_t.visible = True
	Case 'planproc_ap'		
		if tab_1.tabpage_1.dw_ft.object.allplanproc_ap[1] = '1' Then Return 
		dw_planproc_t_ap.retrieve(los_Periodo)		
		dw_planproc_t_ap.visible = True
	Case 'allplanproc'
		If IsNull(los_Periodo) Or Trim(los_Periodo) = '' Then
			MessaGebox('Aviso','Registre el Periodo a Declarar...')
			dw_filtro.setfocus( )
			dw_filtro.setcolumn( "periodo" )
			dw_planproc_t.visible = False
			Return 1
		End If		
	Case 'allplanproc_ap'
		If IsNull(los_PeriAntPos) Or Trim(los_PeriAntPos) = '' Then
			MessaGebox('Aviso','Registre el Periodo Anterior o Posterior a Declarar...')
			dw_filtro.setfocus( )
			dw_filtro.setcolumn( "periantpost" )
			dw_planproc_t_ap.visible = False
			Return 1
		End If
	Case else
		dw_planproc_t.visible = False
		dw_planproc_t_ap.visible = False		
End Choose


end event

type tabpage_2 from userobject within tab_1
integer x = 18
integer y = 104
integer width = 2569
integer height = 340
long backcolor = 12632256
string text = "Pensionistas"
long tabtextcolor = 33554432
long tabbackcolor = 12632256
long picturemaskcolor = 536870912
dw_fp dw_fp
end type

on tabpage_2.create
this.dw_fp=create dw_fp
this.Control[]={this.dw_fp}
end on

on tabpage_2.destroy
destroy(this.dw_fp)
end on

type dw_fp from datawindow within tabpage_2
integer y = 16
integer width = 2537
integer height = 320
integer taborder = 190
string title = "none"
string dataobject = "dw_rtps_filtro_fpen"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;This.settransobject( sqlca )
This.insertrow( 0 )

isdw_fp = This
end event

event clicked;String		los_Periodo, los_TipoPlani

Choose Case dwo.name
	Case 'planproc'	
		los_Periodo = Mid(dw_filtro.object.periodo[1],1,6) + Mid(dw_filtro.object.periodo[1],5,2)
		dw_planproc_p.retrieve(los_Periodo)		
		dw_planproc_p.visible = True
	Case 'planproc_ap'
		los_Periodo = Mid(dw_filtro.object.periodo[1],1,6) + Mid(dw_filtro.object.periodo[1],5,2)
		los_TipoPlani = Trim(This.object.planillas[1])
	
		dw_planproc_p_ap.retrieve(los_Periodo,los_Periodo,los_TipoPlani)		
		dw_planproc_p_ap.visible = True
	Case else
		dw_planproc_p.visible = False
		dw_planproc_p_ap.visible = False
		
End Choose
end event

type tabpage_3 from userobject within tab_1
integer x = 18
integer y = 104
integer width = 2569
integer height = 340
long backcolor = 12632256
string text = "PS 4ta Categoría"
long tabtextcolor = 33554432
long tabbackcolor = 12632256
long picturemaskcolor = 536870912
dw_f4t dw_f4t
end type

on tabpage_3.create
this.dw_f4t=create dw_f4t
this.Control[]={this.dw_f4t}
end on

on tabpage_3.destroy
destroy(this.dw_f4t)
end on

type dw_f4t from datawindow within tabpage_3
integer y = 16
integer width = 2537
integer height = 324
integer taborder = 80
string title = "none"
string dataobject = "dw_rtps_filtro_f4ta"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;This.settransobject( sqlca )
This.insertrow( 0 )

isdw_f4t = This
end event

event clicked;String		los_Periodo, los_TipoPlani

Choose Case dwo.name
	Case 'planproc'	
		los_Periodo = Mid(dw_filtro.object.periodo[1],1,6) + Mid(dw_filtro.object.periodo[1],5,2)
		dw_planproc_4t.retrieve(los_Periodo)		
		dw_planproc_4t.visible = True
	Case 'planproc_ap'
		los_Periodo = Mid(dw_filtro.object.periodo[1],1,6) + Mid(dw_filtro.object.periodo[1],5,2)
		los_TipoPlani = Trim(This.object.planillas[1])
	
		dw_planproc_4ta_ap.retrieve(los_Periodo,los_Periodo,los_TipoPlani)		
		dw_planproc_4ta_ap.visible = True
	Case else
		dw_planproc_4t.visible = False
		dw_planproc_4ta_ap.visible = False
		
End Choose
end event

type dw_filtro from u_dw within w_pe_procesa_rtps
integer x = 23
integer y = 28
integer width = 4224
integer height = 712
integer taborder = 10
string dataobject = "dw_rtps_filtro"
borderstyle borderstyle = stylelowered!
end type

event clicked;
String		los_Periodo, los_TipoPlani

This.accepttext( )

dw_planproc_t.visible = False
dw_planproc_t_ap.visible = False
dw_planproc_p.visible = False
dw_planproc_p_ap.visible = False
dw_planproc_4t.visible = False
dw_planproc_4ta_ap.visible = False


Choose Case dwo.name
	Case 'indperiantpost'	
	
End Choose


end event

event itemchanged;call super::itemchanged;This.accepttext( )

Choose Case dwo.name
	Case 'indperiantpost'	
			This.object.ind_unicoper[1]='0'
	Case 'ind_unicoper'	
			This.object.indperiantpost[1] = '1'
			This.object.periantpost[1] = ''			
End Choose
end event

type dw_planproc_p_ap from u_dw within w_pe_procesa_rtps
integer x = 5111
integer y = 864
integer width = 1659
integer height = 952
integer taborder = 180
boolean bringtotop = true
string dataobject = "dw_list_tipos_planillas_select_fppp_ap"
boolean hscrollbar = true
boolean vscrollbar = true
borderstyle borderstyle = stylelowered!
end type

event constructor;call super::constructor;This.settransobject( sqlca )
end event

event buttonclicked;call super::buttonclicked;String		los_FlagIncl,los_FlagInclProc, los_TipoPlan,los_TipoProc, los_CadePlanProc
Long		lol_fila

Choose Case dwo.name
	Case 'b_aceptar'
		For lol_fila = 1 To This.rowcount( )
			los_FlagIncl 			= This.object.flg_incluido[lol_fila]
			los_FlagInclProc 	= This.object.flg_incluidoproc[lol_fila]
			
			If los_FlagIncl = '1' AND los_FlagInclProc = '1' Then
				los_TipoPlan = This.object.tipoplanilla[lol_fila]
				los_TipoProc = This.object.tipoproceso[lol_fila]				
				los_CadePlanProc = los_CadePlanProc + los_TipoPlan + los_TipoProc
			End If
		Next
		This.Visible = False
		tab_1.tabpage_2.dw_fp.object.planproc_ap[1] = los_CadePlanProc
	Case 'b_cancel'
		This.Visible = False
	Case else
		This.Visible = False
End Choose
end event

type dw_planproc_4ta_ap from u_dw within w_pe_procesa_rtps
integer x = 5111
integer y = 864
integer width = 1659
integer height = 952
integer taborder = 180
boolean bringtotop = true
string dataobject = "dw_list_tipos_planillas_select_fpp4t_ap"
boolean hscrollbar = true
boolean vscrollbar = true
borderstyle borderstyle = stylelowered!
end type

event constructor;call super::constructor;This.settransobject( sqlca )
end event

event buttonclicked;call super::buttonclicked;String		los_FlagIncl,los_FlagInclProc, los_TipoPlan,los_TipoProc, los_CadePlanProc
Long		lol_fila

Choose Case dwo.name
	Case 'b_aceptar'
		For lol_fila = 1 To This.rowcount( )
			los_FlagIncl 			= This.object.flg_incluido[lol_fila]
			los_FlagInclProc 	= This.object.flg_incluidoproc[lol_fila]
			
			If los_FlagIncl = '1' AND los_FlagInclProc = '1' Then
				los_TipoPlan = This.object.tipoplanilla[lol_fila]
				los_TipoProc = This.object.tipoproceso[lol_fila]				
				los_CadePlanProc = los_CadePlanProc + los_TipoPlan + los_TipoProc
			End If
		Next
		This.Visible = False
		tab_1.tabpage_3.dw_f4t.object.planproc_ap[1] = los_CadePlanProc
	Case 'b_cancel'
		This.Visible = False
	Case else
		This.Visible = False
End Choose
end event

type dw_planproc_4t from u_dw within w_pe_procesa_rtps
integer x = 5111
integer y = 740
integer width = 1659
integer height = 952
integer taborder = 180
boolean bringtotop = true
string dataobject = "dw_list_tipos_planillas_select_fpp4t"
boolean hscrollbar = true
boolean vscrollbar = true
borderstyle borderstyle = stylelowered!
end type

event constructor;call super::constructor;This.settransobject( sqlca )
end event

event buttonclicked;call super::buttonclicked;String		los_FlagIncl, los_FlagInclProc, los_TipoPlan, los_TipoProc, los_CadePlanProc
Long		lol_fila

Choose Case dwo.name
	Case 'b_aceptar'
		For lol_fila = 1 To This.rowcount( )
			los_FlagIncl 			= This.object.flg_incluido[lol_fila]
			los_FlagInclProc 	= This.object.flg_incluidoproc[lol_fila]
			
			If los_FlagIncl = '1' AND los_FlagInclProc = '1' Then
				los_TipoPlan = This.object.tipoplanilla[lol_fila]
				los_TipoProc = This.object.tipoproceso[lol_fila]				
				los_CadePlanProc = los_CadePlanProc + los_TipoPlan + los_TipoProc								
			End If
		Next
		This.Visible = False
		tab_1.tabpage_3.dw_f4t.object.planproc[1] = los_CadePlanProc
	Case 'b_cancel'
		This.Visible = False
	Case 	Else
		This.Visible = False
End Choose
end event

type dw_planproc_t_ap from u_dw within w_pe_procesa_rtps
integer x = 5111
integer y = 864
integer width = 1659
integer height = 952
integer taborder = 30
boolean bringtotop = true
string dataobject = "dw_list_tipos_planillas_select_fppt_ap"
boolean hscrollbar = true
boolean vscrollbar = true
borderstyle borderstyle = stylelowered!
end type

event constructor;call super::constructor;This.settransobject( sqlca )
end event

event buttonclicked;call super::buttonclicked;String		los_FlagIncl, los_FlagInclProc, los_TipoPlan, los_TipoProc, los_CadePlanProc
Long		lol_fila

Choose Case dwo.name
	Case 'b_aceptar'
		For lol_fila = 1 To This.rowcount( )
			los_FlagIncl 			= This.object.flg_incluido[lol_fila]
			los_FlagInclProc 	= This.object.flg_incluidoproc[lol_fila]
			
			If los_FlagIncl = '1' AND los_FlagInclProc = '1' Then
				los_TipoPlan = This.object.tipoplanilla[lol_fila]
				los_TipoProc = This.object.tipoproceso[lol_fila]				
				los_CadePlanProc = los_CadePlanProc + los_TipoPlan + los_TipoProc	
			End If
		Next
		This.Visible = False
		tab_1.tabpage_1.dw_ft.object.planproc_ap[1] = los_CadePlanProc
	Case 'b_cancel'
		This.Visible = False
	Case else
		This.Visible = False
End Choose
end event

type dw_idesunat from datawindow within w_pe_procesa_rtps
integer x = 5893
integer y = 204
integer width = 370
integer height = 312
integer taborder = 120
boolean bringtotop = true
string dataobject = "dw_pe_ide_sunat"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;
This.settransobject( sqlca )
end event

type st_2 from statictext within w_pe_procesa_rtps
boolean visible = false
integer x = 110
integer y = 1084
integer width = 3561
integer height = 132
boolean bringtotop = true
integer textsize = -14
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 128
long backcolor = 12632256
string text = "I m p o r t a n d o        D a t o s    d e l   T-R e g i s t r o      S U N A T  . . ."
alignment alignment = center!
boolean focusrectangle = false
end type

type dw_source_29 from datawindow within w_pe_procesa_rtps
integer x = 5367
integer y = 444
integer width = 238
integer height = 72
integer taborder = 180
boolean bringtotop = true
string dataobject = "dw_pe_procesa_ar29_edu"
end type

