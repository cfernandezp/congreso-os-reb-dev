forward
global type w_sy_usuario_proceso from window
end type
type dw_filtros from datawindow within w_sy_usuario_proceso
end type
type cbx_1 from checkbox within w_sy_usuario_proceso
end type
type cb_5 from commandbutton within w_sy_usuario_proceso
end type
type dw_tipoproceso2 from datawindow within w_sy_usuario_proceso
end type
type st_2 from statictext within w_sy_usuario_proceso
end type
type st_1 from statictext within w_sy_usuario_proceso
end type
type cb_4 from commandbutton within w_sy_usuario_proceso
end type
type cb_3 from commandbutton within w_sy_usuario_proceso
end type
type dw_tipoplanilla from datawindow within w_sy_usuario_proceso
end type
type cb_2 from commandbutton within w_sy_usuario_proceso
end type
type cb_1 from commandbutton within w_sy_usuario_proceso
end type
type dw_planillaproceso from datawindow within w_sy_usuario_proceso
end type
type dw_tipoproceso from datawindow within w_sy_usuario_proceso
end type
end forward

global type w_sy_usuario_proceso from window
integer width = 3177
integer height = 2528
boolean titlebar = true
string title = "Usuarios: Planillas-Procesos"
boolean controlmenu = true
windowtype windowtype = response!
long backcolor = 16777215
string icon = "AppIcon!"
boolean center = true
dw_filtros dw_filtros
cbx_1 cbx_1
cb_5 cb_5
dw_tipoproceso2 dw_tipoproceso2
st_2 st_2
st_1 st_1
cb_4 cb_4
cb_3 cb_3
dw_tipoplanilla dw_tipoplanilla
cb_2 cb_2
cb_1 cb_1
dw_planillaproceso dw_planillaproceso
dw_tipoproceso dw_tipoproceso
end type
global w_sy_usuario_proceso w_sy_usuario_proceso

type variables
string v_usuario
end variables

on w_sy_usuario_proceso.create
this.dw_filtros=create dw_filtros
this.cbx_1=create cbx_1
this.cb_5=create cb_5
this.dw_tipoproceso2=create dw_tipoproceso2
this.st_2=create st_2
this.st_1=create st_1
this.cb_4=create cb_4
this.cb_3=create cb_3
this.dw_tipoplanilla=create dw_tipoplanilla
this.cb_2=create cb_2
this.cb_1=create cb_1
this.dw_planillaproceso=create dw_planillaproceso
this.dw_tipoproceso=create dw_tipoproceso
this.Control[]={this.dw_filtros,&
this.cbx_1,&
this.cb_5,&
this.dw_tipoproceso2,&
this.st_2,&
this.st_1,&
this.cb_4,&
this.cb_3,&
this.dw_tipoplanilla,&
this.cb_2,&
this.cb_1,&
this.dw_planillaproceso,&
this.dw_tipoproceso}
end on

on w_sy_usuario_proceso.destroy
destroy(this.dw_filtros)
destroy(this.cbx_1)
destroy(this.cb_5)
destroy(this.dw_tipoproceso2)
destroy(this.st_2)
destroy(this.st_1)
destroy(this.cb_4)
destroy(this.cb_3)
destroy(this.dw_tipoplanilla)
destroy(this.cb_2)
destroy(this.cb_1)
destroy(this.dw_planillaproceso)
destroy(this.dw_tipoproceso)
end on

event open;

v_usuario=message.stringparm

// Agregar usuario al título
this.title = "Usuarios: Planillas-Procesos - " + v_usuario

dw_planillaproceso.settransobject( sqlca )
dw_planillaproceso.retrieve( v_usuario )

long v_i



for v_i = 1 to dw_tipoproceso.rowcount()
	
	dw_tipoproceso.scrolltorow(v_i )
	dw_tipoproceso2.scrolltorow(dw_tipoproceso2.insertrow(0 ))

		dw_tipoproceso2.object.codigo[ dw_tipoproceso2.getrow()] =  dw_tipoproceso.object.tipoproceso[ dw_tipoproceso.getrow()] 
		dw_tipoproceso2.object.descripcion[dw_tipoproceso2.getrow()] =  dw_tipoproceso.object.descripcion[dw_tipoproceso.getrow()]
	
next	

dw_tipoproceso2.scrolltorow( 1 )	

// Inicializar DW de filtros
datawindowchild ldwc_planilla, ldwc_proceso

dw_filtros.insertrow(0)

// Poblar DDDW de tipoplanilla
dw_filtros.getchild("tipoplanilla", ldwc_planilla)
ldwc_planilla.settransobject(sqlca)
ldwc_planilla.retrieve()

// Poblar DDDW de tipoproceso
dw_filtros.getchild("tipoproceso", ldwc_proceso)
ldwc_proceso.settransobject(sqlca)
ldwc_proceso.retrieve()



end event

type dw_filtros from datawindow within w_sy_usuario_proceso
integer x = 59
integer y = 1124
integer width = 2405
integer height = 188
integer taborder = 40
string title = "none"
string dataobject = "dw_filtro_seguridad"
boolean livescroll = true
borderstyle borderstyle = styleraised!
end type

event buttonclicked;string ls_tipoplanilla, ls_tipoproceso, ls_filter

choose case dwo.name
    case "b_filtrar"
        ls_tipoplanilla = this.getitemstring(1, "tipoplanilla")
        ls_tipoproceso = this.getitemstring(1, "tipoproceso")
        
        ls_filter = ""
        
        // Filtrar por planilla
        if not isnull(ls_tipoplanilla) and trim(ls_tipoplanilla) <> "" then
            ls_filter = "tipoplanilla = '" + trim(ls_tipoplanilla) + "'"
        end if
        
        // Filtrar por proceso
        if not isnull(ls_tipoproceso) and trim(ls_tipoproceso) <> "" then
            if ls_filter <> "" then ls_filter += " and "
            ls_filter += "tipoproceso = '" + trim(ls_tipoproceso) + "'"
        end if
        
        // Aplicar filtro
        dw_planillaproceso.setfilter(ls_filter)
        dw_planillaproceso.filter()
        
    case "b_cancelar"
        // Limpiar filtros
        this.setitem(1, "tipoplanilla", "")
        this.setitem(1, "tipoproceso", "")
        
        dw_planillaproceso.setfilter("")
        dw_planillaproceso.filter()
        
end choose
end event

type cbx_1 from checkbox within w_sy_usuario_proceso
integer x = 2592
integer y = 152
integer width = 507
integer height = 76
integer textsize = -9
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 16777215
string text = "Selecciona todo"
end type

event clicked;string v_tipoplanilla, v_tipoproceso, xi
long v_i, ll_fila

if this.checked then
	xi=  "1" 
else
	xi=  "0" 
end if	


for v_i = 1 to dw_tipoproceso2.rowcount( )
	
  dw_tipoproceso2.scrolltorow( v_i )		
  dw_tipoproceso2.object.activo[ v_i  ] = xi 
	
next	



dw_tipoproceso2.scrolltorow( 1 )	
end event

type cb_5 from commandbutton within w_sy_usuario_proceso
integer x = 2459
integer y = 1012
integer width = 434
integer height = 92
integer taborder = 20
integer textsize = -9
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Eliminar todo"
end type

event clicked;//dw_planillaproceso.reset()

//dw_planillaproceso.reset()

long v_i

for v_i = 1 to dw_planillaproceso.rowcount()
	
dw_planillaproceso.scrolltorow(v_i )
//dw_planillaproceso.deleterow( 0 )

dw_planillaproceso.deleterow( 0 )

//	dw_planillaproceso.scrolltorow(dw_planillaproceso.deleterow( 0 ) )
next	
end event

type dw_tipoproceso2 from datawindow within w_sy_usuario_proceso
integer x = 1600
integer y = 240
integer width = 1499
integer height = 752
integer taborder = 30
string title = "none"
string dataobject = "dw_usuario_proceso_tproc2"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

type st_2 from statictext within w_sy_usuario_proceso
integer x = 46
integer y = 164
integer width = 713
integer height = 60
integer textsize = -9
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 16777215
string text = "Seleccione Tipo de Planilla"
boolean focusrectangle = false
end type

type st_1 from statictext within w_sy_usuario_proceso
integer x = 1586
integer y = 156
integer width = 713
integer height = 60
integer textsize = -9
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long backcolor = 16777215
string text = "Seleccione Tipo de Proceso"
boolean focusrectangle = false
end type

type cb_4 from commandbutton within w_sy_usuario_proceso
integer x = 1774
integer y = 1008
integer width = 352
integer height = 92
integer taborder = 40
integer textsize = -9
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Eliminar"
end type

event clicked;dw_planillaproceso.deleterow( 0 )
end event

type cb_3 from commandbutton within w_sy_usuario_proceso
integer x = 1417
integer y = 1008
integer width = 352
integer height = 92
integer taborder = 30
integer textsize = -9
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Agregar"
end type

event clicked;string v_tipoplanilla, v_tipoproceso
long v_i, ll_fila,v_fila

v_tipoplanilla = dw_tipoplanilla.object.tipoplanilla[dw_tipoplanilla.getrow()]


for v_i = 1 to dw_tipoproceso2.rowcount( )
	
v_fila=0
	
	dw_tipoproceso2.scrolltorow( v_i )	
	v_tipoproceso = dw_tipoproceso2.object.codigo[ dw_tipoproceso2.getrow() ] 	
	
	
	
//	v_fila = dw_planillaproceso.find( "tipoplanilla = '" + v_tipoplanilla  + "' and tipoproceso='" + v_tipoproceso + "'" ,1,dw_planillaproceso.rowcount() )		
	
v_fila = dw_planillaproceso.find( "tipoplanilla = '" + v_tipoplanilla  + "' and tipoproceso='" + v_tipoproceso + "'" ,1,dw_planillaproceso.rowcount() )			
	
	
if  dw_tipoproceso2.object.activo[ dw_tipoproceso2.getrow()] = "1" and v_fila = 0  then
	//if  dw_tipoproceso2.object.activo[ dw_tipoproceso2.getrow()] = "1"  then
			
		
		
		
		
		
			dw_planillaproceso.insertrow(dw_planillaproceso.scrolltorow(0))	
			dw_planillaproceso.object.codigousuario[ dw_planillaproceso.getrow() ] = v_usuario
			dw_planillaproceso.object.tipoplanilla[ dw_planillaproceso.getrow() ] = v_tipoplanilla
			dw_planillaproceso.object.tipoproceso[ dw_planillaproceso.getrow() ] = v_tipoproceso			
		
	end if	

	
	
next	



dw_tipoproceso2.scrolltorow( 1 )	
dw_tipoplanilla.scrolltorow( 1 )	
string  xi
	xi=  "0" 
for v_i = 1 to dw_tipoproceso2.rowcount( )	
  dw_tipoproceso2.scrolltorow( v_i )		
  dw_tipoproceso2.object.activo[ v_i  ] = xi 	
next
dw_tipoproceso2.scrolltorow( 1 )

dw_planillaproceso.accepttext( )










end event

type dw_tipoplanilla from datawindow within w_sy_usuario_proceso
integer x = 46
integer y = 236
integer width = 1522
integer height = 756
integer taborder = 30
string title = "none"
string dataobject = "dw_usuario_proceso_tplan"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
retrieve()
end event

event rowfocuschanged;selectrow(0,false)
selectrow(currentrow,true)
end event

event clicked;String ls_old_sort, ls_column 
Char lc_sort 
IF Right(dwo.Name,2) = '_t' THEN 
	ls_column = LEFT(dwo.Name, LEN(String(dwo.Name)) - 2) 
	ls_old_sort = Describe("Datawindow.Table.sort") 
	IF ls_column = LEFT(ls_old_sort, LEN(ls_old_sort) - 2) THEN 
		lc_sort = RIGHT(ls_old_sort, 1)  
		IF lc_sort = 'A' THEN 
			lc_sort = 'D' 
			ELSE 
			lc_sort = 'A' 
		END IF 
		SetSort(ls_column+" "+lc_sort) 
	ELSE 
		SetSort(ls_column+" A") 
	END IF 
	Sort() 
END IF
end event

type cb_2 from commandbutton within w_sy_usuario_proceso
integer x = 2720
integer y = 40
integer width = 352
integer height = 92
integer taborder = 20
integer textsize = -9
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Cancelar"
end type

event clicked;close(parent)
end event

type cb_1 from commandbutton within w_sy_usuario_proceso
integer x = 2354
integer y = 40
integer width = 352
integer height = 92
integer taborder = 10
integer textsize = -9
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Completar"
end type

event clicked;//	IF (dw_planillaproceso.ModifiedCount () > 0) OR (dw_planillaproceso.DeletedCount () > 0) THEN 
			CHOOSE CASE MessageBox ('Aviso', 'Hay cambios realizados sin guardar. ' + char (13) + '¿Desea guardar ahora?', Question!, YesNoCancel!) 
				CASE 1 
					IF (dw_planillaproceso.Update () = 1) THEN 
						commit;
						MessageBox ('Aviso', 'Se guardo con exito') 
					ELSE 
						rollback;
						MessageBox ('Aviso', 'Ocurrio un error al guardar') 
					END IF 
				CASE 2 
					// aplicar sql almacenado
				CASE 3 
			END CHOOSE 
//		END IF 		
end event

type dw_planillaproceso from datawindow within w_sy_usuario_proceso
integer x = 46
integer y = 1352
integer width = 3049
integer height = 1072
integer taborder = 10
string title = "none"
string dataobject = "dw_usuario_proceso"
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event rowfocuschanged;selectrow(0,false)
selectrow(currentrow,true)
end event

event clicked;String ls_old_sort, ls_column 
Char lc_sort 
IF Right(dwo.Name,2) = '_t' THEN 
	ls_column = LEFT(dwo.Name, LEN(String(dwo.Name)) - 2) 
	ls_old_sort = Describe("Datawindow.Table.sort") 
	IF ls_column = LEFT(ls_old_sort, LEN(ls_old_sort) - 2) THEN 
		lc_sort = RIGHT(ls_old_sort, 1)  
		IF lc_sort = 'A' THEN 
			lc_sort = 'D' 
			ELSE 
			lc_sort = 'A' 
		END IF 
		SetSort(ls_column+" "+lc_sort) 
	ELSE 
		SetSort(ls_column+" A") 
	END IF 
	Sort() 
END IF
end event

event constructor;//settransobject(sqlca)
end event

event dberror;//messagebox('Error','Error existe registros iguales')
return -1
end event

type dw_tipoproceso from datawindow within w_sy_usuario_proceso
boolean visible = false
integer x = 2766
integer y = 300
integer width = 1353
integer height = 696
integer taborder = 40
boolean bringtotop = true
boolean titlebar = true
string title = "none"
string dataobject = "dw_usuario_proceso_tproc"
boolean controlmenu = true
boolean minbox = true
boolean maxbox = true
boolean hscrollbar = true
boolean vscrollbar = true
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

event constructor;settransobject(sqlca)
retrieve()
end event

