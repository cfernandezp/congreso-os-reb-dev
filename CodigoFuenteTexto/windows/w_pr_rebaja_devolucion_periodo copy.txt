forward
global type w_pr_rebaja_devolucion_periodo from w_master_list
end type
type cb_cerrar_periodo from u_cb within w_pr_rebaja_devolucion_periodo
end type
end forward

global type w_pr_rebaja_devolucion_periodo from w_master_list
integer width = 2779
integer height = 1424
string title = "Peiodo rebaja y devoluciones"
windowtype windowtype = child!
cb_cerrar_periodo cb_cerrar_periodo
end type
global w_pr_rebaja_devolucion_periodo w_pr_rebaja_devolucion_periodo

forward prototypes
public subroutine wf_cerrar_periodo ()
public subroutine wf_position ()
end prototypes

public subroutine wf_cerrar_periodo ();
/*==================================================================
Función: wf_cerrar_periodo
Propósito: Cerrar un período de rebajas y devoluciones
==================================================================*/
long ll_row
integer li_result
string ls_periodo, ls_estado
datetime ldt_ahora

ll_row = dw_2.GetRow()

IF ll_row <= 0 THEN
    MessageBox("Advertencia", "Debe seleccionar un período", Exclamation!)
    RETURN
END IF

ls_periodo = dw_2.GetItemString(ll_row, "periodo")
ls_estado = dw_2.GetItemString(ll_row, "estado")

IF ls_estado <> "PROCESO" THEN
    MessageBox("Advertencia", "El período " + ls_periodo + " ya está cerrado", StopSign!)
    RETURN
END IF

IF MessageBox("Confirmación", &
    "¿Está seguro de cerrar el período " + ls_periodo + "?~r~n~r~n" + &
    "Esta acción no se puede deshacer.", &
    Question!, YesNo!) <> 1 THEN
    RETURN
END IF

ldt_ahora = DateTime(Today(), Now())

// Actualizar estado y fecha de cierre
dw_2.SetItem(ll_row, "estado", "CERRADO")
dw_2.SetItem(ll_row, "fecha_cierre", ldt_ahora)

// Guardar en base de datos
li_result = dw_2.Update()

IF li_result = 1 THEN
    COMMIT;
    MessageBox("Información", "Período " + ls_periodo + " cerrado exitosamente", Information!)
    dw_2.Retrieve()
ELSE
    ROLLBACK;
    MessageBox("Error", "No se pudo cerrar el período:~r~n" + SQLCA.SQLErrText, StopSign!)
END IF

end subroutine

public subroutine wf_position ();
/*==================================================================
Función: wf_position
Propósito: Buscar un período específico en el DataWindow
==================================================================*/
string ls_buscar
long ll_row

// Obtener el texto del campo de búsqueda
ls_buscar = Trim(Upper(sle_position.Text))

IF Len(ls_buscar) = 0 THEN
    MessageBox("Información", "Ingrese un período para buscar~r~nFormato: YYYY-MM (ej: 2024-08)", Information!)
    sle_position.SetFocus()
    RETURN
END IF

// Buscar el período en el DataWindow
ll_row = dw_2.Find("periodo = '" + ls_buscar + "'", 1, dw_2.RowCount())

IF ll_row > 0 THEN
    // Encontrado: posicionarse y seleccionar la fila
    dw_2.ScrollToRow(ll_row)
    dw_2.SelectRow(0, FALSE)
    dw_2.SelectRow(ll_row, TRUE)
    dw_2.SetRow(ll_row)
    dw_2.SetColumn("periodo")
    dw_2.SetFocus()
    
    // Actualizar variable de posición (por compatibilidad con w_master_list)
    iv_position = ls_buscar
ELSE
    // No encontrado
    MessageBox("Búsqueda", "No se encontró el período: " + ls_buscar, Information!)
    sle_position.SetFocus()
    sle_position.SelectText(1, Len(sle_position.Text))
END IF

end subroutine

on w_pr_rebaja_devolucion_periodo.create
int iCurrent
call super::create
this.cb_cerrar_periodo=create cb_cerrar_periodo
iCurrent=UpperBound(this.Control)
this.Control[iCurrent+1]=this.cb_cerrar_periodo
end on

on w_pr_rebaja_devolucion_periodo.destroy
call super::destroy
destroy(this.cb_cerrar_periodo)
end on

event open;
call super::open

// Ocultar botones que no se necesitan
cb_nuevo.Visible = FALSE
cb_modificar.Visible = FALSE
cb_eliminar.Visible = FALSE

// Asignar transacción al DataWindow
dw_2.SetTransObject(SQLCA)

// Cargar datos
dw_2.Retrieve()

// Limpiar campo de búsqueda
sle_position.Text = ""

end event

event objectstartevent;
call super::objectstartevent

Choose Case eventname
    // Cerrar período
    Case "cb_cerrar_periodo_clicked"
        wf_cerrar_periodo()
    
    // Cerrar ventana
    Case "ue_close"
        Close(This)

End Choose

end event

type dw_3 from w_master_list`dw_3 within w_pr_rebaja_devolucion_periodo
end type

type dw_report from w_master_list`dw_report within w_pr_rebaja_devolucion_periodo
end type

type dw_2 from w_master_list`dw_2 within w_pr_rebaja_devolucion_periodo
integer x = 41
integer y = 144
integer width = 2610
string dataobject = "dw_periodo_rebaja_devolucion"
end type

event dw_2::rowfocuschanged;
call super::rowfocuschanged

// Habilitar/deshabilitar botón según el estado del período
long ll_row
string ls_estado

ll_row = this.GetRow()

IF ll_row > 0 THEN
    ls_estado = this.GetItemString(ll_row, "estado")
    
    // Solo habilitar botón si está en PROCESO
    cb_cerrar_periodo.Enabled = (ls_estado = "PROCESO")
ELSE
    cb_cerrar_periodo.Enabled = FALSE
END IF

end event

type st_1 from w_master_list`st_1 within w_pr_rebaja_devolucion_periodo
end type

type sle_position from w_master_list`sle_position within w_pr_rebaja_devolucion_periodo
end type

event sle_position::losefocus;
call super::losefocus

// Buscar cuando pierde el foco y hay texto
IF Len(Trim(This.Text)) > 0 THEN
    Parent.wf_position()
END IF

end event

event sle_position::modified;
// Limpiar selección si el campo está vacío
IF Len(Trim(This.Text)) = 0 THEN
    dw_2.SelectRow(0, FALSE)
END IF

end event

type cb_hide from w_master_list`cb_hide within w_pr_rebaja_devolucion_periodo
end type

type cb_nuevo from w_master_list`cb_nuevo within w_pr_rebaja_devolucion_periodo
boolean visible = false
integer height = 84
end type

type cb_modificar from w_master_list`cb_modificar within w_pr_rebaja_devolucion_periodo
boolean visible = false
integer height = 84
end type

type cb_eliminar from w_master_list`cb_eliminar within w_pr_rebaja_devolucion_periodo
boolean visible = false
integer height = 84
end type

type cb_cerrar_periodo from u_cb within w_pr_rebaja_devolucion_periodo
integer x = 1897
integer y = 28
integer width = 407
integer height = 84
integer taborder = 21
integer weight = 400
string text = "&Cerrar Período"
end type

